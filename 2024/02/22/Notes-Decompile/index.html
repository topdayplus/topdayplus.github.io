<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"topdayplus.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Notes">
<meta property="og:type" content="article">
<meta property="og:title" content="Notes-Decompile">
<meta property="og:url" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/index.html">
<meta property="og:site_name" content="Topday&#39;s Blog">
<meta property="og:description" content="Notes">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/00.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/00-1.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/00-2.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/01.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/02.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/03.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/04.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/05.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/06.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/07.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/26.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/22.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/08.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/09.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/10.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/11.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/12.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/13.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/14.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/15.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/16.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/22.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/17.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/18.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/21.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/19.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/23.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/24.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/20.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/25.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/27.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/28.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/29.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/30.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/31.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/32.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/33.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/40.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/34.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/35.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/36.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/37.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/38.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/39.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/43.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/44.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/45.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/46.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/47.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/50.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/48.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/49.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/52.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/53.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/54.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/51.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/55.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/56.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/57.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/58.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/59.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/60.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/61.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/62.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/63.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/64.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/65.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/Portable_Executable_32_bit_Structure_in_SVG_fixed.svg">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/66.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/67.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/68.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/69.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/70.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/75.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/71.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/72.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/73.png">
<meta property="og:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/74.png">
<meta property="article:published_time" content="2024-02-22T13:48:27.000Z">
<meta property="article:modified_time" content="2024-07-02T16:03:05.117Z">
<meta property="article:author" content="Topday">
<meta property="article:tag" content="汇编">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://topdayplus.github.io/2024/02/22/Notes-Decompile/00.png">


<link rel="canonical" href="http://topdayplus.github.io/2024/02/22/Notes-Decompile/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://topdayplus.github.io/2024/02/22/Notes-Decompile/","path":"2024/02/22/Notes-Decompile/","title":"Notes-Decompile"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Notes-Decompile | Topday's Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Topday's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#DOS%E6%A8%A1%E6%8B%9F%E5%99%A8"><span class="nav-number">1.</span> <span class="nav-text">DOS模拟器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#DOSbox"><span class="nav-number">1.1.</span> <span class="nav-text">DOSbox</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#msdosplayer"><span class="nav-number">1.1.1.</span> <span class="nav-text">msdosplayer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VS%E6%8F%92%E4%BB%B6-MASM-x2F-TASM"><span class="nav-number">1.1.2.</span> <span class="nav-text">VS插件-MASM&#x2F;TASM</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#16ASM%E6%B1%87%E7%BC%96"><span class="nav-number">2.</span> <span class="nav-text">16ASM汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%8F%8D%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4"><span class="nav-number">2.1.</span> <span class="nav-text">常见反汇编指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%9C%B0%E5%9D%80%E6%B1%87%E7%BC%96-u"><span class="nav-number">2.1.1.</span> <span class="nav-text">查看地址汇编-u</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4-a"><span class="nav-number">2.1.2.</span> <span class="nav-text">执行汇编指令-a</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E6%93%8D%E4%BD%9C-r"><span class="nav-number">2.1.3.</span> <span class="nav-text">寄存器操作-r</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%9F%A5%E7%9C%8B-d"><span class="nav-number">2.1.4.</span> <span class="nav-text">内存查看-d</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%86%85%E5%AD%98-e"><span class="nav-number">2.1.5.</span> <span class="nav-text">修改内存-e</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4-g-t-p"><span class="nav-number">2.1.6.</span> <span class="nav-text">调试命令(g,t,p)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6%EF%BC%88n-cx-w%EF%BC%89"><span class="nav-number">2.1.7.</span> <span class="nav-text">写入文件（n,cx,w）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%87%E5%BF%97%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">2.2.</span> <span class="nav-text">标志寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CF%E8%BF%9B%E4%BD%8D%E6%A0%87%E5%BF%97"><span class="nav-number">2.2.1.</span> <span class="nav-text">CF进位标志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZF%E9%9B%B6%E6%A0%87%E5%BF%97"><span class="nav-number">2.2.2.</span> <span class="nav-text">ZF零标志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OF%E6%BA%A2%E5%87%BA%E6%A0%87%E5%BF%97"><span class="nav-number">2.2.3.</span> <span class="nav-text">OF溢出标志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SF%E7%AC%A6%E5%8F%B7%E6%A0%87%E5%BF%97"><span class="nav-number">2.2.4.</span> <span class="nav-text">SF符号标志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PF%E5%A5%87%E5%81%B6%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="nav-number">2.2.5.</span> <span class="nav-text">PF奇偶标志位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AF%E8%BE%85%E5%8A%A9%E8%BF%9B%E4%BD%8D%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="nav-number">2.2.6.</span> <span class="nav-text">AF辅助进位标志位</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%AE%B5%E5%92%8C%E6%8C%87%E4%BB%A4"><span class="nav-number">2.3.</span> <span class="nav-text">分段和指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%8B%E5%8D%B3%E5%AF%BB%E5%9D%80"><span class="nav-number">2.3.1.</span> <span class="nav-text">立即寻址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E5%AF%BB%E5%9D%80"><span class="nav-number">2.3.2.</span> <span class="nav-text">寄存器寻址</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%AF%BB%E5%9D%80"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">直接寻址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%B4%E6%8E%A5%E5%AF%BB%E5%9D%80"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">间接寻址</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B8%E5%AF%B9%E5%AF%BB%E5%9D%80"><span class="nav-number">2.3.2.2.1.</span> <span class="nav-text">相对寻址</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E5%9D%80%E5%8F%98%E5%9D%80%E5%AF%BB%E5%9D%80"><span class="nav-number">2.3.2.2.2.</span> <span class="nav-text">基址变址寻址</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E5%9D%80%E5%8F%98%E5%9D%80%E7%9B%B8%E5%AF%B9%E5%AF%BB%E5%9D%80"><span class="nav-number">2.3.2.2.3.</span> <span class="nav-text">基址变址相对寻址</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E6%9C%BA%E5%99%A8%E7%A0%81"><span class="nav-number">2.3.3.</span> <span class="nav-text">关于机器码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%81%E5%92%8C%E7%AE%97%E6%9C%AF%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.</span> <span class="nav-text">数据传送和算术指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MOV%E4%BC%A0%E9%80%81%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.1.</span> <span class="nav-text">MOV传送指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XCHG%E4%BA%A4%E6%8D%A2%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.2.</span> <span class="nav-text">XCHG交换指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XLAT%E6%8D%A2%E7%A0%81%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.3.</span> <span class="nav-text">XLAT换码指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#push%E3%80%81pop%E5%A0%86%E6%A0%88%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.4.</span> <span class="nav-text">push、pop堆栈操作指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PUSHF%E3%80%81POPF%E6%A0%87%E5%BF%97%E8%BF%9B%E5%87%BA%E6%A0%88%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.5.</span> <span class="nav-text">PUSHF、POPF标志进出栈指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LEA%E5%9C%B0%E5%9D%80%E4%BC%A0%E9%80%81%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.6.</span> <span class="nav-text">LEA地址传送指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%97%E6%95%B0%E8%BF%90%E7%AE%97%E7%B1%BB%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.7.</span> <span class="nav-text">算数运算类指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E6%B3%95%EF%BC%88ADD-ADC-INC%EF%BC%89"><span class="nav-number">2.4.7.1.</span> <span class="nav-text">加法（ADD|ADC|INC）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%8F%E6%B3%95%EF%BC%88SUB-SBB-DEC%EF%BC%89"><span class="nav-number">2.4.7.2.</span> <span class="nav-text">减法（SUB|SBB|DEC）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%82%E8%A1%A5%EF%BC%88NEG%EF%BC%89"><span class="nav-number">2.4.7.3.</span> <span class="nav-text">求补（NEG）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AF%94%E8%BE%83%EF%BC%88CMP%EF%BC%89"><span class="nav-number">2.4.7.4.</span> <span class="nav-text">比较（CMP）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B9%98%E6%B3%95%EF%BC%88MUL-x2F-IMUL%EF%BC%89"><span class="nav-number">2.4.7.5.</span> <span class="nav-text">乘法（MUL&#x2F;IMUL）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%A0%E7%AC%A6%E5%8F%B7%E4%B9%98%E6%B3%95"><span class="nav-number">2.4.7.5.1.</span> <span class="nav-text">无符号乘法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%89%E7%AC%A6%E5%8F%B7%E4%B9%98%E6%B3%95"><span class="nav-number">2.4.7.5.2.</span> <span class="nav-text">有符号乘法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%A4%E6%B3%95%EF%BC%88DIV-x2F-IDIV%EF%BC%89"><span class="nav-number">2.4.7.6.</span> <span class="nav-text">除法（DIV&#x2F;IDIV）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%A0%E7%AC%A6%E5%8F%B7%E9%99%A4%E6%B3%95"><span class="nav-number">2.4.7.6.1.</span> <span class="nav-text">无符号除法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%89%E7%AC%A6%E5%8F%B7%E6%95%B0%E9%99%A4%E6%B3%95"><span class="nav-number">2.4.7.6.2.</span> <span class="nav-text">有符号数除法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A9%E5%B1%95%E6%8C%87%E4%BB%A4%EF%BC%88CBW-x2F-CWD%EF%BC%89"><span class="nav-number">2.4.7.7.</span> <span class="nav-text">符号扩展指令（CBW&#x2F;CWD）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97"><span class="nav-number">2.4.7.8.</span> <span class="nav-text">逻辑运算</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E4%B8%8E%EF%BC%9AAND"><span class="nav-number">2.4.7.8.1.</span> <span class="nav-text">逻辑与：AND</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%88%96%EF%BC%9AOR"><span class="nav-number">2.4.7.8.2.</span> <span class="nav-text">逻辑或：OR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E9%9D%9E%EF%BC%9ANOT"><span class="nav-number">2.4.7.8.3.</span> <span class="nav-text">逻辑非：NOT</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E6%88%96%EF%BC%9AXOR"><span class="nav-number">2.4.7.8.4.</span> <span class="nav-text">异或：XOR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TEST-%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.7.8.5.</span> <span class="nav-text">TEST 指令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.4.7.9.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%81%92%E7%AD%89%E5%BC%8F"><span class="nav-number">2.4.7.10.</span> <span class="nav-text">逻辑恒等式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A0%E5%88%86%E6%94%AF%E6%B1%82%E7%BB%9D%E5%AF%B9%E5%80%BC"><span class="nav-number">2.4.7.11.</span> <span class="nav-text">无分支求绝对值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A0%E5%88%86%E6%94%AF%E6%B1%82%E4%B8%89%E7%9B%AE%E8%BF%90%E7%AE%97"><span class="nav-number">2.4.7.12.</span> <span class="nav-text">无分支求三目运算</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%BB%E4%BD%8D%E6%8C%87%E4%BB%A4"><span class="nav-number">2.4.7.13.</span> <span class="nav-text">移位指令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E7%A7%BB%E4%BD%8D-amp-%E7%AE%97%E6%95%B0%E7%A7%BB%E4%BD%8D"><span class="nav-number">2.4.7.13.1.</span> <span class="nav-text">逻辑移位&amp;算数移位</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E7%A7%BB%E4%BD%8D"><span class="nav-number">2.4.7.13.2.</span> <span class="nav-text">循环移位</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ASM%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="nav-number">2.5.</span> <span class="nav-text">ASM基础语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AE%B5"><span class="nav-number">2.5.1.</span> <span class="nav-text">段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E5%80%BC"><span class="nav-number">2.5.2.</span> <span class="nav-text">数值</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E6%95%B0"><span class="nav-number">2.5.2.1.</span> <span class="nav-text">整数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6"><span class="nav-number">2.5.2.2.</span> <span class="nav-text">字符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%98%E9%87%8F"><span class="nav-number">2.5.2.3.</span> <span class="nav-text">变量</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B4%E6%95%B0-1"><span class="nav-number">2.5.2.3.1.</span> <span class="nav-text">整数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">2.5.2.3.2.</span> <span class="nav-text">字符串</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E7%BB%84"><span class="nav-number">2.5.2.3.3.</span> <span class="nav-text">数组</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7"><span class="nav-number">2.5.2.3.4.</span> <span class="nav-text">属性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A0%86%E6%A0%88"><span class="nav-number">2.5.2.3.5.</span> <span class="nav-text">堆栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD"><span class="nav-number">2.5.2.3.6.</span> <span class="nav-text">中断</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%B2%E6%93%8D%E4%BD%9C"><span class="nav-number">2.5.3.</span> <span class="nav-text">串操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#movsb-amp-movsw"><span class="nav-number">2.5.3.1.</span> <span class="nav-text">movsb &amp; movsw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#stosb-amp-stosw"><span class="nav-number">2.5.3.2.</span> <span class="nav-text">stosb &amp; stosw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%A4%8D%E5%89%8D%E7%BC%80"><span class="nav-number">2.5.3.3.</span> <span class="nav-text">重复前缀</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E8%BD%AC%E7%A7%BB%E6%8C%87%E4%BB%A4"><span class="nav-number">2.5.4.</span> <span class="nav-text">流程转移指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A0%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC"><span class="nav-number">2.5.4.1.</span> <span class="nav-text">无条件跳转</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E8%B7%B3%E8%BD%AC"><span class="nav-number">2.5.4.1.1.</span> <span class="nav-text">直接跳转</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%A0%E6%8C%87%E4%BB%A4%E8%B7%B3%E8%BD%AC"><span class="nav-number">2.5.4.1.2.</span> <span class="nav-text">无指令跳转</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC"><span class="nav-number">2.5.4.2.</span> <span class="nav-text">条件跳转</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8D%95%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC"><span class="nav-number">2.5.4.2.1.</span> <span class="nav-text">单条件跳转</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%A0%E7%AC%A6%E5%8F%B7%E6%95%B0%E5%88%A4%E6%96%AD"><span class="nav-number">2.5.4.2.2.</span> <span class="nav-text">无符号数判断</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%89%E7%AC%A6%E5%8F%B7%E6%95%B0%E5%88%A4%E6%96%AD"><span class="nav-number">2.5.4.2.3.</span> <span class="nav-text">有符号数判断</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LOOP"><span class="nav-number">2.5.4.3.</span> <span class="nav-text">LOOP</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-number">2.5.5.</span> <span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="nav-number">2.5.5.1.</span> <span class="nav-text">基础语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#masm%E5%87%BD%E6%95%B0%E8%AF%AD%E6%B3%95"><span class="nav-number">2.5.5.2.</span> <span class="nav-text">masm函数语法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#invoke"><span class="nav-number">2.5.5.2.1.</span> <span class="nav-text">invoke</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%BC%95%E7%94%A8"><span class="nav-number">2.5.5.3.</span> <span class="nav-text">文件引用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8F%E6%B1%87%E7%BC%96"><span class="nav-number">2.5.5.4.</span> <span class="nav-text">宏汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F-org"><span class="nav-number">2.5.5.4.1.</span> <span class="nav-text">表达式  $  org  @@</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">2.5.5.4.2.</span> <span class="nav-text">结构体</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%8F"><span class="nav-number">2.5.5.4.3.</span> <span class="nav-text">宏</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#equ%E8%AF%AD%E5%8F%A5"><span class="nav-number">2.5.5.4.3.1.</span> <span class="nav-text">equ语句</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#x3D-%E5%8F%AA%E8%83%BD%E6%95%B4%E6%95%B0%E7%9A%84equ"><span class="nav-number">2.5.5.4.3.2.</span> <span class="nav-text">&#x3D;(只能整数的equ)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#macro%E8%AF%AD%E5%8F%A5"><span class="nav-number">2.5.5.4.3.3.</span> <span class="nav-text">macro语句</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E5%85%85"><span class="nav-number">2.5.6.</span> <span class="nav-text">补充</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#32ASM%E6%B1%87%E7%BC%96"><span class="nav-number">3.</span> <span class="nav-text">32ASM汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8E16%E4%BD%8DASM%E5%8C%BA%E5%88%AB"><span class="nav-number">3.1.</span> <span class="nav-text">与16位ASM区别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%AE%B5"><span class="nav-number">3.1.1.</span> <span class="nav-text">分段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BB%E5%9D%80"><span class="nav-number">3.1.2.</span> <span class="nav-text">寻址</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OD%E7%9A%84%E7%AE%80%E6%98%93%E4%BD%BF%E7%94%A8"><span class="nav-number">3.2.</span> <span class="nav-text">OD的简易使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E5%92%8C%E8%81%94%E5%90%88%E7%BC%96%E8%AF%91"><span class="nav-number">3.3.</span> <span class="nav-text">资源和联合编译</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#C-amp-%E6%B1%87%E7%BC%96%E7%9A%84%E7%9B%B8%E4%BA%92%E8%B0%83%E7%94%A8"><span class="nav-number">3.3.1.</span> <span class="nav-text">C &amp; 汇编的相互调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96%EF%BC%88c-x2F-c-%E5%86%99%E6%B1%87%E7%BC%96%EF%BC%89"><span class="nav-number">3.3.2.</span> <span class="nav-text">内联汇编（c&#x2F;c++写汇编）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A5%E4%B8%81"><span class="nav-number">3.4.</span> <span class="nav-text">补丁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D"><span class="nav-number">3.5.</span> <span class="nav-text">重定位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API-hock"><span class="nav-number">3.6.</span> <span class="nav-text">API hock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%92%A2%E7%90%B4%E5%92%8C%E7%AD%9B%E9%80%89%E5%99%A8%E5%BC%82%E5%B8%B8"><span class="nav-number">3.7.</span> <span class="nav-text">钢琴和筛选器异常</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">3.8.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#windbg"><span class="nav-number">3.9.</span> <span class="nav-text">windbg</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OD%E6%8F%92%E4%BB%B6"><span class="nav-number">3.10.</span> <span class="nav-text">OD插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%8F%92%E4%BB%B6"><span class="nav-number">3.10.1.</span> <span class="nav-text">异常处理插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E8%B7%9F%E8%B8%AA%E5%9C%B0%E5%9D%80%E9%94%99%E8%AF%AF"><span class="nav-number">3.10.2.</span> <span class="nav-text">进程跟踪地址错误</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E6%A1%86%E6%9E%B6"><span class="nav-number">3.11.</span> <span class="nav-text">调试框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PE"><span class="nav-number">3.12.</span> <span class="nav-text">PE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2"><span class="nav-number">3.12.1.</span> <span class="nav-text">地址转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dump%E6%96%87%E4%BB%B6%E7%9A%84%E7%BC%96%E5%86%99"><span class="nav-number">3.12.2.</span> <span class="nav-text">dump文件的编写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E8%A1%A8%E6%B3%A8%E5%85%A5"><span class="nav-number">3.12.3.</span> <span class="nav-text">节表注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E8%A1%A8"><span class="nav-number">3.12.4.</span> <span class="nav-text">导入表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%87%BA%E8%A1%A8"><span class="nav-number">3.12.5.</span> <span class="nav-text">导出表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E5%9C%B0%E9%87%8D%E5%AE%9A%E5%90%91%E8%A1%A8"><span class="nav-number">3.12.6.</span> <span class="nav-text">基地重定向表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TLS%E8%A1%A8"><span class="nav-number">3.12.7.</span> <span class="nav-text">TLS表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E8%A1%A8"><span class="nav-number">3.12.8.</span> <span class="nav-text">资源表</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Topday"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Topday</p>
  <div class="site-description" itemprop="description">For me, it has not yet been realized what the rest of one’s life, is my greatest encouragement.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/topdayplus" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;topdayplus" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://topdayplus.github.io/2024/02/22/Notes-Decompile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Topday">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Topday's Blog">
      <meta itemprop="description" content="For me, it has not yet been realized what the rest of one’s life, is my greatest encouragement.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Notes-Decompile | Topday's Blog">
      <meta itemprop="description" content="Notes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Notes-Decompile
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
  
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-22 21:48:27" itemprop="dateCreated datePublished" datetime="2024-02-22T21:48:27+08:00">2024-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-03 00:03:05" itemprop="dateModified" datetime="2024-07-03T00:03:05+08:00">2024-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/x%E9%98%9F/" itemprop="url" rel="index"><span itemprop="name">x队</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>65k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>59 分钟</span>
    </span>
</div>

            <div class="post-description">Notes</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="DOS模拟器"><a href="#DOS模拟器" class="headerlink" title="DOS模拟器"></a>DOS模拟器</h1><h2 id="DOSbox"><a href="#DOSbox" class="headerlink" title="DOSbox"></a>DOSbox</h2><p>挂载主机文件夹</p>
<p>开机自动配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mount c C:\Users\admin\Desktop\tool\debug</span><br><span class="line">mount d C:\Users\admin\Desktop\binary\16asm</span><br><span class="line">set path=c:</span><br><span class="line">d:</span><br></pre></td></tr></table></figure>

<h3 id="msdosplayer"><a href="#msdosplayer" class="headerlink" title="msdosplayer"></a>msdosplayer</h3><h3 id="VS插件-MASM-x2F-TASM"><a href="#VS插件-MASM-x2F-TASM" class="headerlink" title="VS插件-MASM&#x2F;TASM"></a>VS插件-MASM&#x2F;TASM</h3><h1 id="16ASM汇编"><a href="#16ASM汇编" class="headerlink" title="16ASM汇编"></a>16ASM汇编</h1><p>8086cpu组织结构——寄存器（cpu的“局部变量”）</p>
<img src="/2024/02/22/Notes-Decompile/00.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/00-1.png" class title="This is an example image">



<p>•EU部件：执行部件（excution unit）、译码、执行指令</p>
<p>•BIU部件：总线接口部件（bus interface unit）、取指令、读取数据、写入数据</p>
<img src="/2024/02/22/Notes-Decompile/00-2.png" class title="This is an example image">

<h2 id="常见反汇编指令"><a href="#常见反汇编指令" class="headerlink" title="常见反汇编指令"></a>常见反汇编指令</h2><h3 id="查看地址汇编-u"><a href="#查看地址汇编-u" class="headerlink" title="查看地址汇编-u"></a>查看地址汇编-u</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-u[range]</span><br><span class="line">-u 11c 120  <span class="comment">#[range] = [startaddr][endaddr]</span></span><br><span class="line">-u 11c l 2  <span class="comment">#从11c地址开始，(list)打印两个字节的存储地址 [startaddr l num]</span></span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/01.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/02.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/03.png" class title="This is an example image">

<h3 id="执行汇编指令-a"><a href="#执行汇编指令-a" class="headerlink" title="执行汇编指令-a"></a>执行汇编指令-a</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-a[address] </span><br><span class="line">-a 110</span><br><span class="line">mov ax, ax</span><br><span class="line">mov dx, dx</span><br><span class="line">mov ax, dx</span><br><span class="line">mov byte ptr [110],al</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/04.png" class title="This is an example image">

<h3 id="寄存器操作-r"><a href="#寄存器操作-r" class="headerlink" title="寄存器操作-r"></a>寄存器操作-r</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-r</span><br><span class="line">-r eax</span><br><span class="line">:ff00</span><br><span class="line">-r</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/05.png" class title="This is an example image">

<h3 id="内存查看-d"><a href="#内存查看-d" class="headerlink" title="内存查看-d"></a>内存查看-d</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-d[range]</span><br><span class="line">-d 120 130</span><br><span class="line">-d 120 l 10</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/06.png" class title="This is an example image">

<h3 id="修改内存-e"><a href="#修改内存-e" class="headerlink" title="修改内存-e"></a>修改内存-e</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-e 110</span><br><span class="line">-e 120 11,12,13,14,15,16 17 18 19 20</span><br><span class="line">-e 120 <span class="string">&quot;Hello world&quot;</span></span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/07.png" class title="This is an example image">

<h3 id="调试命令-g-t-p"><a href="#调试命令-g-t-p" class="headerlink" title="调试命令(g,t,p)"></a>调试命令(g,t,p)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">g - F5</span><br><span class="line">t - F11</span><br><span class="line">p - F10</span><br></pre></td></tr></table></figure>

<h3 id="写入文件（n-cx-w）"><a href="#写入文件（n-cx-w）" class="headerlink" title="写入文件（n,cx,w）"></a>写入文件（n,cx,w）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e addr &quot;字符串&quot;</span><br></pre></td></tr></table></figure>



<h2 id="标志寄存器"><a href="#标志寄存器" class="headerlink" title="标志寄存器"></a>标志寄存器</h2><img src="/2024/02/22/Notes-Decompile/26.png" class title="This is an example image">

<ol>
<li>条件标志位<br>SF  ZF  OF  CF  AF  PF<br>CPU执行完一条指令后自动设置。<br>反映算术、逻辑运算等指令执行完毕后，运算结果的特征。</li>
<li>控制标志位<br>DF  IF  TF<br>控制CPU的运行方式，工作状态。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OF DF IF SF ZF AF PF CF</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/22.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">溢出OV（overflow，OF＝1）</span><br><span class="line">无溢出NV（no overflow，OF＝0）</span><br><span class="line"></span><br><span class="line">减量DN（direction down，DF＝1）</span><br><span class="line">增量UP（direction up，DF＝0）</span><br><span class="line"></span><br><span class="line">允许中断EI（enable interrupt，IF＝1）</span><br><span class="line">进制中断DI（disable interrupt，IF＝0）</span><br><span class="line"></span><br><span class="line">负NG（negative，SF＝1）</span><br><span class="line">正PL（plus，SF＝0）</span><br><span class="line"></span><br><span class="line">零ZR（zero，ZF＝1）</span><br><span class="line">非零NZ（no zero，ZF＝0）</span><br><span class="line"></span><br><span class="line">辅助进位AC（auxiliary carry，AF＝1）</span><br><span class="line">无辅助进位NA（no auxiliary carry，AF＝0）</span><br><span class="line"></span><br><span class="line">偶校验PE（even parity，PF＝1）</span><br><span class="line">奇校验PO（odd parity，PF＝0）</span><br><span class="line"></span><br><span class="line">进位CY（carry，CF＝1）</span><br><span class="line">无进位NC（no carry，CF＝0）</span><br></pre></td></tr></table></figure>



<h3 id="CF进位标志"><a href="#CF进位标志" class="headerlink" title="CF进位标志"></a>CF进位标志</h3><p>当运算结果的最高有效位有进位（加法）或借位（减法）时设置。</p>
<p>进位标志置1，即CF &#x3D; 1；否则CF &#x3D; 0</p>
<p>用途：用于表示两个无符号数高低。</p>
<p>举例：</p>
<p>3AH + 7CH＝B6H，没有进位：CF &#x3D; 0</p>
<p>AAH + 7CH＝（1）26H，有进位：CF &#x3D; 1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-a <span class="comment">#编写汇编指令</span></span><br><span class="line">mov al, 3a</span><br><span class="line">add al, 7c</span><br><span class="line">-u <span class="comment">#查看当前地址</span></span><br><span class="line">-t <span class="comment">#执行，关注IP</span></span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/08.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/09.png" class title="This is an example image">

<h3 id="ZF零标志"><a href="#ZF零标志" class="headerlink" title="ZF零标志"></a>ZF零标志</h3><p>运算结果为0则ZF&#x3D;1，否则ZF&#x3D;0。表示两个无符号数高低。</p>
<p>用途：用于表示两个无符号数高低。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3AH + 7CH＝B6H，结果不是零：ZF = 0</span><br><span class="line">84H + 7CH＝（1）00H，结果是零：ZF = 1</span><br></pre></td></tr></table></figure>

<h3 id="OF溢出标志"><a href="#OF溢出标志" class="headerlink" title="OF溢出标志"></a>OF溢出标志</h3><p>•使用该标志位判断运算结果是否溢出。（当将操作数作为有符号数时）</p>
<p>–加法：若同符号数相加，结果的符号与之相反则OF&#x3D;1，否则OF置0。</p>
<p>–减法：被减数与减数异号，而结果的符号与减数相同则OF&#x3D;1，否则置0。</p>
<p>•发生了溢出，说明了运算结果不可信。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3AH + 7CH＝B6H，产生溢出：OF = 1</span><br><span class="line">AAH + 7CH＝（1）26H，没有溢出：OF = 0</span><br></pre></td></tr></table></figure>

<p>•进位针对的是无符号数运算，溢出针对的是有符号数运算。</p>
<p>•当看成无符号数，则关注CF标志，看成有符号数，则关注OF标志。</p>
<h3 id="SF符号标志"><a href="#SF符号标志" class="headerlink" title="SF符号标志"></a>SF符号标志</h3><p>•运算结果最高位为1，SF为1，否则为0。</p>
<p>•有符号数据用最高有效位表示数据的符号，最高有效位是符号标志的状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3AH + 7CH＝B6H，最高位D7＝1：SF = 1</span><br><span class="line">84H + 7CH＝（1）00H，最高位D7＝0：SF = 0</span><br></pre></td></tr></table></figure>

<h3 id="PF奇偶标志位"><a href="#PF奇偶标志位" class="headerlink" title="PF奇偶标志位"></a>PF奇偶标志位</h3><p>•当运算结果（指低8位）中1的个数为偶数时，PF置1，否则置0。</p>
<p>•作用：该标志位主要用于检测数据在传输过程中的错误。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3AH + 7CH＝B6H＝10110110B</span><br><span class="line">结果中有5个1，是奇数：PF = 0</span><br></pre></td></tr></table></figure>

<h3 id="AF辅助进位标志位"><a href="#AF辅助进位标志位" class="headerlink" title="AF辅助进位标志位"></a>AF辅助进位标志位</h3><p>•表示一个字节的低4位是否有进位和借位。运算时D3位（低半字节）有进位或借位时，AF &#x3D; 1；否则AF &#x3D; 0。</p>
<p>•处理器内部使用，用于十进制算术运算调整指令中，用户一般不必关心</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3AH + 7CH＝B6H，D3有进位：AF = 1</span><br></pre></td></tr></table></figure>

<h2 id="分段和指令"><a href="#分段和指令" class="headerlink" title="分段和指令"></a>分段和指令</h2><p>8086是16位cpu，最多可访问（寻址）多大内存？ 2^16 &#x3D; 65536 &#x3D; 2^6 * 2^10 &#x3D; 64k</p>
<p>8086允许最大内存1M，1M &#x3D; 10K &#x3D; 2 ^ 20      内存[00000]-[FFFFF]</p>
<p><strong>段基址(CS)</strong> <strong>+</strong> <strong>段偏移</strong> 。的方式一般写作 <strong>段地址：段偏移</strong>，称作<strong>逻辑地址</strong></p>
<p><strong>偏移地址</strong>称作<strong>EA</strong></p>
<p>通过逻辑地址计算出来的内存地址称作<strong>物理地址</strong></p>
<p>逻辑地址 -&gt; 地址加法器 -&gt; 物理地址</p>
<p><strong>内存地址</strong> <strong>&#x3D;</strong> <strong>段基址</strong> *** 10h +** <strong>段偏移</strong></p>
<p>073F:0100 &#x3D; 073 * 10 + 100</p>
<p>8086中，段基址都是存储在段寄存器中，段偏移可以用立即数或者通用寄存器指明。</p>
<img src="/2024/02/22/Notes-Decompile/10.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/11.png" class title="This is an example image">



<h3 id="立即寻址"><a href="#立即寻址" class="headerlink" title="立即寻址"></a>立即寻址</h3><p>操作数的值<strong>存储在指令</strong>中的方式称作立即寻址。</p>
<p>汇编中整数常量称作立即数。</p>
<p>立即数可以是8位数，也可以是16位数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV AL, 80H    ;将8位立即数80H送入AL寄存器</span><br><span class="line">MOV AX, 1234H  ;将16位立即数1234H送入AX寄存器</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/12.png" class title="This is an example image">

<h3 id="寄存器寻址"><a href="#寄存器寻址" class="headerlink" title="寄存器寻址"></a>寄存器寻址</h3><p>操作数的值<strong>存储在寄存器</strong>的寻址方式称作寄存器寻址。</p>
<p>寄存器包括通用寄存器，段寄存器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV CL, DL    </span><br><span class="line">MOV AX, BX</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/13.png" class title="This is an example image">

<p><strong>PS：</strong></p>
<p>段寄存器之间不能赋值。</p>
<p>指令指针寄存器不能用作寻址。</p>
<h4 id="直接寻址"><a href="#直接寻址" class="headerlink" title="直接寻址"></a>直接寻址</h4><p>操作数值在内存中，<strong>机器码中存储16位段内偏移</strong>的寻址方式称作直接寻址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV AL, [1064H]  <span class="comment">#基地址(ds)为2000</span></span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/14.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-r</span><br><span class="line">-r ds</span><br><span class="line">:2000</span><br><span class="line">-r</span><br><span class="line">-e 1064 45 78</span><br><span class="line">-d 1064 l 20</span><br><span class="line">-r</span><br><span class="line">-a xxx</span><br><span class="line">mov ax, [1064]</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/15.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/16.png" class title="This is an example image">

<p><strong>PS:</strong></p>
<p>-r 查看当前寄存器状态，能查看到各种寄存器的值，<strong>CS用于存储基地址</strong>，<strong>IP用于指向偏移地址</strong>，最下面的指令是后续将要执行的指令地址和内容，常用于直接-a编辑。</p>
<img src="/2024/02/22/Notes-Decompile/22.png" class title="This is an example image">

<h4 id="间接寻址"><a href="#间接寻址" class="headerlink" title="间接寻址"></a>间接寻址</h4><p>a.操作数值在内存中，<strong>段内偏移存储在寄存器中</strong>的寻址方式称作寄存器间接寻址。</p>
<p>b.间接寻址的寄存器有BX, BP, SI, DI。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV AX, [SI]  ;将SI中的值作为段内偏移，从内存中取出数据赋值AX</span><br><span class="line">MOV [BX], AL  ;将BX中的值作为段内偏移，把AL中的值赋值给对应内存</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/17.png" class title="This is an example image">

<h5 id="相对寻址"><a href="#相对寻址" class="headerlink" title="相对寻址"></a>相对寻址</h5><p>a.操作数值在内存中，段内偏移存储由[<strong>寄存器</strong>+<strong>立即数</strong>]计算得来的的寻址方式称作寄存器相对寻址。</p>
<p>b.寄存器相对寻址的寄存器有BX, BP, SI, DI。</p>
<p>c.寄存器相对寻址的立即数可以是8位，可以是16位的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV  [SI+10H], AX  </span><br><span class="line">MOV  CX,[BX+COUNT] </span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/18.png" class title="This is an example image">

<h5 id="基址变址寻址"><a href="#基址变址寻址" class="headerlink" title="基址变址寻址"></a>基址变址寻址</h5><p>a. 操作数值在内存中，段内偏移由[<strong>寄存器</strong>+<strong>寄存器</strong>]计算得来的寻址方式称作基址变址寻址。</p>
<p>b. 可用做基址的寄存器有BX, BP。（只能基址+变址&#x2F;变址+基址）</p>
<p>c. BX默认DS段，BP默认SS段。</p>
<p>d.可用作变址的寄存器有SI, DI。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV  [BX+DI], AX</span><br><span class="line">MOV  CX, [BP+SI]</span><br></pre></td></tr></table></figure>

<h5 id="基址变址相对寻址"><a href="#基址变址相对寻址" class="headerlink" title="基址变址相对寻址"></a>基址变址相对寻址</h5><p>a. 操作数值在内存中，段内偏移由[<strong>基址寄存器</strong>+<strong>变址寄存器</strong>+<strong>偏移常量</strong>]计算得来的寻址方式称作基址变址寻址。</p>
<p>b. 可用做基址的寄存器有BX, BP。</p>
<p>c. BX默认DS段，BP默认SS段。</p>
<p>d.可用作变址的寄存器有SI, DI。</p>
<p>e.可用作常量的数值可以是8位，可以是16位。</p>
<p>可用于模拟数据运算</p>
<p><strong>PS：</strong></p>
<p>不可内存到内存，mov [bx],[ax]</p>
<h3 id="关于机器码"><a href="#关于机器码" class="headerlink" title="关于机器码"></a>关于机器码</h3><img src="/2024/02/22/Notes-Decompile/21.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/19.png" class title="This is an example image">

<p>手动分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov ax,bx</span><br><span class="line">mov ax,cx</span><br><span class="line">mov ax,dx</span><br><span class="line">mov ax,ax</span><br><span class="line">mov ax,bp</span><br><span class="line">mov ax,si</span><br><span class="line">mov ax,di</span><br><span class="line">mov ax,sp</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/23.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">89D8  MOV AX,BX  11 011 000  </span><br><span class="line">89C8  MOV AX,CX  11 001 000</span><br><span class="line">89D0  MOV AX,DX  11 010 000</span><br><span class="line">89C0  MOV AX,AX  11 000 000</span><br><span class="line">89E8  MOV AX,BP  11 101 000</span><br><span class="line">89F0  MOV AX,SI  11 110 000</span><br><span class="line">89F8  MOV AX,DI  11 111 000</span><br><span class="line">89E0  MOV AX,SP  11 100 000</span><br><span class="line"></span><br><span class="line">AX 000</span><br><span class="line">CX 001</span><br><span class="line">DX 010</span><br><span class="line">BX 011</span><br><span class="line">SP 100</span><br><span class="line">BP 101</span><br><span class="line">SI 110</span><br><span class="line">DI 111</span><br><span class="line"></span><br><span class="line">MOV DX,BP</span><br><span class="line">89 11 101 010</span><br><span class="line">=&gt;89 1110 1010</span><br><span class="line">=&gt;89EA</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/24.png" class title="This is an example image">

<p>内存里运行的是机器码</p>
<img src="/2024/02/22/Notes-Decompile/20.png" class title="This is an example image">

<h2 id="数据传送和算术指令"><a href="#数据传送和算术指令" class="headerlink" title="数据传送和算术指令"></a>数据传送和算术指令</h2><p> 机器码、内存、寄存器、立即数（8086、286、386、486）</p>
<h3 id="MOV传送指令"><a href="#MOV传送指令" class="headerlink" title="MOV传送指令"></a>MOV传送指令</h3><p>把一个字节或字的操作数从源地址传送至目的地址。注意：<strong>不存在存储器向存储器的传送指令。</strong></p>
<img src="/2024/02/22/Notes-Decompile/25.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov [bx],ax</span><br><span class="line">mov ax,[bx]</span><br><span class="line">mov byte ptr[bx], 12 ;要指定字节数，mov双方寄存器长度要一致</span><br><span class="line">mov byte word[bx], 12 ;两个字节，可能存在溢出覆盖</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov byte ptr[bx],12</span><br><span class="line">mov word ptr[bx],12</span><br></pre></td></tr></table></figure>

<h3 id="XCHG交换指令"><a href="#XCHG交换指令" class="headerlink" title="XCHG交换指令"></a>XCHG交换指令</h3><p>1.寄存器与寄存器之间对换数据</p>
<p>2.寄存器与存储器之间对换数据</p>
<p>3.不能在存储器与存储器之间对换数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XCHG AX,BX</span><br></pre></td></tr></table></figure>

<h3 id="XLAT换码指令"><a href="#XLAT换码指令" class="headerlink" title="XLAT换码指令"></a>XLAT换码指令</h3><p>将BX（数组首地址）指定的缓冲区中、AL（数组下标索引）指定的位移处的一个字节取出赋给AL </p>
<p>al &lt;– ds:[ bx + al ]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov bx,0</span><br><span class="line">mov al,e</span><br><span class="line">XLAT</span><br></pre></td></tr></table></figure>

<p>数组首地址是0，索引是e，取值赋给al</p>
<h3 id="push、pop堆栈操作指令"><a href="#push、pop堆栈操作指令" class="headerlink" title="push、pop堆栈操作指令"></a>push、pop堆栈操作指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 进栈（push reg）</span><br><span class="line">    sub sp , 2</span><br><span class="line">    mov [sp] , reg </span><br><span class="line">2.出栈（pop reg）</span><br><span class="line">    mov reg, [sp] </span><br><span class="line">    add sp , 2</span><br><span class="line">3.保存所有寄存器环境</span><br><span class="line">    16位：pusha / popa </span><br><span class="line">    32位：pushad / popad</span><br></pre></td></tr></table></figure>

<h3 id="PUSHF、POPF标志进出栈指令"><a href="#PUSHF、POPF标志进出栈指令" class="headerlink" title="PUSHF、POPF标志进出栈指令"></a>PUSHF、POPF标志进出栈指令</h3><p>•PUSHF指令将标志寄存器的内容压入堆栈，同时栈顶指针SP减2</p>
<p>•POPF指令将栈顶字单元内容送标志寄存器，同时栈顶指针SP加2</p>
<h3 id="LEA地址传送指令"><a href="#LEA地址传送指令" class="headerlink" title="LEA地址传送指令"></a>LEA地址传送指令</h3><p>•地址传送指令将存储器单元的逻辑地址送至指定的寄存器</p>
<p>–有效地址传送指令 LEA</p>
<p>–指针传送指令 LDS和LES</p>
<p>•注意不是获取存储器单元的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LEA和MOV的区别(bx+si = ea)</span><br><span class="line">LEA bx,[bx+si] // bx = ea   不取地址内容</span><br><span class="line">mov bx,[bx+si] // bx = [ea] 取地址内容</span><br><span class="line"></span><br><span class="line">add bx,si</span><br><span class="line">mov ax,bx  </span><br><span class="line">=&gt; lea ax,[bx,si]</span><br></pre></td></tr></table></figure>

<h3 id="算数运算类指令"><a href="#算数运算类指令" class="headerlink" title="算数运算类指令"></a>算数运算类指令</h3><h4 id="加法（ADD-ADC-INC）"><a href="#加法（ADD-ADC-INC）" class="headerlink" title="加法（ADD|ADC|INC）"></a>加法（ADD|ADC|INC）</h4><p>ADD：加法，影响标识位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ADD reg,imm/reg/mem</span><br><span class="line">	；reg←reg＋imm/reg/mem</span><br><span class="line">ADD mem,imm/reg</span><br><span class="line">	；mem←mem＋imm/reg</span><br></pre></td></tr></table></figure>

<p>ADC：带进位加法，带标识位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ADC reg,imm/reg/mem</span><br><span class="line">	；reg←reg＋imm/reg/mem＋CF</span><br><span class="line">ADC mem,imm/reg</span><br><span class="line">	；mem←mem＋imm/reg＋CF</span><br></pre></td></tr></table></figure>

<p>INC：加一，不影响CF标志位</p>
<h4 id="减法（SUB-SBB-DEC）"><a href="#减法（SUB-SBB-DEC）" class="headerlink" title="减法（SUB|SBB|DEC）"></a>减法（SUB|SBB|DEC）</h4><p>SUB：减法，影响标识位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SUB reg,imm/reg/mem</span><br><span class="line">	；reg←reg－imm/reg/mem</span><br><span class="line">SUB mem,imm/reg</span><br><span class="line">	；mem←mem－imm/reg</span><br></pre></td></tr></table></figure>

<p>SBB：带借位的减法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SBB reg,imm/reg/mem</span><br><span class="line">        ；reg←(reg－(imm/reg/mem)－CF)</span><br><span class="line">SBB mem,imm/reg	</span><br><span class="line">        ；mem←mem－imm/reg－CF</span><br></pre></td></tr></table></figure>

<p>DEC： -1，不影响CF位</p>
<h4 id="求补（NEG）"><a href="#求补（NEG）" class="headerlink" title="求补（NEG）"></a>求补（NEG）</h4><p>•NEG指令对操作数执行求补运算：用零减去操作数，然后结果返回操作数</p>
<p>•求补运算也可以表达成：将操作数按位取反后加1</p>
<p>•neg ax  ;如果ax &#x3D; 0，则CF标志位 &#x3D; 0；若ax !&#x3D; 0, 则CF &#x3D; 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">问题：</span><br><span class="line">Reg == 0 ? 0 : -1</span><br><span class="line">Reg == 1 ? 1 : 0</span><br><span class="line">Reg == 8 ? 9 : 8</span><br><span class="line">Reg == 6 ? 8 : 9</span><br><span class="line"></span><br><span class="line">mov ax, X</span><br><span class="line">sub ax, 0</span><br><span class="line">neg ax</span><br><span class="line">sbb ax, ax</span><br><span class="line">sbb ax, ax</span><br><span class="line"></span><br><span class="line">1.X = 8(1000)</span><br><span class="line">mov ax, X ; ax = 8</span><br><span class="line">sub ax, 0 ; ax = 8</span><br><span class="line">neg ax    ; ax = -8, CF = 1</span><br><span class="line">sbb ax, ax; ax = -1, CF = 1</span><br><span class="line">sbb ax, ax; ax = -1</span><br><span class="line"></span><br><span class="line">2.X = 0</span><br><span class="line">mov ax, X ; ax = 0</span><br><span class="line">sub ax, 0 ; ax = 0</span><br><span class="line">neg ax    ; ax = 0, CF = 0</span><br><span class="line">sbb ax, ax; ax = 0, CF = 0</span><br><span class="line">sbb ax, ax; ax = 0</span><br></pre></td></tr></table></figure>

<h4 id="比较（CMP）"><a href="#比较（CMP）" class="headerlink" title="比较（CMP）"></a>比较（CMP）</h4><p>•格式：: CMP OPD,OPS</p>
<p>•功能：(OPD)－(OPS)</p>
<p>•说明：目的操作数减去源操作数，然后根据结果设置标志位，但该<strong>结果并不存入目的地址</strong>（sub存入）</p>
<p>•影响标志位：AF、CF、OF、PF、SF、ZF</p>
<p>•作用：一般的后面跟一条条件转移指令，根据比较结果转向不同的程序分支，用于处理OPD和OPS大小比较的不同情况。</p>
<h4 id="乘法（MUL-x2F-IMUL）"><a href="#乘法（MUL-x2F-IMUL）" class="headerlink" title="乘法（MUL&#x2F;IMUL）"></a>乘法（MUL&#x2F;IMUL）</h4><h5 id="无符号乘法"><a href="#无符号乘法" class="headerlink" title="无符号乘法"></a>无符号乘法</h5><p>格式：MUL Reg&#x2F;Mem</p>
<p>功能：显式操作数*隐含操作数(看成无符号数)。</p>
<p>影响标志位：CF和OF。</p>
<table>
<thead>
<tr>
<th>位数</th>
<th>隐含的被乘数</th>
<th>乘积的存放位置</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>8位</td>
<td>AL</td>
<td>AX</td>
<td>MUL BL</td>
</tr>
<tr>
<td>16位</td>
<td>AX</td>
<td>DX&amp;AX</td>
<td>MUL BX</td>
</tr>
<tr>
<td>32位</td>
<td>EAX</td>
<td>EDX&amp;EAX</td>
<td>MUL ECX</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">两个byte相乘要用word放（FF*FF=FE01）</span><br><span class="line">两个word相乘要用dword放(FFFF*FFFF=FFFE0001，没dword就两个寄存器)</span><br><span class="line"></span><br><span class="line">mov bl, 88</span><br><span class="line">mov al, 99</span><br><span class="line">mul bl      //存到AX</span><br><span class="line"></span><br><span class="line">mov word ptr[0], 1234</span><br><span class="line">mov bx, 4567</span><br><span class="line">mov ax, 4567</span><br><span class="line">mul word ptr[0], 4567   //存到DX&amp;AX</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/27.png" class title="This is an example image">

<p>如果乘积的高一半位(AH&#x2F;DX&#x2F;EDX)包含有乘积的有效位，则CF&#x3D;1、OF&#x3D;1; 否则，CF&#x3D;0，OF&#x3D;0。</p>
<p>OF&#x3D;CF&#x3D;1则说明：<br>字节乘字节结果超过了8位<br>字乘字结果超过了16位<br>双字乘双字结果超过了32位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov bl, 15</span><br><span class="line">mov al, 4</span><br><span class="line">mul bl</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/28.png" class title="This is an example image">

<h5 id="有符号乘法"><a href="#有符号乘法" class="headerlink" title="有符号乘法"></a>有符号乘法</h5><p>IMUL Reg&#x2F;Mem</p>
<p>IMUL Reg, Imm ;80286+</p>
<p>IMUL Reg,Reg,Imm;80286+</p>
<p>IMULReg,Reg&#x2F;Mem;80386+</p>
<p>功能：有符号数相乘</p>
<p>影响标志位：CF和OF。会扩展符号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">如果乘积的高一半位(AH，DX，EDX)不是低位的符号扩展，则CF=1、OF=1；否则，CF=0，OF=0。</span><br><span class="line">-1 * 1 = -1</span><br><span class="line">FF * 1 =&gt; AX  =&gt; 00FF 会被当做正数，则补全符号位 =&gt; FFFF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-举例：</span><br><span class="line">mov bl, -2</span><br><span class="line">mov al, 1</span><br><span class="line">imul bl</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/29.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov bl, -15</span><br><span class="line">mov al, 15</span><br><span class="line">imul bl       //不完全是符号位扩展，有数据位</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/30.png" class title="This is an example image">

<p>EB * 15 &#x3D; 1347</p>
<h4 id="除法（DIV-x2F-IDIV）"><a href="#除法（DIV-x2F-IDIV）" class="headerlink" title="除法（DIV&#x2F;IDIV）"></a>除法（DIV&#x2F;IDIV）</h4><h5 id="无符号除法"><a href="#无符号除法" class="headerlink" title="无符号除法"></a>无符号除法</h5><p>格式：DIV Reg&#x2F;Mem    被除数&#x2F;除数 &#x3D; 商 .. 余数</p>
<table>
<thead>
<tr>
<th>位数</th>
<th>被除数</th>
<th>除数</th>
<th>商</th>
<th>余数</th>
</tr>
</thead>
<tbody><tr>
<td>8位</td>
<td>AX</td>
<td>8位ops</td>
<td>AL</td>
<td>AH</td>
</tr>
<tr>
<td>16位</td>
<td>DX,AX</td>
<td>16位ops</td>
<td>AX</td>
<td>DX</td>
</tr>
<tr>
<td>32位</td>
<td>EDX,EAX</td>
<td>32位ops</td>
<td>EAX</td>
<td>EDX</td>
</tr>
</tbody></table>
<p>影响标志位：未定义</p>
<p>未定义：指令执行后这些标志是任意的，不可预测的。没有影响：指令执行后不改变标志状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 9</span><br><span class="line">mov bl, 4</span><br><span class="line">div bl</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/31.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov dx, 1234   // dx作用暂存</span><br><span class="line">mov ax, 5678</span><br><span class="line">mov bx, 4569</span><br><span class="line">div bx         // 12345678 / 4569 = 4324 . 18B4</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/32.png" class title="This is an example image">

<h5 id="有符号数除法"><a href="#有符号数除法" class="headerlink" title="有符号数除法"></a>有符号数除法</h5><p>格式：IDIV Reg&#x2F;Mem</p>
<table>
<thead>
<tr>
<th>位数</th>
<th>被除数</th>
<th>除数</th>
<th>商</th>
<th>余数</th>
</tr>
</thead>
<tbody><tr>
<td>8位</td>
<td>AX</td>
<td>8位ops</td>
<td>AL</td>
<td>AH</td>
</tr>
<tr>
<td>16位</td>
<td>DX,AX</td>
<td>16位ops</td>
<td>AX</td>
<td>DX</td>
</tr>
<tr>
<td>32位</td>
<td>EDX,EAX</td>
<td>32位ops</td>
<td>EAX</td>
<td>EDX</td>
</tr>
</tbody></table>
<p>影响标志位：AF、CF、OF、PF、SF和ZF</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ax, -19 // 十六进制的-19  0001 1001 =&gt; 1110 0111 =&gt; E 7 </span><br><span class="line">mov bl, 2   // 02</span><br><span class="line">idiv bl	    // E7/2=F4</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/33.png" class title="This is an example image">

<p>被除数远大于除数时，所得的商就有可能超出它所能表达的范围。</p>
<p>idiv除法溢出：－字节除时商不在-128～127范围内，或者在字除时商不在-32768～32767范围内</p>
<p>div除法溢出: 8位除法运算结果大于8位，16位除法运算结果大于16位。</p>
<p>举例: ax&#x3D; FFFF， bl &#x3D; FF， div bl</p>
<p>结果：相当于FFFF／FF&#x3D;101，此时AH显然放不所以商溢出</p>
<img src="/2024/02/22/Notes-Decompile/40.png" class title="This is an example image">

<h4 id="符号扩展指令（CBW-x2F-CWD）"><a href="#符号扩展指令（CBW-x2F-CWD）" class="headerlink" title="符号扩展指令（CBW&#x2F;CWD）"></a>符号扩展指令（CBW&#x2F;CWD）</h4><p>CBW（将字节转换成字指令）：</p>
<p>－语句格式：CBW(convert byte to word)</p>
<p>－功能：将AL中的符号扩展至AH中,操作数是隐含且固定的。把数值最高位扩展</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MOV AL, 04</span><br><span class="line">CBW</span><br><span class="line">MOV AL, FE</span><br><span class="line">CBW</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/34.png" class title="This is an example image">

<p>CWD（将字转换成双字指令）：</p>
<p>-语句格式：CWD</p>
<p>-功能：将AX中的符号扩展至DX中,操作数是隐含且固定的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MOV AX, 1234</span><br><span class="line">CWD</span><br><span class="line">MOV AX, FFF7</span><br><span class="line">CWD</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/35.png" class title="This is an example image">

<h4 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h4><h5 id="逻辑与：AND"><a href="#逻辑与：AND" class="headerlink" title="逻辑与：AND"></a>逻辑与：AND</h5><p>－指令的格式：AND Reg&#x2F;Mem, Reg&#x2F;Mem&#x2F;lmm</p>
<p>－受影响的标志位：CF(O)、OF(O)、PF、SF和ZF(AF无定义)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 4569  ; 0100 0101 0110 1001</span><br><span class="line">and ax, 1234  ; 0001 0010 0011 0100</span><br><span class="line">mov bx, 4541</span><br><span class="line">and ax, bx</span><br><span class="line">mov word ptr [0], 1111</span><br><span class="line">and ax, [0]</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/36.png" class title="This is an example image">

<h5 id="逻辑或：OR"><a href="#逻辑或：OR" class="headerlink" title="逻辑或：OR"></a>逻辑或：OR</h5><p>－指令的格式：OR Reg&#x2F;Mem, Reg&#x2F;Mem&#x2F;Imm</p>
<p>－受影响的标志位：CF(O)、OF(O)、PF、SF和ZF(AF无定义)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 4569  ; 0100 0101 0110 1001</span><br><span class="line">or ax, 1234   ; 0001 0010 0011 0100   </span><br><span class="line">			 ; 0101 0111 0111 1101</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/37.png" class title="This is an example image">

<h5 id="逻辑非：NOT"><a href="#逻辑非：NOT" class="headerlink" title="逻辑非：NOT"></a>逻辑非：NOT</h5><p>－指令的格式：NOT Reg&#x2F;Mem</p>
<p>－受影响的标志位：无</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 4569 ; 0100 0101 0110 1001</span><br><span class="line">not ax</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/38.png" class title="This is an example image">

<h5 id="异或：XOR"><a href="#异或：XOR" class="headerlink" title="异或：XOR"></a>异或：XOR</h5><p>－指令的格式：XOR Reg&#x2F;Mem,Reg&#x2F;Mem&#x2F;lmm</p>
<p>－受影响的标志位：CF(O)、OF(O)、PF、SF和ZF(AF无定义)</p>
<p>（相同为0不同为1，用于求两个数是否不同）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 4569 ; 0100 0101 0110 1001</span><br><span class="line">mov bx, 1234 ; 0001 0010 0011 0100   </span><br><span class="line">xor ax,bx    ; 0101 0111 0101 1101</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/39.png" class title="This is an example image">

<h5 id="TEST-指令"><a href="#TEST-指令" class="headerlink" title="TEST 指令"></a>TEST 指令</h5><p>格式：TEST Reg&#x2F;Mem,Reg&#x2F;Mem&#x2F;lmm</p>
<p>作用：执行AND，但是不影响目标操作数</p>
<p>受影响的标志位：CF(O)、OF(O)、PF、SF和ZF(AF无定义)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Eg: test ax, ax</span><br><span class="line">// ax为0，则ZF=0；</span><br><span class="line">// ax不为0，则zF = 1</span><br></pre></td></tr></table></figure>

<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>1)如果要将目的操作数中某些位清O，用AND，称之为屏蔽</p>
<p>2)如果要将目的操作数中某些位置1，用OR</p>
<p>3)用来测试目的操作数中某一位或某几位是否为0或1，而目的操作数不变，TEST</p>
<p>4)TEST与CMP的区别，前者是测试一位或几位，后者测试整个字节／字／双字是否相等</p>
<p>5)操作数自身相或、相与结果不变6)xOR AX,Ax 将Ax置0，比mov ax,0 更高效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 4</span><br><span class="line">=&gt;</span><br><span class="line">mox dx, cx</span><br><span class="line">not cx</span><br><span class="line">and dx, cx</span><br><span class="line">mov bx, 4</span><br><span class="line">xor bx, dx</span><br><span class="line">mov ax, bx</span><br></pre></td></tr></table></figure>

<h4 id="逻辑恒等式"><a href="#逻辑恒等式" class="headerlink" title="逻辑恒等式"></a>逻辑恒等式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a and 1 = a</span><br><span class="line">a and 0 = 0</span><br><span class="line">a xor 1 = not a</span><br><span class="line">a xor 0 = a</span><br><span class="line">a xor a = 0</span><br><span class="line">a and not a = 0</span><br></pre></td></tr></table></figure>

<h4 id="无分支求绝对值"><a href="#无分支求绝对值" class="headerlink" title="无分支求绝对值"></a>无分支求绝对值</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ax, X</span><br><span class="line">cwd</span><br><span class="line">xor ax, dx</span><br><span class="line">sub ax, dx</span><br></pre></td></tr></table></figure>

<h4 id="无分支求三目运算"><a href="#无分支求三目运算" class="headerlink" title="无分支求三目运算"></a>无分支求三目运算</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1、reg == 8 ? 13:7</span><br><span class="line">mov ax, X</span><br><span class="line">sub ax, 8</span><br><span class="line">neg ax</span><br><span class="line">sbb ax, ax ;if X=8, ax=0</span><br><span class="line">		  ;if X!=8, ax=-1</span><br><span class="line">mov dx. -6</span><br><span class="line">and dx, ax</span><br><span class="line">add dx, 13</span><br><span class="line"></span><br><span class="line">2、reg == 4 ? 6:11</span><br><span class="line">mov ax, X</span><br><span class="line">sub ax, 4</span><br><span class="line">neg ax</span><br><span class="line">sbb ax, ax ;if X=4, ax=0</span><br><span class="line">		  ;if X!=4, ax=-1</span><br><span class="line">mov dx. 5</span><br><span class="line">and dx, ax</span><br><span class="line">add dx, 6</span><br></pre></td></tr></table></figure>

<p>反汇编</p>
<p>反编译</p>
<p>汇编不会优化、高级语言会优化</p>
<p>反汇编引擎的基本框架</p>
<p>默认都是ds</p>
<p>bp -&gt; ss</p>
<p>ip -&gt; cs</p>
<p>用winhex从内存寻找到dbox对应的值</p>
<p>DAA&#x2F;DAS、 AAA&#x2F; AAS&#x2F;AAM&#x2F;AAD</p>
<p>特权指令</p>
<p>指令手册，不同系统</p>
<p>808x、286、386、486</p>
<h4 id="移位指令"><a href="#移位指令" class="headerlink" title="移位指令"></a>移位指令</h4><h5 id="逻辑移位-amp-算数移位"><a href="#逻辑移位-amp-算数移位" class="headerlink" title="逻辑移位&amp;算数移位"></a>逻辑移位&amp;算数移位</h5><table>
<thead>
<tr>
<th>指令</th>
<th>名称</th>
<th>格式</th>
<th>意义</th>
<th>影响标志</th>
</tr>
</thead>
<tbody><tr>
<td>SAL(shift arithmetic left)</td>
<td>算数左移</td>
<td>op r&#x2F;m, 1&#x2F;cl</td>
<td>1、左移CNT位<br>2、高位进CF<br>3、低位补0</td>
<td>OF,ZF,SF,PF,CF</td>
</tr>
<tr>
<td>SHL(shift logical left)</td>
<td>逻辑左移</td>
<td>op r&#x2F;m, 1&#x2F;cl</td>
<td>1、左移CNT位<br>2、高位进CF<br>3、低位补0</td>
<td>OF,ZF,SF,PF,CF</td>
</tr>
<tr>
<td>SAR(shift arithmeticright)</td>
<td>算数右移</td>
<td>op r&#x2F;m, 1&#x2F;cl</td>
<td>1、右移CNT位<br>2、高位保持不变(补自己)<br>3、低位进CF</td>
<td>OF,ZF,SF,PF,CF</td>
</tr>
<tr>
<td>SHR(shift logical right)</td>
<td>逻辑右移</td>
<td>op r&#x2F;m, 1&#x2F;cl</td>
<td>1、左移CNT位<br>2、高位补0<br>3、低位进CF</td>
<td>OF,ZF,SF,PF,CF</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MOV AX, FEFE</span><br><span class="line">SHL AX, 1</span><br><span class="line">MOV CL, 2</span><br><span class="line">SHL AX, CL</span><br><span class="line">MOV WORD PTR [0], 5566</span><br><span class="line">SHL WORD PTR [0], 1</span><br><span class="line">SHL WORD PTR [0], CL</span><br><span class="line">AX, CL</span><br></pre></td></tr></table></figure>

<h5 id="循环移位"><a href="#循环移位" class="headerlink" title="循环移位"></a>循环移位</h5><table>
<thead>
<tr>
<th>指令</th>
<th>名称</th>
<th>格式</th>
<th>意义</th>
<th>影响标志</th>
</tr>
</thead>
<tbody><tr>
<td>ROL(rotate)</td>
<td>循环左移</td>
<td>op r&#x2F;m, 1&#x2F;cl</td>
<td>1、左移<br>2、高位进低位<br>3、高位进CF</td>
<td>OF、CF<br>其他标志无定义</td>
</tr>
<tr>
<td>ROR(rotate)</td>
<td>循环右移</td>
<td>op r&#x2F;m, 1&#x2F;cl</td>
<td>1、右移<br>2、低位进高位<br>3、低位进CF</td>
<td>OF、CF<br>其他标志无定义</td>
</tr>
<tr>
<td>RCL(carry)</td>
<td>带进位循环左移</td>
<td>op r&#x2F;m, 1&#x2F;cl</td>
<td>1、左移<br>2、高位进CF<br>3、CF进低位</td>
<td>OF、CF<br>其他标志无定义</td>
</tr>
<tr>
<td>RCR(carry)</td>
<td>带进位循环右移</td>
<td>op r&#x2F;m, 1&#x2F;cl</td>
<td>1、右移<br>2、高位进CF<br>3、CF进高位</td>
<td>OF、CF<br>其他标志无定义</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov ax, fefe</span><br><span class="line">rol ax, 1</span><br><span class="line">mov ax, fefe</span><br><span class="line">rol ax, 2</span><br><span class="line">rol ax, cl</span><br></pre></td></tr></table></figure>



<h2 id="ASM基础语法"><a href="#ASM基础语法" class="headerlink" title="ASM基础语法"></a>ASM基础语法</h2><p>配置Masm615</p>
<p>VSCode安装MASM&#x2F;TASM插件</p>
<p>编译命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ml /c xx.asm</span><br><span class="line">link xx.obj</span><br></pre></td></tr></table></figure>

<p>编译+调试 脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ml /c %1.asm</span><br><span class="line">link %1.obj</span><br><span class="line">debug %1.exe</span><br></pre></td></tr></table></figure>



<p>直接用插件，插件的环境是临时的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ml /c test.asm    ；编译生成obj文件</span><br><span class="line">link test.obj     ；链接生成exe文件</span><br><span class="line">debug test.exe</span><br><span class="line"></span><br><span class="line">data_seg segment</span><br><span class="line">    mov ax, ax</span><br><span class="line">    mov ax, ax</span><br><span class="line">ENRTY：</span><br><span class="line">    mov ax, ax</span><br><span class="line">    mov ax, ax</span><br><span class="line">data_seg ends</span><br><span class="line">end ENRTY</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">data segment ;数据段</span><br><span class="line">    string db &#x27;zhuge shabi$&#x27;</span><br><span class="line">data ends</span><br><span class="line">code segment ;代码段</span><br><span class="line">assume cs:code,ds:data</span><br><span class="line">start:</span><br><span class="line">    mov ax,data ;获取段基址</span><br><span class="line">    mov ds,ax ;将段基址送入寄存器</span><br><span class="line">    mov dx,offset string</span><br><span class="line">    mov ah,9</span><br><span class="line">    int 21h</span><br><span class="line">    mov ah,4ch</span><br><span class="line">    int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<p>debug exe，用前边的-u，-a调试</p>
<p>入口</p>
<h3 id="段"><a href="#段" class="headerlink" title="段"></a>段</h3><ul>
<li>一个程序必须至少有一个段</li>
<li>一个程序中可以定义多个段</li>
<li>段不能嵌套</li>
<li>段可以重名，重名的段会被编译到同一块内存中</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">段名 segment </span><br><span class="line">start:</span><br><span class="line">	xxx</span><br><span class="line">段名 ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<h3 id="数值"><a href="#数值" class="headerlink" title="数值"></a>数值</h3><h4 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h4><ul>
<li>整数可以支持多个进制</li>
<li>数值必须以数字开头，如果非数字前面必须加0</li>
<li>负数前面可以加减号（-)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">十进制 mov ax, 1234 / mov ax, 1234d</span><br><span class="line">二进制 mov ax, 1011b</span><br><span class="line">八进制 mov ax, 76o</span><br><span class="line">十六进制 mov ax, 76h / mov ax, 0abh</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">code segment </span><br><span class="line">start:</span><br><span class="line">	mov ax, 256</span><br><span class="line">	mov ax, 256d</span><br><span class="line">	mov ax, 10000000b</span><br><span class="line">	mov cx, 100</span><br><span class="line">	mov dx, 1234h</span><br><span class="line">	mov dx, -1h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/43.png" class title="This is an example image">

<h4 id="字符"><a href="#字符" class="headerlink" title="字符"></a>字符</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov al, &#x27;a&#x27;</span><br><span class="line">mov bl, &#x27;b&#x27;</span><br><span class="line">mov cl, &#x27;c&#x27;</span><br><span class="line">mov dl, &#x27;d&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><h5 id="整数-1"><a href="#整数-1" class="headerlink" title="整数"></a>整数</h5><ul>
<li>整数可以支持多个类型</li>
<li>整数可以有多个初值，未初始化的值用问号（？）表示</li>
<li>变量一般定义在一个单独的段中</li>
</ul>
<p>格式：变量名 类型  初始值<br>          val        dd     5566h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">;数据段和操作段分开</span><br><span class="line">data_seg segment</span><br><span class="line">	g_btVal db 55h                  ; db 字节</span><br><span class="line">	g_wVal dw 5566h                 ; dw 字</span><br><span class="line">	g_dwVal dd 55667788h            ; dd 双字</span><br><span class="line">	g_qVal dq 1122334455667788h     ; dq 8字节</span><br><span class="line">	g_tVal dt 11223344556677889900h ; dt 10字节</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">uinitdata_seg segment</span><br><span class="line">	g_btVal1 db ?</span><br><span class="line">	g_wVal1 dw ?</span><br><span class="line">	g_tVal dt ?</span><br><span class="line">uinitdata_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">START:</span><br><span class="line">	assume ds:data_seg ;ds:ip，此处指定下面g_btVal变量去data_seg找</span><br><span class="line">	mov ax, data_seg ;还需要重新指定ds的值，否则基地址错误</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	mov al, g_btVal</span><br><span class="line">	mov ax, g_wVal</span><br><span class="line">code_seg ends</span><br><span class="line">end START</span><br></pre></td></tr></table></figure>

<p>-d 查看内存往前偏移 </p>
<p>076D-&gt;0769为什么是偏移两行</p>
<img src="/2024/02/22/Notes-Decompile/44.png" class title="This is an example image">

<p><strong>-u 看基址，-d指定基地址看数据，mov是取地址的值，-u看要mov的值的地址</strong></p>
<h5 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h5><ul>
<li>字符串都可以用单引号()或双引号(“”)</li>
<li>字符串一般以美元符$结尾</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">9_sz db &quot;hello world$&quot; ;16位汇编中以美元符结尾</span><br><span class="line">data_seg segment</span><br><span class="line">	g_szHello db &quot;hello world$&quot;                  ; db 字节</span><br><span class="line">data_seg ends</span><br></pre></td></tr></table></figure>

<h5 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data_seg segment</span><br><span class="line">	g_ary db 10h, 11h, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;; db 字节</span><br><span class="line">	g_ary1 db 10 dup(0cch); 重复10个字节，每个字节填充cc</span><br><span class="line">	g_ary2 db 10 dup(?)</span><br><span class="line">	g_ary3 db 45h, 10 dup(46h), 47h, 20 dup(48h)</span><br><span class="line">data_seg ends</span><br></pre></td></tr></table></figure>

<h5 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h5><p>masm提供了很多伪指令，可以获取变量的大小和地址称之为变量的属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">seg      取段基址</span><br><span class="line">offset   取段偏移</span><br><span class="line">type     取元素类型大小</span><br><span class="line">length   取元素个数</span><br><span class="line">size     取数据大小</span><br><span class="line"></span><br><span class="line">data_seg segment</span><br><span class="line">	g_btVal db 55h                  ; db 字节</span><br><span class="line">	g_wVal dw 5566h                 ; dw 字</span><br><span class="line">	g_dwVal dd 55667788h            ; dd 双字</span><br><span class="line">	g_qVal dq 1122334455667788h     ; dq 8字节</span><br><span class="line">	g_tVal dt 11223344556677889900h ; dt 10字节</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">START:</span><br><span class="line">	assume ds:data_seg ;ds:ip，此处指定下面g_btVal变量去data_seg找</span><br><span class="line">	mov ax, data_seg ;还需要重新指定ds的值，否则基地址错误</span><br><span class="line">	mov ds, ax</span><br><span class="line">	mov ax, seg g_wVal</span><br><span class="line">	mov ax, offset g_dwVal </span><br><span class="line">code_seg ends</span><br><span class="line">end START</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/45.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/46.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">;获取g_ary3的大小</span><br><span class="line">mov ax, offset g_ary4</span><br><span class="line">sub ax, offset g_ary3</span><br></pre></td></tr></table></figure>

<h5 id="堆栈"><a href="#堆栈" class="headerlink" title="堆栈"></a>堆栈</h5><p>SS:存放栈的段地址；<br>SP:堆栈寄存器SP(stack pointer)存放栈的偏移地址；<br>BP: 基数指针寄存器BP(base pointer)是一个寄存器；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stack_seg segment stack ;栈会自动加载</span><br><span class="line">	db 256 dup(0cch) ;为栈申请大小</span><br><span class="line">stack_seg ends</span><br><span class="line"></span><br><span class="line">push ax</span><br><span class="line">push bx</span><br><span class="line">push cx</span><br><span class="line">push dx</span><br><span class="line">pop ax</span><br><span class="line">pop bx</span><br><span class="line">pop cx</span><br><span class="line">pop dx</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/47.png" class title="This is an example image">

<h5 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h5><ul>
<li>dos系统提供的功能（API），通过<strong>21号中断</strong>来调用</li>
<li>每个功能都有一个编号，通过AH指定功能号</li>
<li>每个功能的参数查看手册</li>
</ul>
<p>INT指令，本指令将产生一个软中断,把控制转向一个类型号为n的软中断,该中断处理程序入口地址在中断向量表的n*4地   —-  址处的二个存储器字(4个单元)中.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">API功能默认调用00:00的函数</span><br><span class="line">-a</span><br><span class="line">; 0000:0000  60 10 00 F0 0B 00 70 00-08 00 70 00 08 00 70 00</span><br><span class="line">INT 00 ;表示调用 F000:1060</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/50.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/48.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">code_seg segment</span><br><span class="line">START:</span><br><span class="line">    mov ah, 4ch</span><br><span class="line">    mov al, 00h</span><br><span class="line">    int </span><br><span class="line">code_seg ends</span><br><span class="line">end START ; -g或是.exe直接退出</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/49.png" class title="This is an example image">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">data_seg segment</span><br><span class="line">	g_szHello db &quot;hello world$&quot;                  ; db 字节</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">START:</span><br><span class="line">	assume ds:data_seg, ss:stack_seg</span><br><span class="line">	mov ax, data_seg</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	mov ah, 09</span><br><span class="line">	mov dx, offset g_szHello</span><br><span class="line">	int 21h</span><br><span class="line">code_seg ends</span><br><span class="line">end START ;-p参数</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.model small</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">    strs DB &#x27;hello world&#x27;,13,10,&#x27;$&#x27;</span><br><span class="line">.code</span><br><span class="line">start:</span><br><span class="line">    mov ax,@data</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov dx,offset strs</span><br><span class="line">    mov ah,09h</span><br><span class="line">    int 21h</span><br><span class="line">    mov ah,4ch</span><br><span class="line">    int 21h</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dgwblog/p/11865850.html">https://www.cnblogs.com/dgwblog/p/11865850.html</a></p>
<h3 id="串操作"><a href="#串操作" class="headerlink" title="串操作"></a>串操作</h3><ul>
<li>源操作数使用si，默认段为DS（以此为基址），<strong>可段超越</strong></li>
<li>目的操作数使用di，默认段为ES（以此为基址），不可段超越</li>
</ul>
<table>
<thead>
<tr>
<th>指令</th>
<th>功能</th>
<th>DF &#x3D; 0(UP)</th>
<th>DF &#x3D; 1(DN)</th>
</tr>
</thead>
<tbody><tr>
<td>movsb<br>（串传送）</td>
<td>1、mov string<br>2、将si地址的内容拷贝到di地址<br>3、(di) &lt;- (si)</td>
<td>si &lt;- si + 1<br>di &lt;- di + 1</td>
<td>si &lt;- si - 1<br>di &lt;- di - 1</td>
</tr>
<tr>
<td>movsw</td>
<td>同 movsb</td>
<td>si &lt;- si + 2<br>di &lt;- di + 2</td>
<td>si &lt;- si - 2<br>di &lt;- di - 2</td>
</tr>
<tr>
<td>stosb<br>（串存储）</td>
<td>1、store string<br>2、将al或者ax内存存储到di地址<br>3、(di) &lt;- al或(di) &lt;- ax</td>
<td>di &lt;- di + 1<br></td>
<td>di &lt;- di - 1<br></td>
</tr>
<tr>
<td>stosw</td>
<td>同 stosb</td>
<td>di &lt;- di + 2</td>
<td>di &lt;- di - 2</td>
</tr>
<tr>
<td>lodsb<br>（串读取）</td>
<td>1、load string<br>2、将si地址内容读入al或者ax<br>3、al &lt;- (si) 或 ax &lt;- (si)</td>
<td>si &lt;- si + 1</td>
<td>si &lt;- si -1</td>
</tr>
<tr>
<td>lodsw</td>
<td>同 lodsb</td>
<td>si &lt;- si + 2</td>
<td>si &lt;- si - 2</td>
</tr>
<tr>
<td>cmpsb<br>(串比较)</td>
<td>1、cmp string<br>2、si地址内容减去di地址内容，不存储结果，影响标志位<br>3、(si) - (di)</td>
<td>si &lt;- si + 1<br>di &lt;- di + 1</td>
<td>si &lt;- si - 1<br>di &lt;- di - 1</td>
</tr>
<tr>
<td>cmpsw</td>
<td>同 cmpsb</td>
<td>si &lt;- si + 2<br>di &lt;- di + 2</td>
<td>si &lt;- si - 2<br>di &lt;- di - 2</td>
</tr>
<tr>
<td>scasb<br>(串扫描)</td>
<td>1、scan string<br>2、al或者ax减去di地址内容，不存结果，影响标志位<br>3、al - (di)或ax - (di)  es:di</td>
<td>di &lt;- di + 1</td>
<td>di &lt;- di - 1</td>
</tr>
<tr>
<td>scasw</td>
<td>同 scasb</td>
<td>di &lt;- di + 2</td>
<td>di &lt;- di - 2</td>
</tr>
</tbody></table>
<h4 id="movsb-amp-movsw"><a href="#movsb-amp-movsw" class="headerlink" title="movsb &amp; movsw"></a>movsb &amp; movsw</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">data_seg segment</span><br><span class="line">	g_szSrc db &quot;hello world&quot;, &#x27;$&#x27;</span><br><span class="line">	g_szDst db 64 dup(0)</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">START:</span><br><span class="line">	assume ds:data_seg </span><br><span class="line">	mov ax, data_seg   ; 这三句是固定的基本上，不然会找错值</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	mov ax, data_seg   ; 这三句是固定的基本上，不然会找错值</span><br><span class="line">	mov es, ax  ; 因为di用的是es</span><br><span class="line">	</span><br><span class="line">	lea si, g_szSrc</span><br><span class="line">	mov di, offset g_szDst ; 相对起始位置</span><br><span class="line">	;std  -g 11</span><br><span class="line">	movsb ;movsw</span><br><span class="line">	movsb</span><br><span class="line">	movsb</span><br><span class="line">	movsb</span><br><span class="line">	movsb</span><br><span class="line">code_seg ends</span><br><span class="line">end START ;-p参数</span><br><span class="line"></span><br><span class="line">;-t</span><br><span class="line">;-d 0 l 20</span><br><span class="line">;-t</span><br><span class="line">;-d es l 20 可以把ds和es分开段写</span><br><span class="line">;movsb si bi默认是加一，根据DF标志位加一减一</span><br><span class="line">;STD DF&lt;-1 自动减</span><br><span class="line">;CLD DF&lt;-0 自动加</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/52.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/53.png" class title="This is an example image">

<p>0E24:0010 &#x3D; 0E25:0000？？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">data_seg segment</span><br><span class="line">	g_szSrc db &quot;hello world&quot;, &#x27;$&#x27;</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">data_seg0 segment</span><br><span class="line">	g_szDst0 db 64 dup(0)</span><br><span class="line">data_seg0 ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">START:</span><br><span class="line">	assume ds:data_seg, es:data_seg0</span><br><span class="line">	mov ax, data_seg   ; 这三句是固定的基本上，不然会找错值</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	mov ax, data_seg0   ; 这三句是固定的基本上，不然会找错值</span><br><span class="line">	mov es, ax  ; 因为di用的是es</span><br><span class="line">	</span><br><span class="line">	lea si, g_szSrc</span><br><span class="line">	mov di, offset g_szDst0 ; 相对起始位置</span><br><span class="line">	;std  -g 11</span><br><span class="line">	movsb ;movsw</span><br><span class="line">	movsb</span><br><span class="line">	movsb</span><br><span class="line">	movsb</span><br><span class="line">	movsb</span><br><span class="line">code_seg ends</span><br><span class="line">end START ;-p参数</span><br></pre></td></tr></table></figure>



<h4 id="stosb-amp-stosw"><a href="#stosb-amp-stosw" class="headerlink" title="stosb &amp; stosw"></a>stosb &amp; stosw</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov di, offset g_szDst</span><br><span class="line">cld</span><br><span class="line">mov ax, 0cccch</span><br><span class="line">stowd</span><br><span class="line">stowd</span><br><span class="line">stowd</span><br><span class="line">stowd</span><br><span class="line">stowd</span><br></pre></td></tr></table></figure>

<p>其他自行看</p>
<p>代码虚拟化、软件模拟硬件</p>
<h4 id="重复前缀"><a href="#重复前缀" class="headerlink" title="重复前缀"></a>重复前缀</h4><p>串操作指令一般都配合重复前缀使用，实现内存的批量操作，</p>
<table>
<thead>
<tr>
<th>前缀</th>
<th>串操作</th>
<th>重复条件</th>
</tr>
</thead>
<tbody><tr>
<td>rep</td>
<td>1、movs<br>2、stos<br>3、loads</td>
<td>cx !&#x3D; 0</td>
</tr>
<tr>
<td>repz &#x2F; repe</td>
<td>1、cmps<br>2、scas</td>
<td>cx !&#x3D; 0<br>且<br><br>zf &#x3D; 1</td>
</tr>
<tr>
<td>repnz &#x2F; repne</td>
<td>1、cmps<br>2、scas</td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">data_seg segment</span><br><span class="line">	g_szSrc db &quot;hello world&quot;, &#x27;$&#x27;</span><br><span class="line">	g_szSrcEnd db ?</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">buf_seg segment</span><br><span class="line">	g_szDst db 16 dup(0)</span><br><span class="line">	g_szDstEnd db ?</span><br><span class="line">buf_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">START:</span><br><span class="line">	assume ds:data_seg</span><br><span class="line">	mov ax, data_seg   ; 这三句是固定的基本上，不然会找错值</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	mov ax, buf_seg   ; 这三句是固定的基本上，不然会找错值</span><br><span class="line">	mov es, ax  ; 因为di用的是es</span><br><span class="line">	</span><br><span class="line">	lea si, g_szSrc</span><br><span class="line">	lea di, g_szDst</span><br><span class="line">	cld</span><br><span class="line">	mov cx, offset g_szSrcEnd</span><br><span class="line">	sub cx, offset g_szSrc</span><br><span class="line">	rep movsb ;cx每次减一</span><br><span class="line">code_seg ends</span><br><span class="line">end START ;-p参数</span><br></pre></td></tr></table></figure>

<h3 id="流程转移指令"><a href="#流程转移指令" class="headerlink" title="流程转移指令"></a>流程转移指令</h3><h4 id="无条件跳转"><a href="#无条件跳转" class="headerlink" title="无条件跳转"></a>无条件跳转</h4><h5 id="直接跳转"><a href="#直接跳转" class="headerlink" title="直接跳转"></a>直接跳转</h5><table>
<thead>
<tr>
<th>名称</th>
<th>修饰关键词（可选）</th>
<th>格式</th>
<th>功能</th>
<th>指令长度</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>短跳(单字)</td>
<td>short</td>
<td>jmp short 标号</td>
<td>ip &lt;- 标号偏移</td>
<td>2</td>
<td>0005:EB0B    <br>jmp 0012</td>
</tr>
<tr>
<td>近跳(双字)</td>
<td>near ptr</td>
<td>jmp near 标号</td>
<td>ip &lt;- 标号偏移</td>
<td>3</td>
<td>0007:E90a01  <br>jmp 0114</td>
</tr>
<tr>
<td>远跳(四字)</td>
<td>far ptr</td>
<td>jmp far ptr 标号<br>jmp 段名:标号</td>
<td>ip &lt;- 标号偏移<br>cs &lt;- 段地址</td>
<td>5</td>
<td>0000:EA00007c07 <br>jmp 077C:0000</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">code_seg0 segment</span><br><span class="line">LABEL2:</span><br><span class="line">	mov cx, cx</span><br><span class="line">code_seg0 ends</span><br><span class="line">code_seg segment</span><br><span class="line">START:</span><br><span class="line">    jmp far ptr LABEL2 ; jmp code_seg0:LABEL2</span><br><span class="line">    jmp short LEABEL0</span><br><span class="line">    mov ax, ax</span><br><span class="line">LEABEL0:</span><br><span class="line">	jmp near ptr LEABEL1</span><br><span class="line">	db 256 dup(0)</span><br><span class="line">	mov bx, bx</span><br><span class="line">LEABEL1:</span><br><span class="line">	mov ax, 4c00h</span><br><span class="line">	int 21h</span><br><span class="line">code_seg ends</span><br><span class="line">end START</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/54.png" class title="This is an example image">

<p>Jmp下条指令+偏移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">;计算机器码</span><br><span class="line">;短跳0xEB，近跳0XE9</span><br><span class="line">0AE7:0102 jmp 0120 ; 短跳是一个字节，两个十六进制 120-104 = EB1C，主要是计算下条指令的偏移</span><br><span class="line">0AE7:0102 jmp 0320 ; 近跳是两个字节，四个十六进制 320-105 = E91B02，因为三个位可以表示？</span><br><span class="line">0AE7:0102 jmp 0020 ; E91BFF，补码E4用单字(-128-127)存不下，要用近跳</span><br><span class="line">0AE7:0402 jmp 0100</span><br><span class="line">0AE7:0122 jmp 0110</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/51.png" class title="This is an example image">

<h5 id="无指令跳转"><a href="#无指令跳转" class="headerlink" title="无指令跳转"></a>无指令跳转</h5><p>使用寄存器间接转移</p>
<ul>
<li>格式 jmp reg</li>
<li>reg为通用寄存器</li>
<li>功能 ip&lt;-reg</li>
<li>只能用于段内转移</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov ax, offset LEABEL1</span><br><span class="line">jmp ax</span><br></pre></td></tr></table></figure>

<h4 id="条件跳转"><a href="#条件跳转" class="headerlink" title="条件跳转"></a>条件跳转</h4><p>依据标志位判断，条件成立则跳转，条件不成立则不跳</p>
<h5 id="单条件跳转"><a href="#单条件跳转" class="headerlink" title="单条件跳转"></a>单条件跳转</h5><table>
<thead>
<tr>
<th>指令</th>
<th>英文单词</th>
<th>标志</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>JZ&#x2F;JE</strong></td>
<td><strong>zero,equal</strong></td>
<td><strong>ZF&#x3D;1</strong></td>
<td><strong>相等&#x2F;等于零</strong></td>
</tr>
<tr>
<td><strong>JNZ&#x2F;JNE</strong></td>
<td><strong>not zero,not qual</strong></td>
<td><strong>ZF&#x3D;0</strong></td>
<td><strong>不相等，不等于零</strong></td>
</tr>
<tr>
<td><strong>JCXZ</strong></td>
<td><strong>CX is zero</strong></td>
<td><strong>CX&#x3D;0</strong></td>
<td><strong>cx为0</strong></td>
</tr>
<tr>
<td>JS</td>
<td>sign</td>
<td>SF &#x3D; 1</td>
<td>结果为负</td>
</tr>
<tr>
<td>JNS</td>
<td>not sign</td>
<td>SF &#x3D; 0</td>
<td>结果为正</td>
</tr>
<tr>
<td>JP&#x2F;JPE</td>
<td>parity, parity even</td>
<td>PF &#x3D; 1</td>
<td>1为偶数个</td>
</tr>
<tr>
<td>JNP&#x2F;JPO</td>
<td>not parity, parity odd</td>
<td>PF &#x3D; 0</td>
<td>1为奇数个</td>
</tr>
<tr>
<td>JO</td>
<td>overflow</td>
<td>OF &#x3D; 1</td>
<td>溢出</td>
</tr>
<tr>
<td>JNO</td>
<td>not overlow</td>
<td>OF &#x3D; 0</td>
<td>不溢出</td>
</tr>
<tr>
<td>JC</td>
<td>carry</td>
<td>CF &#x3D; 1</td>
<td>进位，小于</td>
</tr>
<tr>
<td>JNC</td>
<td>not carry</td>
<td>CF &#x3D; 0</td>
<td>不进位，大于等于</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FIND:</span><br><span class="line">	cmp byte ptr [si], &#x27;$&#x27;</span><br><span class="line">	je ENDFIND</span><br><span class="line">	</span><br><span class="line">	inc si</span><br><span class="line">	jmp FIND</span><br><span class="line">ENDFIND:</span><br><span class="line">	sub si, 1</span><br></pre></td></tr></table></figure>

<h5 id="无符号数判断"><a href="#无符号数判断" class="headerlink" title="无符号数判断"></a>无符号数判断</h5><table>
<thead>
<tr>
<th>指令</th>
<th>英文</th>
<th>说明</th>
<th>标志</th>
</tr>
</thead>
<tbody><tr>
<td><strong>JB</strong></td>
<td><strong>below</strong></td>
<td><strong>小于</strong></td>
<td><strong>cf &#x3D; 1</strong></td>
</tr>
<tr>
<td>JNAE</td>
<td>not greater or equal</td>
<td>不大于等于</td>
<td>cf &#x3D; 1</td>
</tr>
<tr>
<td><strong>JAE</strong></td>
<td><strong>above or equal</strong></td>
<td><strong>大于等于</strong></td>
<td><strong>cf &#x3D;0</strong></td>
</tr>
<tr>
<td>JNB</td>
<td>not below</td>
<td>不小于</td>
<td>cf &#x3D;0</td>
</tr>
<tr>
<td><strong>JBE</strong></td>
<td><strong>below or equal</strong></td>
<td><strong>小于等于</strong></td>
<td><strong>cf &#x3D; 1 或 zf &#x3D; 1</strong></td>
</tr>
<tr>
<td>JNA</td>
<td>not above</td>
<td>不大于</td>
<td>同 JBE</td>
</tr>
<tr>
<td><strong>JA</strong></td>
<td><strong>above</strong></td>
<td><strong>大于</strong></td>
<td><strong>cf &#x3D;0 或 zf &#x3D;0</strong></td>
</tr>
<tr>
<td>JNBE</td>
<td>not below or equal</td>
<td>不小于等于</td>
<td>同 JA</td>
</tr>
</tbody></table>
<h5 id="有符号数判断"><a href="#有符号数判断" class="headerlink" title="有符号数判断"></a>有符号数判断</h5><table>
<thead>
<tr>
<th>指令</th>
<th>英文单词</th>
<th>说明</th>
<th>标志</th>
</tr>
</thead>
<tbody><tr>
<td>JL</td>
<td>less</td>
<td>小于</td>
<td>SF !&#x3D; OF</td>
</tr>
<tr>
<td>JNGE</td>
<td>not greater or equal</td>
<td>不大于等于</td>
<td>SF !&#x3D; OF</td>
</tr>
<tr>
<td>JG</td>
<td>greater</td>
<td>大于</td>
<td>SF &#x3D; OF 且<br>ZF &#x3D; 0</td>
</tr>
<tr>
<td>JNLE</td>
<td>not less or equal</td>
<td>不小于等于</td>
<td>同 JG</td>
</tr>
<tr>
<td>JLE</td>
<td>less or equal</td>
<td>小于等于</td>
<td>ZF !&#x3D; OF 或<br>ZF &#x3D; 1</td>
</tr>
<tr>
<td>JNG</td>
<td>not greator</td>
<td>不大于</td>
<td>同 JLE</td>
</tr>
<tr>
<td>JGE</td>
<td>greator orequal</td>
<td>大于等于</td>
<td>SF &#x3D; OF</td>
</tr>
<tr>
<td>JNL</td>
<td>not less</td>
<td>不小于</td>
<td>同 JGE</td>
</tr>
</tbody></table>
<h4 id="LOOP"><a href="#LOOP" class="headerlink" title="LOOP"></a>LOOP</h4><p>格式：loop标号</p>
<p>只能用于短转移</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>重复条件</th>
</tr>
</thead>
<tbody><tr>
<td>LOOP</td>
<td>cx !&#x3D; 0</td>
</tr>
<tr>
<td>LOOPZ&#x2F;LOOPE</td>
<td>cx !&#x3D; 0 且 zf &#x3D; 1</td>
</tr>
<tr>
<td>LOOPNZ&#x2F;LOOPNE</td>
<td>cx !&#x3D; 0 且 zf &#x3D; 0</td>
</tr>
</tbody></table>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h4><p>call - push 下一条指令地址<br>           jmp 目标地址</p>
<p>ret n - 弹出返回地址<br>       jmp到返回地址<br>       add sp, n</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">stack_seg segment stack ;栈会自动加载</span><br><span class="line">	db 256 dup(0cch) ;为栈申请大小</span><br><span class="line">stack_seg ends</span><br><span class="line"></span><br><span class="line">data_seg segment</span><br><span class="line">	g_sz1 db &quot;1hello world$&quot;</span><br><span class="line">	g_sz2 db &quot;2hello world$&quot;</span><br><span class="line">	g_sz3 db &quot;3hello world$&quot;</span><br><span class="line">	g_sz4 db &quot;4hello world$&quot;</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">	assume ds:data_seg, ss:stack_seg</span><br><span class="line"></span><br><span class="line">PUTS0:</span><br><span class="line">	push bp</span><br><span class="line">	mov bp, sp</span><br><span class="line">	push dx</span><br><span class="line">	mov dx, [bp+4]</span><br><span class="line">	mov ah, 09h</span><br><span class="line">	int 21h</span><br><span class="line">	</span><br><span class="line">	mov dl, 0ah</span><br><span class="line">	mov ah, 02h</span><br><span class="line">	int 21h</span><br><span class="line">	</span><br><span class="line">	pop dx</span><br><span class="line">	pop bp</span><br><span class="line">	ret 2 ;sp+2，一个参数+2</span><br><span class="line"></span><br><span class="line">PUTS:</span><br><span class="line">	push bp</span><br><span class="line">	mov bp, sp</span><br><span class="line">	sub sp, 8 ;申请局部变量空间</span><br><span class="line">	</span><br><span class="line">	;保存寄存器环境</span><br><span class="line">	push dx</span><br><span class="line">	</span><br><span class="line">	mov dx, [bp+4]</span><br><span class="line">	mov ah, 09h</span><br><span class="line">	int 21h</span><br><span class="line">	</span><br><span class="line">	mov word ptr [bp-4], 5566h</span><br><span class="line">	mov word ptr [bp-8], 7788h ;多个函数调用要手动规划栈</span><br><span class="line">	</span><br><span class="line">	mov dx, offset g_sz1</span><br><span class="line">	push dx</span><br><span class="line">	call PUTS0 ;多个函数调用要手动规划栈</span><br><span class="line">	</span><br><span class="line">	mov dl, 0ah</span><br><span class="line">	mov ah, 02h</span><br><span class="line">	int 21h</span><br><span class="line">	</span><br><span class="line">	;恢复寄存器环境</span><br><span class="line">	pop dx</span><br><span class="line">	add sp, 8 ;释放局部变量空间   mov sp, bp</span><br><span class="line">	pop bp ;pop就直接更新bp的值吗</span><br><span class="line">	ret 2 ;sp+2，一个参数+2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">StrLen:</span><br><span class="line">	push bp</span><br><span class="line">	mov bp, sp</span><br><span class="line">	</span><br><span class="line">	push si</span><br><span class="line">	push bx</span><br><span class="line">	</span><br><span class="line">	mov bx, [bp+4] ;获取参数</span><br><span class="line">	mov si, bx</span><br><span class="line">FIND:</span><br><span class="line">	cmp byte ptr [si], &#x27;$&#x27;</span><br><span class="line">	je ENDFIND</span><br><span class="line">	inc si</span><br><span class="line">	jmp FIND</span><br><span class="line">ENDFIND:</span><br><span class="line">	sub si, bx</span><br><span class="line">	;ax为函数默认返回值，默认不用入栈平栈</span><br><span class="line">	mov ax, si</span><br><span class="line">	</span><br><span class="line">	pop bx</span><br><span class="line">	pop si</span><br><span class="line">	</span><br><span class="line">	mov sp, bp</span><br><span class="line">	pop bp</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">START:</span><br><span class="line">	mov ax, data_seg</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	mov ax, offset g_sz1</span><br><span class="line">	push ax</span><br><span class="line">	call StrLen</span><br><span class="line">	add sp, 2  ;此处如果是 ret 2就可以不用在外面平</span><br><span class="line">	</span><br><span class="line">	mov ax, offset g_sz2</span><br><span class="line">	push ax</span><br><span class="line">	call StrLen</span><br><span class="line">	add sp, 2</span><br><span class="line">	</span><br><span class="line">	mov dx, offset g_sz1</span><br><span class="line">	push dx   ;参数入栈</span><br><span class="line">	call PUTS ;返回地址入栈</span><br><span class="line">	</span><br><span class="line">	mov dx, offset g_sz2</span><br><span class="line">	push dx</span><br><span class="line">	call PUTS</span><br><span class="line">	</span><br><span class="line">	mov dx, offset g_sz3</span><br><span class="line">	push dx</span><br><span class="line">	call PUTS</span><br><span class="line">	</span><br><span class="line">	mov dx, offset g_sz4</span><br><span class="line">	push dx</span><br><span class="line">	call PUTS</span><br><span class="line">	</span><br><span class="line">	;程序退出，退出码0</span><br><span class="line">	mov ax, 4c00h</span><br><span class="line">	int 21h</span><br><span class="line">code_seg ends</span><br><span class="line">end START ;-p参数</span><br></pre></td></tr></table></figure>



<p>bp用的是ss段，bx用的是dx段，栈是【局部变量】【bp】【返回地址】【入参】</p>
<p>函数执行流程</p>
<ul>
<li>参数入栈 </li>
<li>返回地址入栈，跳转到函数</li>
<li>保存栈帧（就是栈内给某个上下文环境临时规划的局部栈）</li>
<li>申请局部变量空间</li>
<li>保存寄存器环境</li>
<li>执行函数功能</li>
<li>恢复寄存器环境</li>
<li>恢复栈帧</li>
<li>弹出返回地址，返回[平栈]</li>
<li>[平栈]</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agv -&gt; ret -&gt; bp -&gt;局部变量</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>指令(可选)</th>
<th>说明</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>call (near ptr) 标号</td>
<td>段内直接调用</td>
<td>push 返回地址<br>jmp 标号</td>
</tr>
<tr>
<td>call REG<br>call near ptr | word ptr [EA]</td>
<td>段内间接调用</td>
<td>push 返回地址<br>jmp 函数地址</td>
</tr>
<tr>
<td>call far ptr 标号<br>call dword ptr [EA]</td>
<td>段间调用</td>
<td>push</td>
</tr>
<tr>
<td>ret(n)</td>
<td>段内返回</td>
<td>pop ip<br>add sp,n</td>
</tr>
<tr>
<td>retf(n)</td>
<td>段间返回</td>
<td>pop ip<br>pop cs<br>add sp, n</td>
</tr>
</tbody></table>
<h4 id="masm函数语法"><a href="#masm函数语法" class="headerlink" title="masm函数语法"></a>masm函数语法</h4><p>自动算偏移，bp，sp入栈平栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">函数名 proc[距离][调用约定][uses reg1 reg2..][参数：word, 参数名：word..] ;uses保存寄存器环境</span><br><span class="line">	local 变量：word</span><br><span class="line">	local 变量: word</span><br><span class="line">	ret</span><br><span class="line">函数名 endp</span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line">TestProc PROC far stdcall uses bx dx si di arg1:word</span><br><span class="line">	local btVal:byte</span><br><span class="line">	ret</span><br><span class="line">TestProc ENDP</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>距离关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>near</td>
<td>函数只能段内调用<br>函数使用ret返回<br>调用时ip入栈</td>
</tr>
<tr>
<td>far</td>
<td>段内段间都可调用<br>函数使用retf返回<br>调用时都是ip和cs入栈</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>调用约定关键词</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>C</td>
<td>调用方平栈</td>
</tr>
<tr>
<td>stdcall</td>
<td>被调用方平栈</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">include tool.inc</span><br><span class="line"></span><br><span class="line">stack_seg segment stack ;栈会自动加载</span><br><span class="line">	db 256 dup(0cch) ;为栈申请大小</span><br><span class="line">stack_seg ends</span><br><span class="line"></span><br><span class="line">data_seg segment</span><br><span class="line">    g_wVa11 dw 5566h</span><br><span class="line">    g_wVa12 dw 7788</span><br><span class="line">    g_szFileName db &quot;test.txt&quot;, 0</span><br><span class="line">    g_buf db 256 dup(0)</span><br><span class="line">    g_hFile dw 0</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">	assume ds:data_seg, ss:stack_seg</span><br><span class="line">START:</span><br><span class="line">	mov ax, data_seg</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	invoke OpenFile, offset g_szFileName</span><br><span class="line">	cmp ax,-1 ;打开文件成功返回句柄，不成功返回错误码</span><br><span class="line">	je ERROR</span><br><span class="line">	mov g_hFile, ax</span><br><span class="line">	invoke Readfile, g_hFile, offset g_buf, size g_buf</span><br><span class="line">	cmp ax,0</span><br><span class="line">	je ERROR</span><br><span class="line">	invoke CloseFile, g_hFile</span><br><span class="line">ERROR:</span><br><span class="line">	;宏汇编</span><br><span class="line">	invoke MySub, 45, 13 ;使用立即数时，会用ax中转</span><br><span class="line">	</span><br><span class="line">	mov si, 9</span><br><span class="line">	mov di, 8</span><br><span class="line">	invoke MySub, si, di</span><br><span class="line">	</span><br><span class="line">	invoke MySub, g_wVa12, g_wVa11</span><br><span class="line">	</span><br><span class="line">	mov ax, 45</span><br><span class="line">	push ax</span><br><span class="line">	mov ax, 13</span><br><span class="line">	push ax</span><br><span class="line">	call MySub</span><br><span class="line">	add sp, 4</span><br><span class="line">	</span><br><span class="line">	;程序结束，退出码0</span><br><span class="line">	mov ax, 4C00H</span><br><span class="line">	INT 21H</span><br><span class="line">code_seg ends</span><br><span class="line">end START </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>类型</th>
<th>局部变量类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>db</td>
<td>byte</td>
<td>可以直接赋值使用</td>
</tr>
<tr>
<td>dw</td>
<td>word</td>
<td>可以直接赋值使用</td>
</tr>
<tr>
<td>dd</td>
<td>dword</td>
<td>不可以直接赋值使用</td>
</tr>
<tr>
<td>dq</td>
<td>qword</td>
<td>不可以直接赋值使用</td>
</tr>
<tr>
<td>dt</td>
<td>tbyte</td>
<td>不可以直接赋值使用</td>
</tr>
</tbody></table>
<p>assume、invoke：没有对应的机器码，给编译器看的，伪指令</p>
<h5 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke 函数名, 参数1, 参数2, 参数3</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>会生成参数入栈代码</li>
<li>如果是c调用约定，会生成平栈代码</li>
<li>如果是局部变量取地址，需要使用addr伪指令</li>
<li>使用addr的时候，注意ax的使用</li>
</ul>
<table>
<thead>
<tr>
<th>伪指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>offset</td>
<td>取段内偏移</td>
</tr>
<tr>
<td>addr</td>
<td>取局部变量的地址，使用LEA指令</td>
</tr>
</tbody></table>
<h4 id="文件引用"><a href="#文件引用" class="headerlink" title="文件引用"></a>文件引用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">;tool.asm</span><br><span class="line">include tool.inc</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line"></span><br><span class="line">CloseFile proc far stdcall uses bx hFile:word</span><br><span class="line">	mov bx, hFile</span><br><span class="line">	mov ah, 3eh</span><br><span class="line">	int 21h</span><br><span class="line">	ret</span><br><span class="line">CloseFile ENDP</span><br><span class="line"></span><br><span class="line">ReadFile proc far stdcall uses bx dx cx hFile:word, pBuff:word, nBufSize:word</span><br><span class="line">	mov bx, hFile</span><br><span class="line">	mov ah, 3fh</span><br><span class="line">	mov dx, pBuff</span><br><span class="line">	mov cx, nBufSize</span><br><span class="line">	int 21H</span><br><span class="line">	jnc SUCESS</span><br><span class="line">	;失败</span><br><span class="line">	mov ax,0</span><br><span class="line">	ret</span><br><span class="line">SUCESS:</span><br><span class="line">	ret</span><br><span class="line">ReadFile ENDP</span><br><span class="line"></span><br><span class="line">OpenFile proc far stdcall uses dx szFileName:word</span><br><span class="line">	mov ah, 3dh</span><br><span class="line">	mov al, 02h ;可读，可写</span><br><span class="line">	mov dx, szFileName</span><br><span class="line">	int 21H</span><br><span class="line">	jnc SUCESS</span><br><span class="line">	;失败</span><br><span class="line">	mov ax,-1</span><br><span class="line">	ret</span><br><span class="line">SUCESS:</span><br><span class="line">	;成功</span><br><span class="line">	ret</span><br><span class="line">OpenFile ENDP</span><br><span class="line"></span><br><span class="line">MySub PROC far c uses cx di es nVal1:word, nVal2:word</span><br><span class="line">	local @btVar1:byte ;局部变量标识，非必须</span><br><span class="line">	local @wVa11:word</span><br><span class="line">	local @dwVal1:dword</span><br><span class="line">	local @buf[256]:byte</span><br><span class="line">	</span><br><span class="line">	xor ax, ax</span><br><span class="line">	mov @btvar1,al</span><br><span class="line">	mov @wVal1,ax</span><br><span class="line">	;mov @dwval1,ax</span><br><span class="line">	</span><br><span class="line">	;lea bx, @buf</span><br><span class="line">	invoke MyZeroMem,ss,addr @buf,255 ;add 取局部变量的地址，I专用于invoke</span><br><span class="line">	;去局部变量地址用 offset ?</span><br><span class="line">	</span><br><span class="line">	mov ax, nVal1</span><br><span class="line">	mov ax, nVal2</span><br><span class="line">	ret</span><br><span class="line">MySub ENDP</span><br><span class="line">MyZeroMem PROC far stdcall uses di cx es pSecBase:word, pBuff:word, nSize:word</span><br><span class="line">	xor ax, ax</span><br><span class="line">	mov es, pSecBase</span><br><span class="line">	mov cx, nSize</span><br><span class="line">	mov di, pBuff</span><br><span class="line">	rep stosb</span><br><span class="line">	ret</span><br><span class="line">MyZeroMem ENDP</span><br><span class="line">code_seg ends</span><br><span class="line">ends ;每个asm文件都要以ends结尾</span><br></pre></td></tr></table></figure>

<p>声明头文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">;tool.inc</span><br><span class="line">MySub PROTO far c :word, :word</span><br><span class="line">MyZeroMem PROTO far stdcall :word, :word, :word</span><br><span class="line">;功能 - 创建文件，如果文件存在，则清空</span><br><span class="line">;参数 - </span><br><span class="line">;	szFileName - 文件名，0结尾字符串</span><br><span class="line">;返回 - </span><br><span class="line">;	失败 - 返回 -1 </span><br><span class="line">;	成功-返回文件句柄</span><br><span class="line">CreateFile PROTO far stdcall szFileName:word</span><br><span class="line">ReadFile PROTO far stdcall hFile:Word, pBuff:word, nBufSize:word</span><br><span class="line">CloseFile PROTO far stdcall hFile:word</span><br><span class="line">OpenFile PROTO far stdcall szFileName:word</span><br></pre></td></tr></table></figure>

<p>需要同时编译两个文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ml /c test.asm tool.asm</span><br><span class="line">link test.obj tool.obj</span><br></pre></td></tr></table></figure>

<p>PS：</p>
<p>调试小技巧，int 3 &#x2F; db 0cch，直接 -g 会go到中断处，-p执行当前语句（不进入）</p>
<p>MASM扩展在这个扩展的设置中，有一个名为<code>Working mode</code>。默认情况下，它被设置为单个文件。如果您更改为工作区，它将挂载整个dir。</p>
<h4 id="宏汇编"><a href="#宏汇编" class="headerlink" title="宏汇编"></a>宏汇编</h4><h5 id="表达式-org"><a href="#表达式-org" class="headerlink" title="表达式  $  org  @@"></a>表达式  $  org  @@</h5><p>表达式需要能够在编译阶段计算结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">stack_seg segment stack ;栈会自动加载</span><br><span class="line">	db 256 dup(0cch) ;为栈申请大小</span><br><span class="line">stack_seg ends</span><br><span class="line"></span><br><span class="line">data_seg segment</span><br><span class="line">	g_dbVal0 db 11h</span><br><span class="line">	org 10h</span><br><span class="line">	g_dbVal1 db 22h</span><br><span class="line">	org 20h</span><br><span class="line">	g_dbVal3 db 33h</span><br><span class="line"></span><br><span class="line">	g_wBuf dw 256 dup(0) ;相当于100个word,200个字节</span><br><span class="line">	;g_wBufLen dw offset g_wBufLen - offset g_wBuf ;?</span><br><span class="line">	g_wBufLen dw $ - offset g_wBuf</span><br><span class="line">	</span><br><span class="line">	org 400h ;下个段偏移位置从400开始</span><br><span class="line">	g_wVal0 dw 5566h</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">	assume ds:data_seg, ss:stack_seg</span><br><span class="line">START:</span><br><span class="line">	mov ax, data_seg</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	mov ax, g_wBufLen</span><br><span class="line">	mov dx, size g_wBuf / size word ;看值</span><br><span class="line">	mov ax, g_wVal0 / 2 ;报错，无法在编译阶段计算结果</span><br><span class="line">	mov ax, offset g_wVal0 - offset g_wBuf</span><br><span class="line">	</span><br><span class="line">	mov ax, 1122h and 5566h ;运算符</span><br><span class="line">	mov ax, 3344h or 7788h</span><br><span class="line">	mov ax, not 0</span><br><span class="line">	and g_wVal0, 5566h ;指令</span><br><span class="line">	</span><br><span class="line">	mov ax，6 1e 4 ;关系为假，结果为0</span><br><span class="line">	mov ax，7 gt 1 ;关系为真，结果为全F</span><br><span class="line">	</span><br><span class="line">	@@:</span><br><span class="line">		xor ax, ax</span><br><span class="line">	@@:</span><br><span class="line">		mov ax, ax</span><br><span class="line">		mov bx,bx</span><br><span class="line">		jmp @f  ;就近向下跳</span><br><span class="line">		mov si, si</span><br><span class="line">		jmp @b  ;就近向上跳</span><br><span class="line">	@@:</span><br><span class="line">		mov cx, cx</span><br><span class="line">		mov dx, dx</span><br><span class="line">	@@:</span><br><span class="line">		xor bx,bx</span><br><span class="line">	</span><br><span class="line">	mov ax, offset NEXT</span><br><span class="line">	mov ax, $+3</span><br><span class="line">	NEXT:</span><br><span class="line">	mov bx, $</span><br><span class="line">	mov ax, $</span><br><span class="line">	mov ax, $</span><br><span class="line">	</span><br><span class="line">	;程序结束，退出码0</span><br><span class="line">	mov ax, 4C00H</span><br><span class="line">	INT 21H</span><br><span class="line">code_seg ends</span><br><span class="line">end START </span><br></pre></td></tr></table></figure>

<h5 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">stack_seg segment stack ;栈会自动加载</span><br><span class="line">	db 256 dup(0cch) ;为栈申请大小</span><br><span class="line">stack_seg ends</span><br><span class="line"></span><br><span class="line">MyTestTag struc </span><br><span class="line">	m_bval db θ</span><br><span class="line">	m_wVal dw 0</span><br><span class="line">	m_buf db 10 dup (0)</span><br><span class="line">MyTestTag ends</span><br><span class="line"></span><br><span class="line">data_seg segment</span><br><span class="line">	g_tag MyTestTag &lt;55h, 7788h, &quot;hello struct!&quot;&gt;</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">MyTest proc far stdcall pTag:ptr MyTestTag</span><br><span class="line">	assume si:ptr MyTestTag</span><br><span class="line">	mov si, pTag</span><br><span class="line">	mov ax, [si].m_wVal</span><br><span class="line">	assume si:nothing</span><br><span class="line">	</span><br><span class="line">	mov bx, pTag</span><br><span class="line">	mov ax, word ptr [bx+2]</span><br><span class="line">	</span><br><span class="line">	ret</span><br><span class="line">MyTest endp</span><br><span class="line">	assume ds:data_seg, ss:stack_seg</span><br><span class="line">START:</span><br><span class="line">	mov ax, data_seg</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	mov al, g_tag.m_bVal</span><br><span class="line">	mov ax, g_tag.m_wVal</span><br><span class="line">	lea ax, g_tag.m_buf</span><br><span class="line">	</span><br><span class="line">	mov g_tag.m_bval, 66h</span><br><span class="line">	mov g_tag.m_wVal, 1234h</span><br><span class="line"></span><br><span class="line">	invoke MyTest, offset g_tag</span><br><span class="line">	</span><br><span class="line">	; local @stu：Students ;结构体局部变量</span><br><span class="line">	; mov @stu.m_id, 6 ;使用结构体局部变量</span><br><span class="line">	</span><br><span class="line">	;程序结束，退出码0</span><br><span class="line">	mov ax, 4C00H</span><br><span class="line">	INT 21H</span><br><span class="line">code_seg ends</span><br><span class="line">end START </span><br></pre></td></tr></table></figure>

<h5 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h5><h6 id="equ语句"><a href="#equ语句" class="headerlink" title="equ语句"></a>equ语句</h6><ul>
<li>不可以重命名</li>
<li>可用于常量和表达式</li>
<li>可用于字符串</li>
<li>可用于指令名，给指令取别名</li>
<li>可用于类型，给类型取别名</li>
<li>可用于操作数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">stack_seg segment stack ;栈会自动加载</span><br><span class="line">	db 256 dup(0cch) ;为栈申请大小</span><br><span class="line">stack_seg ends</span><br><span class="line"></span><br><span class="line">VERSION equ 10</span><br><span class="line">VERSTR equ &quot;hello wrold&quot;</span><br><span class="line">MYMOV equ mov</span><br><span class="line">MYPUSHAX equ push ax</span><br><span class="line"></span><br><span class="line">data_seg segment</span><br><span class="line">	g_wVal dw VERSION</span><br><span class="line">	g_buf db VERSTR</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">	assume ds:data_seg, ss:stack_seg</span><br><span class="line">START:</span><br><span class="line">	mov ax, data_seg</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	MYMOV ax, g_wVal</span><br><span class="line">	MYPUSHAX</span><br><span class="line">	</span><br><span class="line">	;程序结束，退出码0</span><br><span class="line">	mov ax, 4C00H</span><br><span class="line">	INT 21H</span><br><span class="line">code_seg ends</span><br><span class="line">end START </span><br></pre></td></tr></table></figure>

<h6 id="x3D-只能整数的equ"><a href="#x3D-只能整数的equ" class="headerlink" title="&#x3D;(只能整数的equ)"></a>&#x3D;(只能整数的equ)</h6><h6 id="macro语句"><a href="#macro语句" class="headerlink" title="macro语句"></a>macro语句</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MYADD MACRO argl, arg2</span><br><span class="line">	mov ax, arg1</span><br><span class="line">	add ax, arg2</span><br><span class="line">ENDM</span><br><span class="line"></span><br><span class="line">MYADD 4, 5</span><br><span class="line">MYADD 7, 8</span><br></pre></td></tr></table></figure>

<p>字符串拼接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">shift macro n, reg, d</span><br><span class="line">	mov cl, n</span><br><span class="line">	ro&amp;d reg, cl</span><br><span class="line">	endm</span><br><span class="line"></span><br><span class="line">shift 2,ax,1</span><br><span class="line">shift 3,bx,r</span><br><span class="line">shift 1,cx,1</span><br><span class="line"></span><br><span class="line">.if ax &lt; θ </span><br><span class="line">	mov ax, ax</span><br><span class="line">.elseif ax == 0</span><br><span class="line">	mov bx, bx</span><br><span class="line">.else </span><br><span class="line">	mov cx, cx</span><br><span class="line">.endif</span><br></pre></td></tr></table></figure>

<p>汇编手册中文(asm+masm).chm</p>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">;test.asm</span><br><span class="line">include tool.inc</span><br><span class="line"></span><br><span class="line">stack_seg segment stack ;栈会自动加载</span><br><span class="line">	db 500H dup(0cch) ;一个段（256）的栈</span><br><span class="line">stack_seg ends</span><br><span class="line"></span><br><span class="line">data_seg segment</span><br><span class="line">	g_buf db 256 dup(0)</span><br><span class="line">	g_wBufLen dw $ - offset g_buf</span><br><span class="line">	g_bufCnt db5 4 dup(0), 0ah, &quot;$&quot;</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line">	assume ds:data_seg, ss:stack_seg</span><br><span class="line">	</span><br><span class="line">GetwordsCount proc far stdcall uses bx pBuff:word</span><br><span class="line">	local @bIsPreSapce:byte</span><br><span class="line">	mov @bIsPreSapce, 0</span><br><span class="line"></span><br><span class="line">	mov ax, 1</span><br><span class="line">	mov bx, pBuff</span><br><span class="line">	;空字符串</span><br><span class="line">	.if byte ptr [bx] == &quot;$&quot;</span><br><span class="line">		xor ax, ax</span><br><span class="line">		ret</span><br><span class="line">	.endif</span><br><span class="line">	</span><br><span class="line">	;非空字符串</span><br><span class="line">	.while byte ptr[bx] != &quot;$&quot;</span><br><span class="line">		.if byte ptr [bx] == &quot; &quot;</span><br><span class="line">			.if @bIsPreSapce == 0</span><br><span class="line">				inc ax</span><br><span class="line">			.endif</span><br><span class="line">			mov @bIsPreSapce, 1</span><br><span class="line">		else</span><br><span class="line">			mov @bIsPreSapce, 0</span><br><span class="line">		.endif</span><br><span class="line">		inc bx</span><br><span class="line">	.endw</span><br><span class="line">	ret</span><br><span class="line">GetwordsCount endp</span><br><span class="line"></span><br><span class="line">START:</span><br><span class="line">	mov ax, data_seg</span><br><span class="line">	mov ds, ax</span><br><span class="line">	</span><br><span class="line">	xor cx, cx</span><br><span class="line">	.while cx &lt; 5</span><br><span class="line">		;获取一行</span><br><span class="line">		invoke GetLine, offset g_buf, g_wBufLen</span><br><span class="line">		</span><br><span class="line">		;获取此行的单词个数</span><br><span class="line">		invoke GetwordsCount, offset g_buf</span><br><span class="line">		</span><br><span class="line">		;个数转字符串</span><br><span class="line">		invoke IntToStr, offset g_bufCnt, ax</span><br><span class="line">		</span><br><span class="line">		;输出个数</span><br><span class="line">		invoke Puts, offset g_bufCnt</span><br><span class="line">		</span><br><span class="line">		inc cx</span><br><span class="line">	.endw</span><br><span class="line">	;程序结束，退出码0</span><br><span class="line">	mov ax, 4C00H</span><br><span class="line">	INT 21H</span><br><span class="line">code_seg ends</span><br><span class="line">end START </span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">;tool.asm</span><br><span class="line">include tool.inc</span><br><span class="line">data_seg segment</span><br><span class="line">	g_bufHexChar db &quot;0123456789abcdef&quot;</span><br><span class="line">data_seg ends</span><br><span class="line"></span><br><span class="line">code_seg segment</span><br><span class="line"></span><br><span class="line">Puts proc far stdcall uses dx pBuff:word</span><br><span class="line">	mov dx, pBuff</span><br><span class="line">	mov ah, 09h</span><br><span class="line">	int 21h</span><br><span class="line">	</span><br><span class="line">	mov dl, odh</span><br><span class="line">	mov ah, 02h</span><br><span class="line">	int 21H</span><br><span class="line">	</span><br><span class="line">	ret</span><br><span class="line">Puts endp</span><br><span class="line"></span><br><span class="line">IntToStr proc far stdcall uses si bx ds cx pBuff:word, n:word</span><br><span class="line">	local @wCnt:word</span><br><span class="line">	local @wOldDs:word</span><br><span class="line">	</span><br><span class="line">	assumeds:data_seg</span><br><span class="line">	</span><br><span class="line">	mov @wOldDs, ds</span><br><span class="line">	</span><br><span class="line">	mov @wCnt, θ</span><br><span class="line">	.while @wCnt &lt; 4</span><br><span class="line">		mov si, n</span><br><span class="line">		and si, 0f000h</span><br><span class="line">		mov cl, 0ch</span><br><span class="line">		shr si, cl</span><br><span class="line">		</span><br><span class="line">		mov ax, data_seg</span><br><span class="line">		mov ds, ax</span><br><span class="line">		mov bx, offset g_bufHexChar</span><br><span class="line">		mov al, [si + bx]</span><br><span class="line">		</span><br><span class="line">		mov ds, @wOldDs</span><br><span class="line">		mov bx, pBuff</span><br><span class="line">		add bx, @wCnt</span><br><span class="line">		mov [bx], al</span><br><span class="line">		</span><br><span class="line">		mov cl, 4</span><br><span class="line">		shl n, cl</span><br><span class="line">		</span><br><span class="line">		inc @wCnt</span><br><span class="line">	.endw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GetChar proc far stdcall</span><br><span class="line">	mov ah, 01h</span><br><span class="line">	int 21H</span><br><span class="line">	ret</span><br><span class="line">GetChar ENDP</span><br><span class="line"></span><br><span class="line">GetLine proc far stdcall uses bx PBuff:word, nBufSize:word</span><br><span class="line">	mov bx,pBuff</span><br><span class="line">	invoke Getchar</span><br><span class="line">	.while al != 0dh</span><br><span class="line">		mov [bx],al</span><br><span class="line">		inc bx</span><br><span class="line">		.if bx &gt;= nBufSize</span><br><span class="line">			.break</span><br><span class="line">		.endif</span><br><span class="line">		invoke Getchar</span><br><span class="line">	.endw</span><br><span class="line">	mov byte ptr[bx], &#x27;$&#x27;</span><br><span class="line">	mov ax, bx</span><br><span class="line">	sub ax, pBuff</span><br><span class="line">	ret</span><br><span class="line">GetLine endp</span><br><span class="line"></span><br><span class="line">code_seg ends</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;tool.inc</span><br><span class="line">GetLine proto far stdcall PBuff:word, nBufSize:word</span><br><span class="line">IntToStr proto far stdcall pBuff:word, n:word</span><br><span class="line">Puts proto far stdcall pBuff:word</span><br></pre></td></tr></table></figure>



<p>w32Dasm</p>
<p>机器码是十六进制，winHex打开的默认就是机器码</p>
<ul>
<li>通过地址搜机器码</li>
</ul>
<h1 id="32ASM汇编"><a href="#32ASM汇编" class="headerlink" title="32ASM汇编"></a>32ASM汇编</h1><p>masm32.com</p>
<p>直接指定文件夹安装</p>
<p>把缺少的头文件路径添加在环境变量的include里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ml /c /coff test.asm</span><br><span class="line">link /subsystem:windows test.obj</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">;测试代码</span><br><span class="line">.386</span><br><span class="line">.model flat, stdcall</span><br><span class="line">option casemap:NONE</span><br><span class="line">include windows.inc</span><br><span class="line">include user32.inc</span><br><span class="line">includelib user32.lib</span><br><span class="line">.data</span><br><span class="line">	g_szTitle db &quot;hello world&quot;, 0</span><br><span class="line">.code</span><br><span class="line">ENTRY:</span><br><span class="line">	invoke MessageBoxA, NULL, offset g_szTitle, NULL, MB_OK</span><br><span class="line">end ENTRY</span><br></pre></td></tr></table></figure>

<h2 id="与16位ASM区别"><a href="#与16位ASM区别" class="headerlink" title="与16位ASM区别"></a>与16位ASM区别</h2><p>文件头三件套</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.386 ;指令集 Processor</span><br><span class="line">.model flat, stdcall</span><br><span class="line">option casemap:NONE ;标识符是否大小写敏感，none是敏感</span><br></pre></td></tr></table></figure>

<p>msdn宏汇编官网</p>
<p> <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/assembler/masm/directives-reference?view=msvc-160">https://docs.microsoft.com/en-us/cpp/assembler/masm/directives-reference?view=msvc-160</a></p>
<p>32位 &#x3D; 4G</p>
<h3 id="分段"><a href="#分段" class="headerlink" title="分段"></a>分段</h3><p>32位汇编取消了分段，改用内存属性来划分，称作节(section)、内存区或内存块。</p>
<table>
<thead>
<tr>
<th>节</th>
<th>可读</th>
<th>可写</th>
<th>可执行</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>.DATA</td>
<td>true</td>
<td>true</td>
<td>false</td>
<td>初始化的全局变量</td>
</tr>
<tr>
<td>.CONST</td>
<td>true</td>
<td>false</td>
<td>false</td>
<td>只读数据区</td>
</tr>
<tr>
<td>.DATA?</td>
<td>true</td>
<td>true</td>
<td>false</td>
<td>未初始化的全局变量</td>
</tr>
<tr>
<td>CODE</td>
<td>true</td>
<td>false</td>
<td>true</td>
<td>代码</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">	g_dwVal dd θ</span><br><span class="line">	g_dwVal1 dd 0, 0, 1</span><br><span class="line">.data?</span><br><span class="line">	g_dwVal2 dd ?</span><br><span class="line">.const</span><br><span class="line">	g_dwVa13 dd 9</span><br><span class="line">TestEntry:</span><br><span class="line">	mov ax, ax</span><br><span class="line">end TestEntry</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/55.png" class title="This is an example image">

<p>enter leave</p>
<h3 id="寻址"><a href="#寻址" class="headerlink" title="寻址"></a>寻址</h3><img src="/2024/02/22/Notes-Decompile/56.png" class title="This is an example image">

<p>32位没用中断，调用API</p>
<p>安装MASM</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">;编码要用GBK</span><br><span class="line">.386</span><br><span class="line">.model flat, stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">include windows.inc</span><br><span class="line">include user32.inc</span><br><span class="line">include gdi32.inc</span><br><span class="line">include kernel32.inc</span><br><span class="line"></span><br><span class="line">includelib user32.lib</span><br><span class="line">includelib gdi32.lib</span><br><span class="line">includelib kernel32.lib</span><br><span class="line"></span><br><span class="line">.data </span><br><span class="line">	g_szClassName db &quot;Asmwindowclass&quot;, 0</span><br><span class="line">	g_szTitle     db &quot;32位汇编的第一个窗口&quot;, 0</span><br><span class="line">	g_szTip       db &quot;窗口创建失败&quot;, 0 </span><br><span class="line">.code</span><br><span class="line"></span><br><span class="line">MainWndProc proc hWnd:HWND, nMsg:UINT, wParam:WPARAM, lParam:LPARAM</span><br><span class="line">	.IF nMsg == WM_DESTROY</span><br><span class="line">		invoke PostQuitMessage, 0</span><br><span class="line">	.ENDIF</span><br><span class="line">	invoke DefWindowProc, hWnd, nMsg, wParam, lParam</span><br><span class="line">	ret</span><br><span class="line">MainWndProc endp</span><br><span class="line"></span><br><span class="line">WinMain proc hInstance:HINSTANCE</span><br><span class="line">	local @wc:WNDCLASS</span><br><span class="line">	local @hwnd:HWND</span><br><span class="line">	local @msg:MSG</span><br><span class="line">	</span><br><span class="line">	;设计注册窗口类</span><br><span class="line">	mov @wc.style, CS_HREDRAW or CS_VREDRAW</span><br><span class="line">	mov @wc.lpfnWndProc, offset MainWndProc</span><br><span class="line">	mov @wc.cbClsExtra, 0</span><br><span class="line">	mov @wc.cbWndExtra, 0</span><br><span class="line">	mov eax, hInstance</span><br><span class="line">	mov @wc.hInstance, eax</span><br><span class="line">	</span><br><span class="line">	invoke LoadIcon, NULL, IDI_APPLICATION</span><br><span class="line">	mov @wc.hIcon, eax</span><br><span class="line">	</span><br><span class="line">	invoke LoadCursor, NULL, IDC_ARROW</span><br><span class="line">	mov @wc.hCursor, eax</span><br><span class="line">	</span><br><span class="line">	invoke GetStockObject, WHITE_BRUSH</span><br><span class="line">	mov @wc.hbrBackground, eax</span><br><span class="line">	</span><br><span class="line">	mov @wc.lpszMenuName, NULL</span><br><span class="line">	mov @wc.lpszClassName, offset g_szClassName</span><br><span class="line">	</span><br><span class="line">	invoke RegisterClass, addr @wc</span><br><span class="line">	</span><br><span class="line">	;创建窗口</span><br><span class="line">	invoke CreateWindowEx, NULL, offset g_szClassName,offset g_szTitle, WS_OVERLAPPEDWINDOW,\</span><br><span class="line">	CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,\</span><br><span class="line">	NULL, NULL, hInstance, NULL</span><br><span class="line">	mov @hwnd, eax</span><br><span class="line">	.if eax == NULL</span><br><span class="line">		invoke MessageBox, NULL, offset g_szTip, offset g_szTitle, MB_OK</span><br><span class="line">		ret</span><br><span class="line">	.endif</span><br><span class="line">	</span><br><span class="line">	;显示窗口</span><br><span class="line">	invoke ShowWindow, @hwnd, SW_SHOW</span><br><span class="line">	</span><br><span class="line">	;更新窗口</span><br><span class="line">	invoke UpdateWindow, @hwnd</span><br><span class="line">	</span><br><span class="line">	;消息循环</span><br><span class="line">	.WHILE TRUE</span><br><span class="line">		invoke GetMessage, addr @msg, NULL, 0, 0</span><br><span class="line">		.IF eax == 0</span><br><span class="line">			.break</span><br><span class="line">		.ENDIF</span><br><span class="line">		invoke TranslateMessage, addr @msg</span><br><span class="line">		invoke DispatchMessage, addr @msg</span><br><span class="line">	.ENDW</span><br><span class="line">	;过程函数</span><br><span class="line">	</span><br><span class="line">	ret</span><br><span class="line">WinMain endp</span><br><span class="line"></span><br><span class="line">Cr41Entry:</span><br><span class="line">	invoke GetModuleHandle, NULL</span><br><span class="line">	invoke WinMain, eax</span><br><span class="line">	invoke ExitProcess, 0</span><br><span class="line">end Cr41Entry</span><br></pre></td></tr></table></figure>



<h2 id="OD的简易使用"><a href="#OD的简易使用" class="headerlink" title="OD的简易使用"></a>OD的简易使用</h2><ul>
<li>跳转指定地址，右键-&gt;跳转表达式 &#x2F; ctrl+G &#x2F; 回车 &#x2F; 减号回退  </li>
<li>右键汇编，右选可以撤销</li>
<li>右键快速返回栈顶</li>
<li>F2 断点</li>
<li>F7 单步步入；F8 单步步过；F9 运行；F12 暂停</li>
</ul>
<p>删除OD&#x2F;UDD文件夹下面的文件</p>
<h2 id="资源和联合编译"><a href="#资源和联合编译" class="headerlink" title="资源和联合编译"></a>资源和联合编译</h2><h3 id="C-amp-汇编的相互调用"><a href="#C-amp-汇编的相互调用" class="headerlink" title="C &amp; 汇编的相互调用"></a>C &amp; 汇编的相互调用</h3><p>VC + ml + link + rc</p>
<p>汇编调用C - OBJ</p>
<p>C调用汇编 - OBJ</p>
<p>建议编译成   DLL&#x2F;lib 调用</p>
<p>查看 DLL 内部函数，Dependency walker</p>
<p>汇编在链接时可以导出 DLL 文件，但需要指定对应的 def 文件，不然 DLL 文件中没有函数，不会生成 lib 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link /subsystem:windows /Dll /Def:Asmdll.def asmdll.obj</span><br></pre></td></tr></table></figure>



<h3 id="内联汇编（c-x2F-c-写汇编）"><a href="#内联汇编（c-x2F-c-写汇编）" class="headerlink" title="内联汇编（c&#x2F;c++写汇编）"></a>内联汇编（c&#x2F;c++写汇编）</h3><p>内联汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">;不能使用宏汇编，比如invoke，.if等等可以使用size，type、length</span><br><span class="line">intnAry[10] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">__asm xor eax, eax</span><br><span class="line">__asm xor ebx, ebx</span><br><span class="line">__asm&#123;</span><br><span class="line">	xor edi, edi</span><br><span class="line">	xor esi, esi</span><br><span class="line">	mov ebx, nRet</span><br><span class="line">	mov nRet, eax</span><br><span class="line">	mov nAry[0], eax</span><br><span class="line">	mov nAry[5], eax</span><br><span class="line">	</span><br><span class="line">	push NULL</span><br><span class="line">	push NULL</span><br><span class="line">	push NULL</span><br><span class="line">	push NULL</span><br><span class="line">	call MessageBox</span><br><span class="line">	;invoke MessageBox,NULL,NULL,NULL,NULL</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">裸函数</span><br><span class="line">__declspec(naked)用于生成裸函数，编译器不会为这个函数生成任何代码，需要自已添加函数进入和返回的代码__LOCAL_SIZE - 内置宏，让编译器计算局部变量的大小</span><br></pre></td></tr></table></figure>



<h2 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h2><p>定位窗口的过程函数</p>
<p>1、根据窗口相关的 API 去跟踪调用</p>
<p>2、OD自带功能，查看-&gt;窗口-&gt;刷新</p>
<p>3、OD自带功能，查看-&gt;可执行模块(导入函数)-&gt;(搜函数)</p>
<p>条件断点功能</p>
<p>编程窗口程序思路</p>
<p>1、手动 create 窗口的</p>
<p>2、调用 dlgbox</p>
<p>搜索什么关键词要看具体什么应用，用什么语言开发(windows桌面程序)</p>
<p>1、查看-&gt;可执行模块<br>2、选择对应exe，[winmine.exe]右键查看名称，搜索 RegisterClass(导入函数)，右键查看参考(调用)，打断点<br>3、在输入函数内搜索 DIGLOGBOX ，可手动，可右键全部调用处打断点<br>4、执行，根据栈的跳转查看 pWndClass 栈结构内存，查手册可知，(pWndClass)的第二个参数为过程函数，内存跳转到汇编，打上断点，标注为主窗口的过程函数<br>5、pWndClass和RegisterClassW的关系是函数内部调用吗，此处是pWndClass已经调用，RegisterClassW还没调用吗<br>5、执行到过程函数处，可先禁用断点运行后再生效<br>6、寻找默认过程函数，点击Close时触发</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">01001BC9   .  55            push    ebp                              ;  主函数默认过程函数</span><br><span class="line">01001BCA   .  8BEC          mov     ebp, esp</span><br><span class="line">01001BCC   .  83EC 40       sub     esp, 40</span><br><span class="line">01001BCF   .  8B55 0C       mov     edx, dword ptr [ebp+C]           ;  获取mMsg</span><br><span class="line">01001BD2   .  8B4D 14       mov     ecx, dword ptr [ebp+14]</span><br><span class="line">01001BD5   .  53            push    ebx</span><br><span class="line">01001BD6   .  56            push    esi</span><br><span class="line">01001BD7   .  33DB          xor     ebx, ebx</span><br><span class="line">01001BD9   .  57            push    edi</span><br><span class="line">01001BDA   .  BE 00020000   mov     esi, 200</span><br><span class="line">01001BDF   .  43            inc     ebx</span><br><span class="line">01001BE0   .  33FF          xor     edi, edi</span><br><span class="line">01001BE2   .  3BD6          cmp     edx, esi                         ;  mMsg跟状态码200比较 move</span><br><span class="line">01001BE4   .  0F87 75030000 ja      01001F5F                         ;  &gt;200</span><br><span class="line">01001BEA   .  0F84 95040000 je      01002085                         ;  =200</span><br><span class="line">01001BF0   .  B8 00010000   mov     eax, 100</span><br><span class="line">01001BF5   .  3BD0          cmp     edx, eax</span><br><span class="line">01001BF7   .  0F87 5C010000 ja      01001D59</span><br><span class="line">01001BFD   .  0F84 97000000 je      01001C9A</span><br><span class="line">01001C03   .  8BC2          mov     eax, edx</span><br><span class="line">01001C05   .  48            dec     eax                              ;  Switch (cases 2..47)</span><br><span class="line">01001C06   .  48            dec     eax</span><br><span class="line">01001C07   .  74 76         je      short 01001C7F</span><br><span class="line">01001C09   .  83E8 04       sub     eax, 4</span><br><span class="line">01001C0C   .  74 57         je      short 01001C65</span><br><span class="line">01001C0E   .  83E8 09       sub     eax, 9</span><br><span class="line">01001C11   .  74 2B         je      short 01001C3E</span><br><span class="line">01001C13   .  83E8 38       sub     eax, 38</span><br><span class="line">01001C16   .  0F85 742E0000 jnz     01004A90                          ; 此处要走默认过程函数</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">01004A90   &gt; \83FA 10       cmp     edx, 10                          ;  Default case of switch 01001C05</span><br><span class="line">01004A93   .^ 0F85 10D7FFFF jnz     010021A9		     ; 01001C16修改前默认跳转 </span><br><span class="line">01004A99   .  6A 01         push    1                     ; /Style = MB_OKCANCEL|MB_APPLMODAL</span><br><span class="line">01004A9B   .  6A 00         push    0                                ; |Title = NULL</span><br><span class="line">01004A9D   .  68 5A4A0001   push    01004A5A         ; |Text = &quot;是&quot;,B7,&quot;裥枰顺?&quot;,A1,&quot;?,A8,&quot;?3?&quot;，此处在01004A5A 编码写中文提示，push 只是作为参数入栈，可数据窗口编辑或汇编编辑</span><br><span class="line">01004AA2   .  FF75 08       push    dword ptr [ebp+8]                ; |hOwner</span><br><span class="line">01004AA5   .  FF15 B8100001 call    dword ptr [&lt;&amp;USER32.MessageBoxW&gt;&gt;; \MessageBoxW</span><br><span class="line">01004AAB   .  83F8 01       cmp     eax, 1</span><br><span class="line">01004AAE   .^ 0F84 F5D6FFFF je      010021A9</span><br><span class="line">01004AB4   .^ E9 02D7FFFF   jmp     010021BB</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">是否需要退出？</span><br><span class="line">\u662f\u5426\u9700\u8981\u9000\u51fa\uff1f</span><br></pre></td></tr></table></figure>



<p>F9运行程序</p>
<p>1、右键-&gt;窗口-&gt;刷新，可直接跟踪 ClassProc，可直接下断点 111 ，这就是过程函数，<strong>消息断点</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">01004A90   &gt; \83FA 10       cmp edx,0x10                             ;  Default case of switch 01001C05</span><br><span class="line">01004A93   .^ 0F85 10D7FFFF jnz winmine3.010021A9</span><br><span class="line">01004A99   .  6A 01         push 0x1                                 ; /Style = MB_OKCANCEL|MB_APPLMODAL</span><br><span class="line">01004A9B   .  6A 00         push 0x0                                 ; |Title = NULL</span><br><span class="line">01004A9D   .  68 5A4A0001   push winmine3.01004A5A                   ; |Text = &quot;是否需要退出?￡í?3?&quot;</span><br><span class="line">01004AA2   .  FF75 08       push dword ptr ss:[ebp+0x8]              ; |hOwner = NULL</span><br><span class="line">01004AA5   .  FF15 B8100001 call dword ptr ds:[&lt;&amp;USER32.MessageBoxW&gt;&gt;; \MessageBoxW</span><br><span class="line">01004AAB   .  83F8 01       cmp eax,0x1</span><br><span class="line">01004AAE   .^ 0F84 F5D6FFFF je winmine3.010021A9</span><br><span class="line">01004AB4   .^ E9 02D7FFFF   jmp winmine3.010021BB</span><br></pre></td></tr></table></figure>



<p>激活码类型：<br>1、点击按钮获取指定弹框内容（bp GetDlgItemTextA、GetDlgItemTextW）<br>2、消息弹框（MessageBoxA、MessageBoxW）<br>执行到返回，跳过系统自带功能<br>直接搜索错误关键词，运行后 Ultra String Reference<br>查看对比String</p>
<p>点击验证，重点是获取点击事件，触发后续的逻辑</p>
<p>两个框校验key值：<br>1、直接搜索错误关键词，运行后 Ultra String Reference<br>2、F4跳到某地址<br>3、找到corrent前一条（00401642）</p>
<p>根据算法逻辑写注册机：<br>1、新建Win32 App</p>
<p>RadASM</p>
<h2 id="重定位"><a href="#重定位" class="headerlink" title="重定位"></a>重定位</h2><p>重定位：重新定位代码的变量或地址</p>
<p>代码注入exe文件，申请一块内存</p>
<p>用汇编写一个执行文件，注入到扫描.exe里面，代码注入后地址会变化，要动态计算地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">.586</span><br><span class="line">.model flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">   include windows.inc</span><br><span class="line">   include user32.inc</span><br><span class="line">   include kernel32.inc</span><br><span class="line">   </span><br><span class="line">   includelib user32.lib</span><br><span class="line">   includelib kernel32.lib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WinMain proto :DWORD,:DWORD,:DWORD,:DWORD</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">	g_szWinMineCap db &quot;扫雷&quot;, 0 ;这里是窗口名</span><br><span class="line">	g_szUser32 db &quot;user32.dll&quot;, 0</span><br><span class="line">	g_szMessageBox db &quot;MessageBoxA&quot;, 0</span><br><span class="line">.code</span><br><span class="line"></span><br><span class="line">CODE_BEG:</span><br><span class="line">	jmp MSG_CODE</span><br><span class="line">	g_szText db &quot;我注入你了&quot;, 0</span><br><span class="line">	g_szCaption db &quot;温情提示&quot;, 0</span><br><span class="line">	g_pfnMessageBox dd 0</span><br><span class="line"></span><br><span class="line">MSG_CODE:</span><br><span class="line">	int 3</span><br><span class="line">	</span><br><span class="line">	call NEXT  ;把pop ebx指令的地址压栈</span><br><span class="line">NEXT:</span><br><span class="line">	pop ebx   ;pop ebx指令的地址弹栈入ebx</span><br><span class="line">	sub ebx, offset NEXT</span><br><span class="line">	</span><br><span class="line">	push MB_OK</span><br><span class="line">	</span><br><span class="line">	mov eax, offset g_szCaption</span><br><span class="line">	add eax, ebx ;计算变量g_szCaption在新内存中的地址</span><br><span class="line">	push eax</span><br><span class="line">	</span><br><span class="line">	mov eax, offset g_szText</span><br><span class="line">	add eax, ebx ;计算变量e_szText在新内存中的地址</span><br><span class="line">	push eax</span><br><span class="line">	</span><br><span class="line">	push NULL</span><br><span class="line">	</span><br><span class="line">	mov eax, offset g_pfnMessageBox</span><br><span class="line">	add eax, ebx</span><br><span class="line">	call dword ptr [eax]</span><br><span class="line">	</span><br><span class="line">	;call MessageBox</span><br><span class="line">	;invoke MessageBox, NULL, offset g_szText, offset g_szCaption, MB_OK</span><br><span class="line"></span><br><span class="line">CODE_END:</span><br><span class="line">	g_dwCodeSize dd offset CODE_END - offset CODE_BEG</span><br><span class="line"></span><br><span class="line">WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD</span><br><span class="line">	LOCAL @hWndWinmine:HWND</span><br><span class="line">	LOCAL @dwProcId:DWORD</span><br><span class="line">	LOCAL @hProc:HANDLE</span><br><span class="line">	LOCAL @pBuff:LPVOID</span><br><span class="line">	LOCAL @dwBytesWrited:DWORD</span><br><span class="line">	LOCAL @hUser32:HMODULE</span><br><span class="line">	LOCAL @d01dProc:DWORD ;内存权限</span><br><span class="line">	</span><br><span class="line">	invoke LoadLibrary, offset g_szUser32</span><br><span class="line">	mov @hUser32, eax</span><br><span class="line">	</span><br><span class="line">	invoke VirtualProtect, offset g_pfnMessageBox, size g_pfnMessageBox, PAGE_EXECUTE_READWRITE, addr @d01dProc</span><br><span class="line">	</span><br><span class="line">	invoke GetProcAddress, @hUser32, offset g_szMessageBox</span><br><span class="line">	mov g_pfnMessageBox, eax</span><br><span class="line">	</span><br><span class="line">	invoke VirtualProtect, offset g_pfnMessageBox, size g_pfnMessageBox, @d01dProc, addr @d01dProc</span><br><span class="line">	</span><br><span class="line">	invoke FindWindow, NULL, offset g_szWinMineCap</span><br><span class="line">	mov @hWndWinmine, eax</span><br><span class="line">	</span><br><span class="line">	invoke GetWindowThreadProcessId,  @hWndWinmine, addr @dwProcId</span><br><span class="line">	invoke OpenProcess, PROCESS_ALL_ACCESS, FALSE , @dwProcId</span><br><span class="line">	mov @hProc, eax</span><br><span class="line">	</span><br><span class="line">	invoke VirtualAllocEx, @hProc, NULL, 1, MEM_COMMIT, PAGE_EXECUTE_READWRITE</span><br><span class="line">	mov @pBuff, eax</span><br><span class="line"></span><br><span class="line">	invoke WriteProcessMemory, @hProc, @pBuff, offset CODE_BEG, g_dwCodeSize, addr @dwBytesWrited</span><br><span class="line">	</span><br><span class="line">	invoke CreateRemoteThread, @hProc, NULL, 0, @pBuff, NULL, NULL, NULL</span><br><span class="line">	</span><br><span class="line">	xor eax, eax</span><br><span class="line">	ret</span><br><span class="line">WinMain endp</span><br><span class="line"></span><br><span class="line">; ---------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start:	</span><br><span class="line">	invoke WinMain, NULL,NULL,NULL, SW_SHOWDEFAULT</span><br><span class="line">	invoke ExitProcess,eax</span><br><span class="line"></span><br><span class="line">end start</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代码注入器</p>
<p>汇编库：<br>oddisasm<br>xedparse(x64)<br>asmjit(1)</p>
<p>植物大战僵尸加方格</p>
<h2 id="API-hock"><a href="#API-hock" class="headerlink" title="API hock"></a>API hock</h2><p>comexplorer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat, stdcall  ;32 bit memory model</span><br><span class="line">option casemap :none  ;case sensitive</span><br><span class="line"></span><br><span class="line">include windows.inc</span><br><span class="line">include kernel32.inc</span><br><span class="line">include user32.inc</span><br><span class="line"></span><br><span class="line">includelib kernel32.lib</span><br><span class="line">includelib user32.lib</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">	g_szUser32 db &quot;user32&quot;, 0</span><br><span class="line">	g_szMessageBoxA db &quot;MessageBoxA&quot;, 0</span><br><span class="line">	g_szNewTitle db &quot;这个标题被我占用了，哈哈&quot;, 0</span><br><span class="line">	g_pfnMessageBoxA dd 0</span><br><span class="line">	g_bIsSelfCall dd FALSE</span><br><span class="line">	;1、注入原生user.dll的messageboxA函数，注入后messagebox第一跳就会变成跳转指定地址，要修改的指令地址赋给ebx，再通过ptr修改指定地址的值</span><br><span class="line">	;2、</span><br><span class="line">.code</span><br><span class="line"></span><br><span class="line">;要跳转的地址</span><br><span class="line">HOOKCODE:</span><br><span class="line">	.if g_bIsSelfCall == TRUE</span><br><span class="line">		jmp OLDCODE</span><br><span class="line">	.endif</span><br><span class="line">	</span><br><span class="line">	;重入问题  api hook就是调用程序原有的API  再弹出原先窗口前再弹一个  钩子库？？detours</span><br><span class="line">	mov g_bIsSelfCall, TRUE</span><br><span class="line">	invoke MessageBox, NULL, offset g_szUser32, offset g_szMessageBoxA, MB_OK</span><br><span class="line">	mov g_bIsSelfCall, FALSE</span><br><span class="line">	</span><br><span class="line">	mov dword ptr [esp+0ch], offset g_szNewTitle</span><br><span class="line"></span><br><span class="line">OLDCODE:</span><br><span class="line">	;跳回去</span><br><span class="line">	mov eax, g_pfnMessageBoxA</span><br><span class="line">	add eax, 5 ;下一条指令</span><br><span class="line">	</span><br><span class="line">	;调用被破坏掉的代码</span><br><span class="line">	push ebp</span><br><span class="line">	mov ebp, esp</span><br><span class="line">	</span><br><span class="line">	jmp eax</span><br><span class="line"></span><br><span class="line">InstallHook proc uses ebx</span><br><span class="line">	LOCAL @hUser32:HMODULE</span><br><span class="line">	LOCAL @dw01dProc:DWORD</span><br><span class="line">	</span><br><span class="line">	;int 3</span><br><span class="line">	</span><br><span class="line">	;获取User32</span><br><span class="line">	invoke GetModuleHandle, offset g_szUser32</span><br><span class="line">	mov @hUser32, eax</span><br><span class="line">	</span><br><span class="line">	;获取User32的messagebox</span><br><span class="line">	invoke GetProcAddress, @hUser32, offset g_szMessageBoxA</span><br><span class="line">	mov g_pfnMessageBoxA, eax</span><br><span class="line">	</span><br><span class="line">	;计算跳转偏移</span><br><span class="line">	mov eax, offset HOOKCODE</span><br><span class="line">	sub eax, g_pfnMessageBoxA</span><br><span class="line">	sub eax, 5</span><br><span class="line">	</span><br><span class="line">	push eax</span><br><span class="line">	invoke VirtualProtect,g_pfnMessageBoxA,1,PAGE_EXECUTE_READWRITE,addr @dw01dProc</span><br><span class="line">	pop eax</span><br><span class="line">	</span><br><span class="line">	;修改跳转，怎么指定修改的指令的messagebox的第一行</span><br><span class="line">	mov ebx, g_pfnMessageBoxA ; 保存基址信息</span><br><span class="line">	mov byte ptr[ebx], 0e9h  ; 0xE9是JMP机器码   后面的四个字节是偏移</span><br><span class="line">	mov dword ptr[ebx+1], eax  ; e9后面的四个字节是一个偏移地址    偏移地址=目的地址-跳转基地址(jmp的下一条指令的地址）</span><br><span class="line">	</span><br><span class="line">	invoke VirtualProtect,g_pfnMessageBoxA,1,@dw01dProc,addr @dw01dProc</span><br><span class="line">	</span><br><span class="line">	ret</span><br><span class="line">InstallHook endp</span><br><span class="line"></span><br><span class="line">DllMain proc hinstDLL:HINSTANCE, fdwReason:DWORD, lpvReserved:LPVOID</span><br><span class="line">	.if fdwReason == DLL_PROCESS_ATTACH ;首次加载dll自动就执行installHook了</span><br><span class="line">		invoke InstallHook</span><br><span class="line">	.endif</span><br><span class="line">	mov eax, TRUE</span><br><span class="line">	ret</span><br><span class="line">DllMain endp</span><br><span class="line">end DllMain</span><br><span class="line"></span><br><span class="line">; remotedll</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">user.dll里面默认messagebox的实现</span><br><span class="line">760C15F0 USER32.MessageBoxA       8BFF            mov     edi, edi</span><br><span class="line">760C15F2                          55              push    ebp</span><br><span class="line">760C15F3                          8BEC            mov     ebp, esp</span><br><span class="line">760C15F5                          833D 946C0E76 0&gt;cmp     dword ptr [760E6C94], 0</span><br><span class="line">760C15FC                          74 22           je      short 760C1620</span><br><span class="line">760C15FE                          64:A1 18000000  mov     eax, dword ptr fs:[18]</span><br><span class="line">760C1604                          BA BC710E76     mov     edx, 760E71BC</span><br><span class="line">760C1609                          8B48 24         mov     ecx, dword ptr [eax+24]</span><br><span class="line">760C160C                          33C0            xor     eax, eax</span><br><span class="line">760C160E                          F0:0FB10A       lock cmpxchg dword ptr [edx], ecx</span><br><span class="line">760C1612                          85C0            test    eax, eax</span><br><span class="line">760C1614                          75 0A           jnz     short 760C1620</span><br><span class="line">760C1616                          C705 006D0E76 0&gt;mov     dword ptr [760E6D00], 1</span><br><span class="line">760C1620                          6A FF           push    -1</span><br><span class="line">760C1622                          6A 00           push    0</span><br><span class="line">760C1624                          FF75 14         push    dword ptr [ebp+14]</span><br><span class="line">760C1627                          FF75 10         push    dword ptr [ebp+10]</span><br><span class="line">760C162A                          FF75 0C         push    dword ptr [ebp+C]</span><br><span class="line">760C162D                          FF75 08         push    dword ptr [ebp+8]</span><br><span class="line">760C1630                          E8 3B020000     call    MessageBoxTimeoutA</span><br><span class="line">760C1635                          5D              pop     ebp</span><br><span class="line">760C1636                          C2 1000         retn    10</span><br><span class="line"></span><br><span class="line">;注入后变成</span><br><span class="line">760C15F0 USER32.MessageBoxA     - E9 0BFAF399     jmp     10001000</span><br><span class="line">760C15F5                          833D 946C0E76 0&gt;cmp     dword ptr [760E6C94], 0</span><br><span class="line">760C15FC                          74 22           je      short 760C1620</span><br><span class="line">760C15FE                          64:A1 18000000  mov     eax, dword ptr fs:[18]</span><br><span class="line">760C1604                          BA BC710E76     mov     edx, 760E71BC</span><br><span class="line">760C1609                          8B48 24         mov     ecx, dword ptr [eax+24]</span><br><span class="line">760C160C                          33C0            xor     eax, eax</span><br><span class="line">760C160E                          F0:0FB10A       lock cmpxchg dword ptr [edx], ecx</span><br><span class="line">760C1612                          85C0            test    eax, eax</span><br><span class="line">760C1614                          75 0A           jnz     short 760C1620</span><br><span class="line">760C1616                          C705 006D0E76 0&gt;mov     dword ptr [760E6D00], 1</span><br><span class="line">760C1620                          6A FF           push    -1</span><br><span class="line">760C1622                          6A 00           push    0</span><br><span class="line">760C1624                          FF75 14         push    dword ptr [ebp+14]</span><br><span class="line">760C1627                          FF75 10         push    dword ptr [ebp+10]</span><br><span class="line">760C162A                          FF75 0C         push    dword ptr [ebp+C]</span><br><span class="line">760C162D                          FF75 08         push    dword ptr [ebp+8]</span><br><span class="line">760C1630                          E8 3B020000     call    MessageBoxTimeoutA</span><br><span class="line">760C1635                          5D              pop     ebp</span><br><span class="line">760C1636                          C2 1000         retn    10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10001000                  8BC0            mov     eax, eax</span><br><span class="line">10001002                  C74424 0C 13300&gt;mov     dword ptr [esp+C], 10003013</span><br><span class="line">1000100A                  A1 2C300010     mov     eax, dword ptr [1000302C]</span><br><span class="line">1000100F                  83C0 05         add     eax, 5</span><br><span class="line">10001012                  55              push    ebp</span><br><span class="line">10001013                  8BEC            mov     ebp, esp</span><br><span class="line">10001015                  FFE0            jmp     eax</span><br><span class="line">10001017                  55              push    ebp</span><br><span class="line">10001018                  8BEC            mov     ebp, esp</span><br><span class="line">1000101A                  83C4 F8         add     esp, -8</span><br><span class="line">1000101D                  53              push    ebx</span><br><span class="line">1000101E                  68 00300010     push    10003000; ASCII &quot;user32&quot;</span><br><span class="line">10001023                  E8 72000000     call    1000109A; jmp 到 KERNEL32.GetModuleHandleA</span><br><span class="line">10001028                  8945 FC         mov     dword ptr [ebp-4], eax</span><br><span class="line">1000102B                  68 07300010     push    10003007; ASCII &quot;MessageBoxA&quot;</span><br><span class="line">10001030                  FF75 FC         push    dword ptr [ebp-4]</span><br><span class="line">10001033                  E8 68000000     call    100010A0; jmp 到 KERNEL32.GetProcAddress</span><br><span class="line">10001038                  A3 2C300010     mov     dword ptr [1000302C], eax</span><br><span class="line">1000103D                  B8 00100010     mov     eax, 10001000</span><br><span class="line">10001042                  2B05 2C300010   sub     eax, dword ptr [1000302C]; USER32.MessageBoxA</span><br><span class="line">10001048                  83E8 05         sub     eax, 5</span><br><span class="line">1000104B                  50              push    eax</span><br><span class="line">1000104C                  8D45 F8         lea     eax, dword ptr [ebp-8]</span><br><span class="line">1000104F                  50              push    eax</span><br><span class="line">10001050                  6A 40           push    40</span><br><span class="line">10001052                  6A 01           push    1</span><br><span class="line">10001054                  FF35 2C300010   push    dword ptr [1000302C]; USER32.MessageBoxA</span><br><span class="line">1000105A                  E8 47000000     call    100010A6; jmp 到 KERNEL32.VirtualProtect</span><br><span class="line">1000105F                  58              pop     eax</span><br><span class="line">10001060                  8B1D 2C300010   mov     ebx, dword ptr [1000302C]; USER32.MessageBoxA</span><br><span class="line">10001066                  C603 E9         mov     byte ptr [ebx], 0E9</span><br><span class="line">10001069                  8943 01         mov     dword ptr [ebx+1], eax</span><br><span class="line">1000106C                  8D45 F8         lea     eax, dword ptr [ebp-8]</span><br><span class="line">1000106F                  50              push    eax</span><br><span class="line">10001070                  FF75 F8         push    dword ptr [ebp-8]</span><br><span class="line">10001073                  6A 01           push    1</span><br><span class="line">10001075                  FF35 2C300010   push    dword ptr [1000302C]; USER32.MessageBoxA</span><br><span class="line">1000107B                  E8 26000000     call    100010A6; jmp 到 KERNEL32.VirtualProtect</span><br><span class="line">10001080                  5B              pop     ebx</span><br><span class="line">10001081                  C9              leave</span><br><span class="line">10001082                  C3              retn</span><br></pre></td></tr></table></figure>



<h2 id="钢琴和筛选器异常"><a href="#钢琴和筛选器异常" class="headerlink" title="钢琴和筛选器异常"></a>钢琴和筛选器异常</h2><p>筛选器异常 &#x2F; 最终异常</p>
<p>setUnhand</p>
<p>dump文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">.586</span><br><span class="line">.model flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">   include windows.inc</span><br><span class="line">   include user32.inc</span><br><span class="line">   include kernel32.inc</span><br><span class="line">   </span><br><span class="line">   includelib user32.lib</span><br><span class="line">   includelib kernel32.lib</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">	g_szMsg  db &quot;异常来了,是否跳过异常？&quot;, 0</span><br><span class="line">	g_szTxt  db &quot;没有发现CC断点&quot;, 0</span><br><span class="line">	g_szTip  db &quot;发现CC断点&quot;, 0</span><br><span class="line">.code</span><br><span class="line"></span><br><span class="line">MyUnhandledExceptionFilter proc pEP:ptr EXCEPTION_POINTERS</span><br><span class="line">	LOCAL @pEr:ptr EXCEPTION_RECORD</span><br><span class="line">	LOCAL @pCtx:ptr CONTEXT</span><br><span class="line">	</span><br><span class="line">	mov ebx, pEP</span><br><span class="line">	assume ebx:ptr EXCEPTION_POINTERS</span><br><span class="line">	mov eax, [ebx].pExceptionRecord</span><br><span class="line">	mov @pEr, eax</span><br><span class="line">	</span><br><span class="line">	mov eax, [ebx].ContextRecord</span><br><span class="line">	mov @pCtx, eax</span><br><span class="line">	</span><br><span class="line">	mov ebx, @pEr</span><br><span class="line">	assume ebx:ptr EXCEPTION_RECORD</span><br><span class="line">	</span><br><span class="line">	mov esi, @pCtx</span><br><span class="line">	assume esi:ptr CONTEXT</span><br><span class="line"></span><br><span class="line">	.if [ebx].ExceptionCode == EXCEPTION_ACCESS_VIOLATION</span><br><span class="line">		add [esi].regEip, 2</span><br><span class="line">		;设置TF标志位，继续执行</span><br><span class="line">		or [esi].regFlag,100h</span><br><span class="line">	.elseif [ebx].ExceptionCode == EXCEPTION_SINGLE_STEP</span><br><span class="line">		;&#x27;判断是否有CC</span><br><span class="line">		mov eax, [esi].regEip</span><br><span class="line">		;invoke MessageBox, NULL,addr byte ptr [eax] , NULL, MB_OK</span><br><span class="line">		;ret</span><br><span class="line">		.if byte ptr [eax] == 033h ;0cch</span><br><span class="line">			invoke MessageBox, NULL,offset g_szTip, NULL, MB_OK</span><br><span class="line">			mov eax, EXCEPTION_EXECUTE_HANDLER</span><br><span class="line">			ret</span><br><span class="line">		.endif</span><br><span class="line">		</span><br><span class="line">		;没有到达代码结束位置</span><br><span class="line">		.if[esi].regEip != offset CODE_END</span><br><span class="line">			;没有发现CC，继续单步</span><br><span class="line">			or [esi].regFlag, 100h</span><br><span class="line">		.endif</span><br><span class="line">	.endif</span><br><span class="line">	</span><br><span class="line">	assume esi:nothing</span><br><span class="line">	assume ebx:nothing</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	mov eax, EXCEPTION_CONTINUE_EXECUTION ;程序继续执行</span><br><span class="line">	</span><br><span class="line">	ret</span><br><span class="line">MyUnhandledExceptionFilter endp</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	;28</span><br><span class="line">	invoke SetUnhandledExceptionFilter, offset MyUnhandledExceptionFilter</span><br><span class="line">	</span><br><span class="line">	xor eax, 8</span><br><span class="line">	mov eax, [eax]</span><br><span class="line"></span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	xor eax, eax</span><br><span class="line">	</span><br><span class="line">CODE_END:</span><br><span class="line">	invoke MessageBox, NULL, offset g_szTxt, NULL, MB_OK</span><br><span class="line">	invoke ExitProcess,eax</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>exe程序<br>1、修改程序自身汇编代码（加个弹窗提示）<br>2、根据程序的算法逻辑写注册机（编写ASM程序）<br>3、编写汇编直接注入对应程序（代码&#x2F;工具），汇编库就是写C程序调用汇编对应API<br>4、编写DLL(汇编)，用DLL注入工具</p>
<h2 id="windbg"><a href="#windbg" class="headerlink" title="windbg"></a>windbg</h2><p>一般断点，把打断点处的第一个字节替换成 cc</p>
<p>代码同上</p>
<p>TF标志位置1断点</p>
<p>异常错误码</p>
<p>配置环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_NT_SYMBOL_PATH</span><br><span class="line">srv*C:\symbolslocal*https://msdl.microsoft.com/download/symbols</span><br></pre></td></tr></table></figure>

<p>1、源码调试（汇编源码&#x2F;C语言源码）必须有pdb文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bl 查看断点</span><br><span class="line">bc 3-255 取消断点</span><br><span class="line">bp user32!CreateWindowExA</span><br><span class="line">bm user32!Create*A</span><br><span class="line">bu 延迟断点，未加载的DLL函数</span><br><span class="line">$exentry 程序入口点</span><br><span class="line"></span><br><span class="line">teb thread environment block(结构体)</span><br><span class="line">dt _teb ;名称粉碎</span><br><span class="line">dt 00338000 _teb</span><br><span class="line"></span><br><span class="line">dt _PEB </span><br><span class="line"></span><br><span class="line">!teb</span><br><span class="line">!peb</span><br></pre></td></tr></table></figure>



<p>sehf</p>
<p>结构化异常处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">异常处理:</span><br><span class="line">-&gt; 调试器 -&gt; SEH -&gt; 调试器 -&gt; 筛选器 -&gt;系统</span><br><span class="line">SEH在筛选器前处理</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">.586</span><br><span class="line">.model flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">   include windows.inc</span><br><span class="line">   include user32.inc</span><br><span class="line">   include kernel32.inc</span><br><span class="line">   </span><br><span class="line">   includelib user32.lib</span><br><span class="line">   includelib kernel32.lib</span><br><span class="line"></span><br><span class="line">Node struct </span><br><span class="line">	next dd 0</span><br><span class="line">	handler dd 0</span><br><span class="line">Node ends</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">	g_sz0 db &quot; 0 异常来了&quot;, 0</span><br><span class="line">	g_sz1 db &quot;1 异常来了&quot;, 0</span><br><span class="line">.code </span><br><span class="line"></span><br><span class="line">Handler1 proc pER:ptr EXCEPTION_RECORD, pEstablisherFrame:DWORD, pCtx:ptr CONTEXT, pDispatcherContext:DWORD</span><br><span class="line">	mov ebx, pER</span><br><span class="line">	assume ebx:ptr EXCEPTION_RECORD</span><br><span class="line">	</span><br><span class="line">	mov esi,pCtx</span><br><span class="line">	assume esi:ptr CONTEXT</span><br><span class="line">	</span><br><span class="line">	invoke MessageBox,NULL,offset g_sz1, NULL,MB_OK</span><br><span class="line">	</span><br><span class="line">	.if [ebx].ExceptionCode == EXCEPTION_INT_DIVIDE_BY_ZERO</span><br><span class="line">		add[esi].regEip,2</span><br><span class="line">	.elseif[ebx].ExceptionCode == EXCEPTION_ACCESS_VIOLATION</span><br><span class="line">		mov eax,ExceptionContinueSearch</span><br><span class="line">		ret</span><br><span class="line">	.endif</span><br><span class="line">	</span><br><span class="line">	assume ebx:nothing</span><br><span class="line">	assume esi:nothing</span><br><span class="line">	</span><br><span class="line">	mov eax, ExceptionContinueExecution </span><br><span class="line">	ret</span><br><span class="line">Handler1 endp</span><br><span class="line"></span><br><span class="line">Func1 proc</span><br><span class="line">	LOCAL @node:Node</span><br><span class="line">	</span><br><span class="line">	mov @node.handler, offset Handler1</span><br><span class="line">	</span><br><span class="line">	;安装SEH</span><br><span class="line">	assume fs:nothing</span><br><span class="line">	mov eax,fs:[0]</span><br><span class="line">	mov @node.next,eax</span><br><span class="line">	</span><br><span class="line">	lea eax,@node</span><br><span class="line">	mov fs:[0], eax</span><br><span class="line"></span><br><span class="line">	xor esi, esi</span><br><span class="line">	div esi  ;赋0异常</span><br><span class="line">	</span><br><span class="line">	xor eax,eax</span><br><span class="line">	mov [eax],eax ;内存访问异常</span><br><span class="line">	</span><br><span class="line">	;卸掉SEH</span><br><span class="line">	mov eax, @node.next</span><br><span class="line">	mov fs:[0], eax</span><br><span class="line"></span><br><span class="line">	ret</span><br><span class="line">Func1 endp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Handler0 proc pER:ptr EXCEPTION_RECORD, pEstablisherFrame:DWORD, pCtx:ptr CONTEXT, pDispatcherContext:DWORD</span><br><span class="line">	mov ebx, pER</span><br><span class="line">	assume ebx:ptr EXCEPTION_RECORD</span><br><span class="line">	</span><br><span class="line">	mov esi,pCtx</span><br><span class="line">	assume esi:ptr CONTEXT</span><br><span class="line">	</span><br><span class="line">	invoke MessageBox,NULL, offset g_sz0,NULL,MB_OK</span><br><span class="line">	</span><br><span class="line">	.if [ebx].ExceptionCode == EXCEPTION_ACCESS_VIOLATION</span><br><span class="line">		add [esi].regEip,2</span><br><span class="line">	.endif</span><br><span class="line">	</span><br><span class="line">	assume ebx:nothing</span><br><span class="line">	assume esi:nothing</span><br><span class="line">	</span><br><span class="line">	mov eax,ExceptionContinueExecution</span><br><span class="line">	;mov eax，ExceptionContinueSearch：交给调试器或者筛选器处理</span><br><span class="line">	ret</span><br><span class="line">Handler0 endp</span><br><span class="line"></span><br><span class="line">Func0 proc </span><br><span class="line">	LOCAL @node:Node</span><br><span class="line">	</span><br><span class="line">	mov @node.handler, offset Handler0</span><br><span class="line">	</span><br><span class="line">	;安装SEH</span><br><span class="line">	assume fs:nothing</span><br><span class="line">	mov eax, fs:[0]</span><br><span class="line">	mov @node.next, eax</span><br><span class="line">	</span><br><span class="line">	lea eax, @node</span><br><span class="line">	mov fs:[0],eax  ;安装异常，安装在这个函数</span><br><span class="line">	</span><br><span class="line">	invoke Func1</span><br><span class="line">	</span><br><span class="line">	xor eax,eax</span><br><span class="line">	mov [eax],eax ;内存访问异常</span><br><span class="line">	</span><br><span class="line">	;卸掉SEH</span><br><span class="line">	mov eax, @node.next</span><br><span class="line">	mov fs:[0], eax</span><br><span class="line">	</span><br><span class="line">	ret</span><br><span class="line">Func0 endp</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line">	invoke Func0</span><br><span class="line">	invoke MessageBox,NULL,NULL,NULL,MB_OK</span><br><span class="line">	</span><br><span class="line">	xor eax, eax</span><br><span class="line">	invoke ExitProcess,eax</span><br><span class="line">end start</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>RadASM 工程选项<br>-&gt; 编译  &#x2F;Zi<br>-&gt; 链接  &#x2F;debug &#x2F;pdb:”TestSEH.pdb”</p>
<p>生成pdb能在调试过程中更清楚地看函数</p>
<h2 id="OD插件"><a href="#OD插件" class="headerlink" title="OD插件"></a>OD插件</h2><p>OD插件都是DLL文件，创建动态链接库<br>比如：OD开启时加载插件DLL，修改某个异常判断的地址，从而修改异常处理机制<br>修改异常派发<br>OD插件都是DLL文件，<strong>创建动态链接库</strong></p>
<h3 id="异常处理插件"><a href="#异常处理插件" class="headerlink" title="异常处理插件"></a>异常处理插件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kernelbase -&gt; UnhandledExceptionFilter </span><br><span class="line">(UnhandledExceptionFilter)</span><br><span class="line">76F722A0 </span><br><span class="line">找到异常处理分支，查找跳，不抛给调试工具处理，返回给程序本身处理</span><br><span class="line">(关键跳)</span><br><span class="line">76F7235D   /0F84 E6000000   je      76F72449</span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/57.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/58.png" class title="This is an example image">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Plugin.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ollydbg.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ODBG_Plugindata</span><span class="params">(<span class="type">char</span>* shortname)</span></span><br><span class="line">&#123;</span><br><span class="line">    strcpy_s(shortname, <span class="number">31</span>, <span class="string">&quot;od测试插件&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> PLUGIN_VERSION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ODBG_Plugininit</span><span class="params">(<span class="type">int</span> ollydbgversion, HWND hw, ulong* features)</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ODBG_Paused</span><span class="params">(<span class="type">int</span> reason, t_reg* reg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (reason == PP_EVENT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//获取unhandle的地址</span></span><br><span class="line">        <span class="comment">//字符集问题，项目-&gt;项目名-&gt;高级-&gt;字符集</span></span><br><span class="line">        HMODULE hKernel = GetModuleHandle(<span class="string">&quot;kernelbase.dll&quot;</span>); </span><br><span class="line">        LPBYTE pAddr = (LPBYTE)GetProcAddress(hKernel, <span class="string">&quot;UnhandledExceptionFilter&quot;</span>);</span><br><span class="line">        <span class="comment">//定位跳转</span></span><br><span class="line">        <span class="comment">//76F7235D - 76F722A0 + 1</span></span><br><span class="line">        pAddr += <span class="number">0xBE</span>;</span><br><span class="line">        BYTE btCode = <span class="number">0x84</span>; </span><br><span class="line">        Writememory(&amp;btCode, (ulong)pAddr, <span class="keyword">sizeof</span>(btCode), MM_SILENT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">//修改内存属性需要申请权限</span></span><br><span class="line"><span class="comment">DWORD dwOldProC = 0;</span></span><br><span class="line"><span class="comment">VirtualProtect(pAddr, 1, PAGE_EXECUTE_READWRITE, &amp;dwOldProC);</span></span><br><span class="line"><span class="comment">//jnz修改为jz</span></span><br><span class="line"><span class="comment">//调试问题，项目-&gt;项目名-&gt;调试-&gt;命令-&gt;ODexe</span></span><br><span class="line"><span class="comment">*pAddr = 0x84;</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//改错进程，改成OD自己的地址，要改被调试程序</span></span><br><span class="line"><span class="comment">//还要注意调用时机,选合适的回调(触发)函数</span></span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">( HMODULE hModule,DWORD  ul_reason_for_call,LPVOID lpReserved)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PS：右键分析代码</p>
<h3 id="进程跟踪地址错误"><a href="#进程跟踪地址错误" class="headerlink" title="进程跟踪地址错误"></a>进程跟踪地址错误</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Plugin.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ollydbg.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">DWORD</span><br><span class="line">WINAPI</span><br><span class="line"><span class="title function_">MyGetClassLongA</span><span class="params">(_In_ HWND hWnd,</span></span><br><span class="line"><span class="params">                _In_ <span class="type">int</span> nIndex)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (IsWindowUnicode(hWnd)) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> GetClassLongW(hWnd, nIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> GetClassLongA(hWnd, nIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 01.42</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ODBG_Plugindata</span><span class="params">(<span class="type">char</span>* shortname)</span></span><br><span class="line">&#123;</span><br><span class="line">    strcpy_s(shortname, <span class="number">31</span>, <span class="string">&quot;od测试插件2&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> PLUGIN_VERSION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ODBG_Plugininit</span><span class="params">(<span class="type">int</span> ollydbgversion, HWND hw, ulong* features)</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD dwOldProc = <span class="number">0</span>;</span><br><span class="line">    LPDWORD pAddrToGetCL = (LPDWORD)<span class="number">0x0050D858</span>;</span><br><span class="line">    VirtualProtect(pAddrToGetCL,<span class="keyword">sizeof</span>(DWORD),PAGE_EXECUTE_READWRITE, &amp;dwOldProc);</span><br><span class="line">    </span><br><span class="line">    *pAddrToGetCL = (DWORD)MyGetClassLongA;</span><br><span class="line">    </span><br><span class="line">    VirtualProtect(pAddrToGetCL, <span class="keyword">sizeof</span>(DWORD),dwOldProc,&amp;dwOldProc);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ODBG_Paused</span><span class="params">(<span class="type">int</span> reason, t_reg* reg)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="调试框架"><a href="#调试框架" class="headerlink" title="调试框架"></a>调试框架</h2><p>为什么写汇编代码调用的是 win32的 API？（win32是桌面应用程序的底层接口吗）</p>
<p>事件驱动，消息响应</p>
<p>1、建立调试会话<br>    CreateProcess<br>    DebugActiveProcess<br>2、循环接受调试事件<br>    waitForDebugEvent<br>3、处理调试事件<br>4、提交处理结果<br>    ContinueDebugEvent</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat, stdcall  ;32 bit memory model</span><br><span class="line">option casemap :none  ;case sensitive</span><br><span class="line"></span><br><span class="line">include DBG.inc</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">	g_szExePath db &quot;winmine.exe&quot;, 0</span><br><span class="line">	g_szEXCEPTION_DEBUG_EVENT 	    db &quot;EXCEPTION_DEBUG_EVENT&quot;, 0dh,0ah,0</span><br><span class="line">	g_szCREATE_THREAD_DEBUG_EVENT   db &quot;CREATE_THREAD_DEBUG_EVENT&quot;,0dh,0ah,0</span><br><span class="line">	g_szCREATE_PROCESS_DEBUG_EVENT db &quot;CREATE_PROCESS_DEBUG_EVENT&quot;,0dh,0ah,0</span><br><span class="line">	g_szEXIT_THREAD_DEBUG_EVENT 	    db &quot;EXIT_THREAD_DEBUG_EVENT&quot;,0dh,0ah,0</span><br><span class="line">	g_szEXIT_PROCESS_DEBUG_EVENT 	    db &quot;EXCEPTION_DEBUG_EVENT&quot;,0dh,0ah,0</span><br><span class="line">	g_szLOAD_DLL_DEBUG_EVENT 	    db &quot;LOAD_DLL_DEBUG_EVENTO&quot;, 0dh,0ah,0</span><br><span class="line">	g_szUNLOAD_DLL_DEBUG_EVENT 	    db &quot;UNLOAD_DLL _DEBUG_EVENT&quot;,0dh,0ah,0</span><br><span class="line">	g_szOUTPUT_DEBUG_STRING_EVENT  db &quot;OUTPUT_DEBUG_STRING_EVENT&quot;,0dh,0ah,0</span><br><span class="line">	</span><br><span class="line">	g_szFmtCreateProcess db &quot;BaseOfImage:%08X, StartAddress:%08X&quot;, 0dh,0ah,&quot;ImageName:%s&quot;,0dh, 0ah, 0</span><br><span class="line">	g_szFmtLoadDlls db &quot;Base0fDll:%08X, ImageName:%s&quot;,0dh,0ah,0</span><br><span class="line">	g_szFmtLoadDllx db &quot;Base0fDll:%08X, ImageName:%08X&quot;,0dh,0ah,0</span><br><span class="line">.code</span><br><span class="line"></span><br><span class="line">OnLoadDll proc pDE:ptr DEBUG_EVENT</span><br><span class="line">	LOCAL @dwAddrOfName:DWORD</span><br><span class="line">	LOCAL @hProcess:HANDLE</span><br><span class="line">	LOCAL @dwPid:DWORD</span><br><span class="line">	LOCAL @dwBytesReaded:DWORD</span><br><span class="line">	LOCAL @szwBuf[MAX_PATH]:word</span><br><span class="line">	LOCAL @szBuf[MAX_PATH]:byte</span><br><span class="line"></span><br><span class="line">	mov esi, pDE</span><br><span class="line">	assume esi:ptr DEBUG_EVENT</span><br><span class="line">	mov eax,[esi].dwProcessId</span><br><span class="line">	mov @dwPid, eax</span><br><span class="line">	</span><br><span class="line">	lea esi,[esi].u.LoadDll</span><br><span class="line">	assume esi:ptr LOAD_DLL_DEBUG_INFO</span><br><span class="line">	</span><br><span class="line">	invoke OpenProcess,PROCESS_ALL_ACCESS,FALSE,@dwPid</span><br><span class="line">	.if eax == NULL</span><br><span class="line">		mov eax,DBG_CONTINUE</span><br><span class="line">		ret</span><br><span class="line">	.endif</span><br><span class="line">	mov @hProcess, eax</span><br><span class="line">	</span><br><span class="line">	invoke ReadProcessMemory, @hProcess,[esi]. lpImageName, addr @dwAddrOfName,sizeof @dwAddrOfName,addr @dwBytesReaded</span><br><span class="line">	.if eax == FALSE</span><br><span class="line">		invoke crt_printf, offset g_szFmtLoadDllx, [esi].lpBaseOfDll, [esi].lpImageName</span><br><span class="line">		mov eax,DBG_CONTINUE</span><br><span class="line">		ret</span><br><span class="line">	.endif</span><br><span class="line"> </span><br><span class="line"> 	.if [esi].fUnicode</span><br><span class="line"> 		invoke ReadProcessMemory, @hProcess, @dwAddrOfName, addr @szwBuf, MAX_PATH, addr @dwBytesReaded</span><br><span class="line"> 		invoke WideCharToMultiByte, CP_ACP,0, addr @szwBuf, MAX_PATH, addr @szBuf,MAX_PATH, NULL, NULL</span><br><span class="line"> 	.else</span><br><span class="line"> 		invoke ReadProcessMemory,@hProcess, @dwAddrOfName, addr @szBuf, MAX_PATH, addr @dwBytesReaded</span><br><span class="line"> 	.endif</span><br><span class="line">	</span><br><span class="line">	invoke crt_printf, offset g_szFmtLoadDlls, [esi].lpBaseOfDll, addr @szBuf</span><br><span class="line">	</span><br><span class="line">	assume esi:nothing</span><br><span class="line">	</span><br><span class="line">	mov eax,DBG_CONTINUE</span><br><span class="line">	</span><br><span class="line">	ret</span><br><span class="line">OnLoadDll endp</span><br><span class="line"></span><br><span class="line">OnCreateProcess proc pDE:ptr DEBUG_EVENT</span><br><span class="line">	mov esi, pDE</span><br><span class="line">	assume esi:ptr DEBUG_EVENT</span><br><span class="line">	lea esi,[esi].u.CreateProcessInfo</span><br><span class="line">	assume esi:ptr CREATE_PROCESS_DEBUG_INFO</span><br><span class="line"></span><br><span class="line">	invoke crt_printf, offset g_szCREATE_PROCESS_DEBUG_EVENT</span><br><span class="line">	invoke crt_printf,offset g_szFmtCreateProcess,[esi].lpBaseOfImage,[esi].lpStartAddress,[esi].lpImageName</span><br><span class="line">	</span><br><span class="line">	assume esi:nothing	</span><br><span class="line">	</span><br><span class="line">	mov eax, DBG_CONTINUE</span><br><span class="line">	ret</span><br><span class="line">OnCreateProcess endp</span><br><span class="line"></span><br><span class="line">main proc</span><br><span class="line">	LOCAL @si:STARTUPINFO</span><br><span class="line">	LOCAL @pi:PROCESS_INFORMATION</span><br><span class="line">	LOCAL @de:DEBUG_EVENT</span><br><span class="line">	LOCAL @dwContinueStatus:DWORD</span><br><span class="line">	</span><br><span class="line">	invoke RtlZeroMemory,addr @si,sizeof @si</span><br><span class="line">	invoke RtlZeroMemory,addr @pi,sizeof @pi</span><br><span class="line">	</span><br><span class="line">	mov @si. cb, sizeof @si</span><br><span class="line">	</span><br><span class="line">	mov @dwContinueStatus, DBG_CONTINUE</span><br><span class="line"></span><br><span class="line">	;建立调试会话</span><br><span class="line">	invoke CreateProcess,offset g_szExePath, NULL, NULL, NULL, FALSE, DEBUG_ONLY_THIS_PROCESS, NULL, NULL, addr @si, addr @pi</span><br><span class="line">	.if eax == FALSE </span><br><span class="line">		ret</span><br><span class="line">	.endif</span><br><span class="line"></span><br><span class="line">	.while TRUE</span><br><span class="line">		invoke WaitForDebugEvent,addr @de,INFINITE</span><br><span class="line">		.if eax == FALSE</span><br><span class="line">			.continue</span><br><span class="line">		.endif</span><br><span class="line">		</span><br><span class="line">		.if @de.dwDebugEventCode == EXCEPTION_DEBUG_EVENT</span><br><span class="line">			invoke crt_printf,offset g_szEXCEPTION_DEBUG_EVENT</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line">		.elseif @de.dwDebugEventCode == CREATE_THREAD_DEBUG_EVENT</span><br><span class="line">			invoke crt_printf, offset g_szCREATE_THREAD_DEBUG_EVENT</span><br><span class="line">			</span><br><span class="line">		.elseif @de.dwDebugEventCode == CREATE_PROCESS_DEBUG_EVENT</span><br><span class="line">			invoke OnCreateProcess, addr @de</span><br><span class="line">			mov @dwContinueStatus, eax</span><br><span class="line">			</span><br><span class="line">		.elseif @de.dwDebugEventCode == EXIT_THREAD_DEBUG_EVENT</span><br><span class="line">			invoke crt_printf, offset g_szEXIT_THREAD_DEBUG_EVENT</span><br><span class="line">			</span><br><span class="line">		.elseif @de.dwDebugEventCode == EXIT_PROCESS_DEBUG_EVENT</span><br><span class="line">			invoke crt_printf, offset g_szEXIT_PROCESS_DEBUG_EVENT</span><br><span class="line">			</span><br><span class="line">		.elseif @de.dwDebugEventCode == LOAD_DLL_DEBUG_EVENT</span><br><span class="line">			;invoke crt_printf, offset g_szLOAD_DLL_DEBUG_EVENT</span><br><span class="line">			invoke OnLoadDll, addr @de</span><br><span class="line">			mov @dwContinueStatus, eax </span><br><span class="line">			</span><br><span class="line">		.elseif @de.dwDebugEventCode == UNLOAD_DLL_DEBUG_EVENT</span><br><span class="line">			invoke crt_printf, offset g_szUNLOAD_DLL_DEBUG_EVENT</span><br><span class="line">			</span><br><span class="line">		.elseif @de.dwDebugEventCode == OUTPUT_DEBUG_STRING_EVENT</span><br><span class="line">			invoke crt_printf, offset g_szOUTPUT_DEBUG_STRING_EVENT</span><br><span class="line">		.endif</span><br><span class="line">		;没这行就GG</span><br><span class="line">		invoke ContinueDebugEvent, @de.dwProcessId, @de.dwThreadId, @dwContinueStatus</span><br><span class="line">	.endw</span><br><span class="line">	xor eax, eax</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">main endp</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	invoke main</span><br><span class="line">	xor eax,eax</span><br><span class="line">	invoke ExitProcess,0</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<h2 id="PE"><a href="#PE" class="headerlink" title="PE"></a>PE</h2><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#修改对齐值</span><br><span class="line">ml /c /coff pe.asm</span><br><span class="line">link /merge:.rdata=.text /align:<span class="number">16</span> /subsystem:windows user32.lib kernel32.lib pe.obj</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">IMAGE_DOS_HEADER</span></span><br><span class="line"><span class="comment">IMAGE_NT_HEADERS  32位真正头的偏移</span></span><br><span class="line"><span class="comment">    IMAGE_FILE_HEADER</span></span><br><span class="line"><span class="comment">    IMAGE_OPTIONAL_HEADER</span></span><br><span class="line"><span class="comment">    	IMAGE_DATA_DIRECTORY[1]</span></span><br><span class="line"><span class="comment">IMAGE_SECTION_HEADER[1]  文件映射 选项头的地址 + 选项头的大小 = 节表的位置</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<img src="/2024/02/22/Notes-Decompile/59.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/60.png" class title="This is an example image">

<p>其他都是16位残留</p>
<p>30 word + long &#x3D; 64字节</p>
<img src="/2024/02/22/Notes-Decompile/61.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/62.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/63.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/64.png" class title="This is an example image">

<p>IMAGE_SECTION_HEADER文件映射 选项头的地址 + 选项头的大小 &#x3D; 节表的位置</p>
<img src="/2024/02/22/Notes-Decompile/65.png" class title="This is an example image">

<ul>
<li>从文件偏移(位置)，映射数据(大小)，到内存地址，在内存中所占大小</li>
<li>节表位置：NT的选项头之后，选项头的地址+选项头大小。就是.text之类的</li>
<li>节大小：两行半&#x3D;16*2+8，union大小为最大元素</li>
<li>文件对齐和内存对齐不一致导致加载后地址偏移</li>
</ul>
<p>winhex查看exe，od查看内存对比</p>
<p>规律：节与节是连续的</p>
<p>要求：PointerToRawData 和 sizeofRawData 都是跟 FileAlign 对齐，virtualAddress是跟 SectionAlign 对齐</p>
<p>sizeofImage：各节内存大小+PE头内存大小；最后一个节的virtualAddress+最后一个节的内存大小</p>
<img src="/2024/02/22/Notes-Decompile/Portable_Executable_32_bit_Structure_in_SVG_fixed.svg" class title="This is an example image">

<h3 id="地址转换"><a href="#地址转换" class="headerlink" title="地址转换"></a>地址转换</h3><p>VA - virtual Address，内存中的虚拟地址，绝对地址</p>
<p>RVA - relative virtual address，相对虚拟地址，相对于模块基址的偏移</p>
<p>FA - file address，文件偏移，文件中所在的地址</p>
<table>
<thead>
<tr>
<th>virtualsize</th>
<th>virtualAddress</th>
<th>SizeofRawData</th>
<th>PointerToRawData</th>
</tr>
</thead>
<tbody><tr>
<td>0x28</td>
<td>0x1000</td>
<td>0x200</td>
<td>0x400</td>
</tr>
<tr>
<td>0x92</td>
<td>0x2000</td>
<td>0x200</td>
<td>0x600</td>
</tr>
<tr>
<td>0x10</td>
<td>0x3000</td>
<td>0x200</td>
<td>0x800</td>
</tr>
<tr>
<td>0x10</td>
<td>0x4000</td>
<td>0x200</td>
<td>0xa00</td>
</tr>
</tbody></table>
<p>00402145(VA) –&gt; 2145(RVA) –&gt; 145 + 600 –&gt; 745(FA)</p>
<p>812(FA) –&gt; 12 + 3000 -&gt; 3012 + 00400000 –&gt; 00403012(VA)</p>
<p>程序中的绝对地址映射到内存中的地址</p>
<p>修改winhex的745地址值，OD里的内存中00402145的改变</p>
<table>
<thead>
<tr>
<th>virtualsize</th>
<th>virtualAddress</th>
<th>SizeofRawData</th>
<th>PointerToRawData</th>
</tr>
</thead>
<tbody><tr>
<td>0xBA</td>
<td>0x210</td>
<td>0xC0</td>
<td>0x210</td>
</tr>
<tr>
<td>0x10</td>
<td>0x2D0</td>
<td>0x10</td>
<td>0x2D0</td>
</tr>
</tbody></table>
<p>从文件偏移 0x2D0 处复制 0x10 个字节的数据到内存 0x2D0处，占0x10</p>
<p>00400000 + 210 &#x3D; 00400210</p>
<p>00400000 + 2D0 &#x3D; 004002D0</p>
<img src="/2024/02/22/Notes-Decompile/66.png" class title="This is an example image">



<h3 id="dump文件的编写"><a href="#dump文件的编写" class="headerlink" title="dump文件的编写"></a>dump文件的编写</h3><p>PE头相同，把内存和文件偏移的赋值位置调换</p>
<p>dump是读取内存数据？运行时从文件内映射到内存，dump是从内存映射到文件？</p>
<p>默认还是按照从文件中拿数据映射到内存，把映射地址调换，exe运行机制又没改变？<br>    运行程序，再用winhex打开，看此时的运行内存，即文件偏移复制到内存中的地址<br>    把复制在内存中的节数据拷贝到新的exe</p>
<ul>
<li>生成dump文件可能会因为全局变量初始化问题出问题</li>
<li>dump未初始化的文件</li>
</ul>
<p>解答：</p>
<ul>
<li><strong>映射：按照节表的内容，将PE文件按照节表信息和节数据依次映射进入内存。</strong></li>
<li><strong>DUMP：将内存中的数据按节表数据将目标数据拷贝出来成为一个PE.exe文件</strong></li>
<li><strong>dump的先决条件</strong>：<strong>在OEP处dump</strong>，此时全局变量里的值未被初始化，不会存在全局变量的访问异常。</li>
</ul>
<p>调试器默认都有dump功能</p>
<p>脱壳用dump</p>
<h3 id="节表注入"><a href="#节表注入" class="headerlink" title="节表注入"></a>节表注入</h3><p>添加节</p>
<ol>
<li>节表添加一项</li>
<li>添加节数据</li>
<li>节表个数增1</li>
<li>修改SizeOfImage</li>
</ol>
<p>扩展最后一个节</p>
<ol>
<li>修改节表</li>
<li>添加节数据</li>
<li>修改SizeOfImage</li>
</ol>
<p>CFF工具可以辅助</p>
<h3 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h3><img src="/2024/02/22/Notes-Decompile/67.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/68.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/69.png" class title="This is an example image">

<p>IMAGE_DATA_DIRECTORY </p>
<ul>
<li>CFF Explorer，自带地址转换</li>
<li>Dependency Walker</li>
<li>DLL文件占20个字节，1行+4</li>
<li>节表往上8行就是导入表</li>
<li>PE往下7行半就是导出表、导入表</li>
<li>导入表20个字节</li>
</ul>
<img src="/2024/02/22/Notes-Decompile/70.png" class title="This is an example image">

<p>415c - 4000 + 5000 &#x3D; 515c</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iBinary/p/9740757.html">https://www.cnblogs.com/iBinary/p/9740757.html</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD   Characteristics;            <span class="comment">// 0 for terminating null import descriptor</span></span><br><span class="line">        DWORD   OriginalFirstThunk;		   <span class="comment">// RVA to original unbound IAT (PIMAGE_THUNK_DATA) 指向IAT结构注释表明了</span></span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    DWORD   TimeDateStamp;                  <span class="comment">// 时间戳.</span></span><br><span class="line">                                            <span class="comment">// -1 if bound, and real date\time stamp</span></span><br><span class="line">                                            <span class="comment">// in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span></span><br><span class="line">                                            <span class="comment">// O.W. date/time stamp of DLL bound to (Old BIND)</span></span><br><span class="line"></span><br><span class="line">    DWORD   ForwarderChain;                 <span class="comment">// -1 if no forwarders 导入名称？</span></span><br><span class="line">    DWORD   Name;　　　　　　　　　　　　　　　<span class="comment">//指向DLL名字的 RVA</span></span><br><span class="line">    DWORD   FirstThunk;        <span class="comment">// RVA to IAT (if bound this IAT has actual addresses) 导入地址？</span></span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure>

<p>可选头后的导入表（地址RVA、大小）跳转导入列表 IMAGE_IMPORT_DESCRIPTOR，每个导入表五个字节。</p>
<p>重点关注第一个(OriginalFirstThunk&#x2F;INT)、第四个(Name)、最后一个(FirstThunk&#x2F;IAT)</p>
<ul>
<li>如果高位位1，说明是序号导入，低WORD 位导入函数的序号值。</li>
<li>如果最高位为 0，说明是名字导入，该DWORD 指向结构体 IMAGE_IMPORT_BY_NAME</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_THUNK_DATA32</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD ForwarderString;      <span class="comment">// PBYTE </span></span><br><span class="line">        DWORD Function;             <span class="comment">// PDWORD</span></span><br><span class="line">        DWORD Ordinal;</span><br><span class="line">        DWORD AddressOfData;        <span class="comment">// PIMAGE_IMPORT_BY_NAME</span></span><br><span class="line">    &#125; u1;</span><br><span class="line">&#125; IMAGE_THUNK_DATA32;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_THUNK_DATA32 * PIMAGE_THUNK_DATA32;</span><br></pre></td></tr></table></figure>

<p>IAT 和 INT都指向 IMAGE_THUNK_DATA32，分别指向 Ordinal 和 AddressOfData，它们再指向IMAGE_IMPORT_BY_NAME</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_BY_NAME</span> &#123;</span></span><br><span class="line">    WORD    Hint;                 <span class="comment">//编译器决定,不是空的话,就是函数在导出表中的 函数地址表的导出索引.</span></span><br><span class="line">    CHAR   Name[<span class="number">1</span>];               <span class="comment">//函数名称,0结尾.</span></span><br><span class="line">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br></pre></td></tr></table></figure>

<p>PE加载到进程之前</p>
<img src="/2024/02/22/Notes-Decompile/75.png" class title="This is an example image">

<p>PE加载到进程之后</p>
<img src="/2024/02/22/Notes-Decompile/71.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/72.png" class title="This is an example image">

<img src="/2024/02/22/Notes-Decompile/73.png" class title="This is an example image">

<p>415C(RVA)  - 1000 + 400 &#x3D; 355c(FOA)</p>
<p>4484(RVA)  - 1000 + 400 &#x3D; 3884(FOA)</p>
<p> 直接内存里面看</p>
<img src="/2024/02/22/Notes-Decompile/74.png" class title="This is an example image">

<p>PEload</p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn//thread-1077397-1-1.html">https://www.52pojie.cn//thread-1077397-1-1.html</a></p>
<h3 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   Characteristics;    <span class="comment">// 不加红的不重要</span></span><br><span class="line">    DWORD   TimeDateStamp;      <span class="comment">//时间戳.  编译的时间. 把秒转为时间.可以知道这个DLL是什么时候编译出来的.</span></span><br><span class="line">    WORD    MajorVersion;</span><br><span class="line">    WORD    MinorVersion;</span><br><span class="line">    DWORD   Name;　　　　　　　　　　　<span class="comment">//指向该导出表文件名的字符串,也就是这个DLL的名称  辅助信息.修改不影响  存储的RVA 如果想在文件中查看.自己计算一下FOA即可.</span></span><br><span class="line">    DWORD   Base; 　　　　　　　　　　<span class="comment">// 导出函数的起始序号</span></span><br><span class="line">    DWORD   NumberOfFunctions;     <span class="comment">//所有的导出函数的个数</span></span><br><span class="line">    DWORD   NumberOfNames;         <span class="comment">//以名字导出的函数的个数</span></span><br><span class="line">    DWORD   AddressOfFunctions;     <span class="comment">// 导出的函数地址的 地址表  RVA  也就是 函数地址表  </span></span><br><span class="line">    DWORD   AddressOfNames;         <span class="comment">// 导出的函数名称表的  RVA      也就是 函数名称表</span></span><br><span class="line">    DWORD   AddressOfNameOrdinals;  <span class="comment">// 导出函数序号表的RVA         也就是 函数序号表</span></span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iBinary/p/9739031.html">https://www.cnblogs.com/iBinary/p/9739031.html</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-269947.htm">https://bbs.kanxue.com/thread-269947.htm</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/DonaldTrump0/LordPE/releases/tag/0.2Soblesky.2">https://github.com/DonaldTrump0/LordPE/releases/tag/0.2Soblesky.2</a></p>
<h3 id="基地重定向表"><a href="#基地重定向表" class="headerlink" title="基地重定向表"></a>基地重定向表</h3><p>IMAGE_BASE_RELOCATION</p>
<p>分页地址，页面偏移 -8&#x2F;2&#x3D;word的个数</p>
<p>API模拟：把dll的接口复制在新内存，调用新内存里的接口</p>
<h3 id="TLS表"><a href="#TLS表" class="headerlink" title="TLS表"></a>TLS表</h3><p>thread local storage 线程局部存储</p>
<p>显示TLS</p>
<ul>
<li>线程 API</li>
</ul>
<p>隐式TLS</p>
<ul>
<li>变量</li>
</ul>
<h3 id="资源表"><a href="#资源表" class="headerlink" title="资源表"></a>资源表</h3><p>函数转发</p>
<p>Import REConstructor</p>

    </div>

    
    
    
	

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Topday
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://topdayplus.github.io/2024/02/22/Notes-Decompile/" title="Notes-Decompile">http://topdayplus.github.io/2024/02/22/Notes-Decompile/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E6%B1%87%E7%BC%96/" rel="tag"># 汇编</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/01/02/Notes-C/" rel="prev" title="Notes-C">
                  <i class="fa fa-chevron-left"></i> Notes-C
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/07/03/Notes-Reverse/" rel="next" title="Notes-Reverse">
                  Notes-Reverse <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Topday</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">266k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:02</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
