<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"topdayplus.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="就这样吧">
<meta property="og:type" content="article">
<meta property="og:title" content="Notes-Android-II">
<meta property="og:url" content="http://topdayplus.github.io/2025/03/08/Notes-Android-II/index.html">
<meta property="og:site_name" content="Topday&#39;s Blog">
<meta property="og:description" content="就这样吧">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://topdayplus.github.io/2025/03/08/Notes-Android-II/01.png">
<meta property="og:image" content="http://topdayplus.github.io/2025/03/08/Notes-Android-II/02.png">
<meta property="article:published_time" content="2025-03-08T12:32:42.000Z">
<meta property="article:modified_time" content="2025-09-15T14:30:33.298Z">
<meta property="article:author" content="Topday">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://topdayplus.github.io/2025/03/08/Notes-Android-II/01.png">


<link rel="canonical" href="http://topdayplus.github.io/2025/03/08/Notes-Android-II/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://topdayplus.github.io/2025/03/08/Notes-Android-II/","path":"2025/03/08/Notes-Android-II/","title":"Notes-Android-II"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Notes-Android-II | Topday's Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Topday's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#NDK%E6%B1%87%E7%BC%96-%E5%BC%80%E5%8F%91"><span class="nav-number">1.</span> <span class="nav-text">NDK汇编(开发)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.</span> <span class="nav-text">基础配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#clang-%E5%BC%80%E5%8F%91"><span class="nav-number">1.2.</span> <span class="nav-text">clang 开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GDB"><span class="nav-number">1.3.</span> <span class="nav-text">GDB</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ARM-%E6%A1%88%E4%BE%8B"><span class="nav-number">2.</span> <span class="nav-text">ARM 案例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80"><span class="nav-number">2.1.</span> <span class="nav-text">案例一</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C"><span class="nav-number">2.2.</span> <span class="nav-text">案例二</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E6%B1%87%E7%BC%96%E8%BF%98%E5%8E%9F%E4%B8%BAC%E4%BB%A3%E7%A0%81"><span class="nav-number">2.2.1.</span> <span class="nav-text">根据汇编还原为C代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E5%BC%95%E5%85%A5IDA-%E6%8F%90%E4%BE%9B%E7%9A%84-defs-h-%E5%90%8E%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-number">2.2.2.</span> <span class="nav-text">可引入IDA 提供的 defs.h 后直接运行伪代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%86%9F%E6%82%89%E7%AE%97%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">熟悉算法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#HMAC%EF%BC%88salt%EF%BC%89"><span class="nav-number">3.1.</span> <span class="nav-text">HMAC（salt）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DES"><span class="nav-number">3.2.</span> <span class="nav-text">DES</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86"><span class="nav-number">3.3.</span> <span class="nav-text">分组加密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AES"><span class="nav-number">3.4.</span> <span class="nav-text">AES</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IDA-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E4%B9%8B%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="nav-number">4.</span> <span class="nav-text">IDA 动态调试之反调试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#APP%E8%BF%87ROOT%E6%A3%80%E6%B5%8B"><span class="nav-number">5.</span> <span class="nav-text">APP过ROOT检测</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%87%AA%E7%BC%96%E8%AF%91%E9%9D%A2%E5%85%B7"><span class="nav-number">6.</span> <span class="nav-text">自编译面具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#frida-%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="nav-number">7.</span> <span class="nav-text">frida 反调试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%87%AA%E7%BC%96%E8%AF%91Frida"><span class="nav-number">8.</span> <span class="nav-text">自编译Frida</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AD%94%E6%94%B9Frida"><span class="nav-number">9.</span> <span class="nav-text">魔改Frida</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ubuntu%E4%BD%BF%E7%94%A8-v2"><span class="nav-number">10.</span> <span class="nav-text">ubuntu使用 v2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#unidbg-%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C-SO"><span class="nav-number">11.</span> <span class="nav-text">unidbg 模拟执行 SO</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8-amp-%E7%89%B9%E6%AE%8A%E5%8F%82%E6%95%B0"><span class="nav-number">11.1.</span> <span class="nav-text">主动调用&amp;特殊参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI%E8%A1%A5%E7%8E%AF%E5%A2%83"><span class="nav-number">11.2.</span> <span class="nav-text">JNI补环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IDA-%E7%BC%96%E8%AF%91%E5%90%8D%E8%BD%AC%E6%8D%A2"><span class="nav-number">11.3.</span> <span class="nav-text">IDA 编译名转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dobby-amp-Unicorn"><span class="nav-number">11.4.</span> <span class="nav-text">Dobby&amp;Unicorn</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#path-so"><span class="nav-number">11.5.</span> <span class="nav-text">path_so</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE-IO-%E6%B5%81%E8%A1%A5%E7%8E%AF%E5%A2%83"><span class="nav-number">11.6.</span> <span class="nav-text">文件访问 IO 流补环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%A1%A5%E7%8E%AF%E5%A2%83"><span class="nav-number">11.7.</span> <span class="nav-text">系统补环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E7%A1%AC%E7%BC%96%E7%A0%81%E8%BF%94%E5%9B%9E"><span class="nav-number">11.7.1.</span> <span class="nav-text">1、硬编码返回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E4%BB%BF%E5%86%99%E6%A1%86%E6%9E%B6"><span class="nav-number">11.7.2.</span> <span class="nav-text">2、仿写框架</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Topday"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Topday</p>
  <div class="site-description" itemprop="description">For me, it has not yet been realized what the rest of one’s life, is my greatest encouragement.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/topdayplus" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;topdayplus" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://topdayplus.github.io/2025/03/08/Notes-Android-II/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Topday">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Topday's Blog">
      <meta itemprop="description" content="For me, it has not yet been realized what the rest of one’s life, is my greatest encouragement.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Notes-Android-II | Topday's Blog">
      <meta itemprop="description" content="就这样吧">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Notes-Android-II
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
  
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-03-08 20:32:42" itemprop="dateCreated datePublished" datetime="2025-03-08T20:32:42+08:00">2025-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-15 22:30:33" itemprop="dateModified" datetime="2025-09-15T22:30:33+08:00">2025-09-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%81%B0%E9%98%9F/" itemprop="url" rel="index"><span itemprop="name">灰队</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>58k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>53 分钟</span>
    </span>
</div>

            <div class="post-description">就这样吧</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="NDK汇编-开发"><a href="#NDK汇编-开发" class="headerlink" title="NDK汇编(开发)"></a>NDK汇编(开发)</h1><h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c546783ad284">https://www.jianshu.com/p/c546783ad284</a></p>
<p>idea安装cmake和NDK<br>1、ubuntu自动加进环境变量<br>2、windows要自己添加</p>
<p> source ~&#x2F;.bashrc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ndk-build NDK_PROJECT_PATH=. NDK_APPLICATION_MK=Application.mk</span><br></pre></td></tr></table></figure>



<p>IDA远程调试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1、把 IDA dbgsrv目录下的文件在手机执行 android_server </span><br><span class="line">2、用32位IDA Debugger调试程序</span><br></pre></td></tr></table></figure>



<p>elf文件</p>
<p>arm 模式：定长指令集，四个字节</p>
<p>thumb 模式：不定长</p>
<p>T标志位</p>
<h2 id="clang-开发"><a href="#clang-开发" class="headerlink" title="clang 开发"></a>clang 开发</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/other_build_systems?hl=zh-cn">https://developer.android.com/ndk/guides/other_build_systems?hl=zh-cn</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/burner/p/clang-fen-si-bu-bian-yimainc.html">https://www.cnblogs.com/burner/p/clang-fen-si-bu-bian-yimainc.html</a></p>
<p>clang路径在SDK&#x2F;NDK下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\admin\AppData\Local\Android\Sdk\ndk\28.0.12674087\toolchains\llvm\prebuilt\windows-x86_64\bin</span><br><span class="line">C:\Users\admin\AppData\Local\Android\Sdk\ndk\28.0.12674087\toolchains\llvm\prebuilt\linux-x86_64\bin</span><br></pre></td></tr></table></figure>



<h2 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h2><p>安装GEF</p>
<p>GDB multiarch 远程调试，原理同IDA远程调试，需上传服务端文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Sdk/ndk/23.1.7779620/prebuilt/android-arm/gdbserver</span><br><span class="line">./gdbserver :1234 hello.o</span><br><span class="line"></span><br><span class="line">gdb-multiarch</span><br><span class="line">target remote ip:port</span><br><span class="line"></span><br><span class="line">gdb-multiarch</span><br><span class="line">gef-remote -p 3929 ip:port #雷电需要用x86_64版本，提示权限不足</span><br></pre></td></tr></table></figure>

<h1 id="ARM-案例"><a href="#ARM-案例" class="headerlink" title="ARM 案例"></a>ARM 案例</h1><h2 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h2><p>在 .o文件里用汇编代替原有函数(print、getchar)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#printf</span><br><span class="line">#只有return 0的汇编</span><br><span class="line">main:</span><br><span class="line">	.fnstart</span><br><span class="line">@ %bb.0:</span><br><span class="line">	.pad	#4</span><br><span class="line">	sub	sp, sp, #4</span><br><span class="line">	movw	r0, #0</span><br><span class="line">	str	r0, [sp]</span><br><span class="line">	movw	r0, #0</span><br><span class="line">	add	sp, sp, #4</span><br><span class="line">	bx	lr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">	.fnstart</span><br><span class="line">	push &#123;lr&#125;</span><br><span class="line"></span><br><span class="line">	ldr r0,[r1,#4]</span><br><span class="line">	bl printf</span><br><span class="line"></span><br><span class="line">	movw	r0, #0</span><br><span class="line">	pop &#123;lr&#125;</span><br><span class="line">	bx	lr</span><br></pre></td></tr></table></figure>



<h2 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h2><h3 id="根据汇编还原为C代码"><a href="#根据汇编还原为C代码" class="headerlink" title="根据汇编还原为C代码"></a>根据汇编还原为C代码</h3><p>1、IDA打开v7a的 SO文件</p>
<p>2、找到导出 check</p>
<p>3、修改第一个默认参数为 JNIEnv，这样就能关联到内置的函数</p>
<p>4、算法还原</p>
<p>这些R0 、R1指代第一第二个参数吗</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">TestDec                                 ; CODE XREF: j_TestDec+8↑j</span><br><span class="line">.text:00001062                                         ; DATA XREF: LOAD:00000250↑o ...</span><br><span class="line">.text:00001062 ; __unwind &#123;</span><br><span class="line">.text:00001062                 PUSH            &#123;R4,R5,R7,LR&#125;</span><br><span class="line">.text:00001064                 ADD             R7, SP, #8</span><br><span class="line">.text:00001066                 MOV             R4, R0</span><br><span class="line">.text:00001068                 BLX             strlen</span><br><span class="line">.text:0000106C                 CMP             R0, #2</span><br><span class="line">.text:0000106E                 BCC             loc_108A</span><br><span class="line">.text:00001070                 MOVS            R5, #0</span><br><span class="line">.text:00001072</span><br><span class="line">.text:00001072 loc_1072                                ; CODE XREF: TestDec+26↓j</span><br><span class="line">.text:00001072                 ADDS            R1, R4, R5</span><br><span class="line">.text:00001074                 LDRB            R0, [R4,R5]</span><br><span class="line">.text:00001076                 LDRB            R2, [R1,#0x10]</span><br><span class="line">.text:00001078                 STRB            R2, [R4,R5]</span><br><span class="line">.text:0000107A                 ADDS            R5, #1</span><br><span class="line">.text:0000107C                 STRB            R0, [R1,#0x10]</span><br><span class="line">.text:0000107E                 MOV             R0, R4  ; s</span><br><span class="line">.text:00001080                 BLX             strlen</span><br><span class="line">.text:00001084                 CMP.W           R5, R0,LSR#1</span><br><span class="line">.text:00001088                 BCC             loc_1072</span><br><span class="line">.text:0000108A</span><br><span class="line">.text:0000108A loc_108A                                ; CODE XREF: TestDec+C↑j</span><br><span class="line">.text:0000108A                 LDRB            R0, [R4]</span><br><span class="line">.text:0000108C                 CBZ             R0, locret_10B8</span><br><span class="line">.text:0000108E                 LDRB            R1, [R4,#1]</span><br><span class="line">.text:00001090                 STRB            R1, [R4]</span><br><span class="line">.text:00001092                 STRB            R0, [R4,#1]</span><br><span class="line">.text:00001094                 MOV             R0, R4  ; s</span><br><span class="line">.text:00001096                 BLX             strlen</span><br><span class="line">.text:0000109A                 CMP             R0, #3</span><br><span class="line">.text:0000109C                 BCC             locret_10B8</span><br><span class="line">.text:0000109E                 MOVS            R5, #0</span><br><span class="line">.text:000010A0</span><br><span class="line">.text:000010A0 loc_10A0                                ; CODE XREF: TestDec+54↓j</span><br><span class="line">.text:000010A0                 ADDS            R0, R4, R5</span><br><span class="line">.text:000010A2                 LDRB            R1, [R0,#2]</span><br><span class="line">.text:000010A4                 LDRB            R2, [R0,#3]</span><br><span class="line">.text:000010A6                 STRB            R2, [R0,#2]</span><br><span class="line">.text:000010A8                 STRB            R1, [R0,#3]</span><br><span class="line">.text:000010AA                 MOV             R0, R4  ; s</span><br><span class="line">.text:000010AC                 BLX             strlen</span><br><span class="line">.text:000010B0                 ADDS            R1, R5, #4</span><br><span class="line">.text:000010B2                 ADDS            R5, #2</span><br><span class="line">.text:000010B4                 CMP             R1, R0</span><br><span class="line">.text:000010B6                 BCC             loc_10A0</span><br><span class="line">.text:000010B8</span><br><span class="line">.text:000010B8 locret_10B8                             ; CODE XREF: TestDec+2A↑j</span><br><span class="line">.text:000010B8                                         ; TestDec+3A↑j</span><br><span class="line">.text:000010B8                 POP             &#123;R4,R5,R7,PC&#125;</span><br><span class="line">.text:000010B8 ; End of function TestDec</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">TestDec</span><span class="params">(<span class="type">char</span> *str)</span>&#123;</span><br><span class="line">    <span class="type">char</span> *r4 = str;</span><br><span class="line">    <span class="type">int</span> lenstr = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">if</span>(lenstr&gt;=<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> r5=<span class="number">0</span>;r5&lt; lenstr&gt;&gt;<span class="number">1</span>;r5++)&#123;</span><br><span class="line">            <span class="type">char</span> * r1 = r4+r5;</span><br><span class="line">            <span class="type">char</span> r0 = *(r4+r5);</span><br><span class="line">            <span class="type">char</span> r2 = *(r1+<span class="number">16</span>);</span><br><span class="line">            *(r4+r5) = r2;</span><br><span class="line">            *(r1+<span class="number">16</span>) = r0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> r0 = *(r4);</span><br><span class="line">    <span class="keyword">if</span>(r0)&#123;</span><br><span class="line">        <span class="type">char</span> r1 = *(r4+<span class="number">1</span>);</span><br><span class="line">        *(r4) = r1;</span><br><span class="line">        *(r4+<span class="number">1</span>) = r0;</span><br><span class="line">        <span class="keyword">if</span>(lenstr &gt;= <span class="number">3</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> r5=<span class="number">0</span>; r5+<span class="number">4</span> &lt; lenstr;r5+=<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="type">char</span> *rr0 = r4+r5;</span><br><span class="line">                <span class="type">char</span> rr1 = *(rr0+<span class="number">2</span>);</span><br><span class="line">                <span class="type">char</span> rr2 = *(rr0+<span class="number">3</span>);</span><br><span class="line">                *(rr0+<span class="number">2</span>) = rr2;</span><br><span class="line">                *(rr0+<span class="number">3</span>) = rr1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,r4);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> *s = <span class="string">&quot;9007b55be5bf95adf72c5a365694182a&quot;</span>;</span><br><span class="line">    <span class="type">int</span> lenstr = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="type">char</span> *arg = (<span class="type">char</span>*)<span class="built_in">malloc</span>(lenstr+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memset</span>(arg,<span class="number">0</span>,lenstr+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(arg,s,lenstr);</span><br><span class="line">    TestDec(arg);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="可引入IDA-提供的-defs-h-后直接运行伪代码"><a href="#可引入IDA-提供的-defs-h-后直接运行伪代码" class="headerlink" title="可引入IDA 提供的 defs.h 后直接运行伪代码"></a>可引入IDA 提供的 defs.h 后直接运行伪代码</h3><p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1584115&amp;highlight=ida">https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1584115&amp;highlight=ida</a></p>
<p>IDA快捷键&amp;常用方法</p>
<ul>
<li>汇编 &amp; 伪代码的跳转（空格、Tab）</li>
<li>强制当做代码&#x2F;数据（C、D）</li>
<li>数据 convert</li>
<li>重命名</li>
<li>查找调用链，Xref graph to</li>
<li>插件使用</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41028985/article/details/119407917">https://blog.csdn.net/qq_41028985/article/details/119407917</a></p>
<h1 id="熟悉算法"><a href="#熟悉算法" class="headerlink" title="熟悉算法"></a>熟悉算法</h1><p>用于识别魔改算法或分析算法</p>
<p><strong>输入信息&#x2F;输出信息要hex编码</strong> </p>
<p>md5算法</p>
<p>SHA1算法</p>
<p>SHA2&#x2F;256&#x2F;512等后续一堆</p>
<h2 id="HMAC（salt）"><a href="#HMAC（salt）" class="headerlink" title="HMAC（salt）"></a>HMAC（salt）</h2><ul>
<li>自行根据字符串计算hmac对照</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://space.bilibili.com/253413704">https://space.bilibili.com/253413704</a></p>
 

 

 

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">message：加密消息</span><br><span class="line">key：加密密钥（需要补充）</span><br><span class="line">opad 和 ipad 都是固定</span><br></pre></td></tr></table></figure>

 

 

 

<h2 id="DES"><a href="#DES" class="headerlink" title="DES"></a>DES</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https://www.bilibili.com/video/BV1134y1Y71j</span><br><span class="line">https://www.bilibili.com/video/BV1QW411B7A4</span><br><span class="line">https://www.bilibili.com/video/BV1KQ4y127AT</span><br><span class="line">https://juejin.cn/post/7084242293816983589</span><br><span class="line">https://cloud.tencent.com/developer/article/1497864</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jikexianfeng/p/10192024.html">https://www.cnblogs.com/jikexianfeng/p/10192024.html</a></p>
<p>CLion</p>
<h2 id="分组加密"><a href="#分组加密" class="headerlink" title="分组加密"></a>分组加密</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/a745233700/article/details/102311776">https://blog.csdn.net/a745233700/article/details/102311776</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000040964999">https://segmentfault.com/a/1190000040964999</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1U8411f74f/">https://www.bilibili.com/video/BV1U8411f74f/</a></p>
<h2 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1824y1y7gc">https://www.bilibili.com/video/BV1824y1y7gc</a></p>
<p>12345678，8个字节，64个位</p>
<p>APK未抹去符号表，MD5算法是否魔改分析</p>
<p>1、提取 so，用IDA分析</p>
<p>2、根据原MD5的几个关键步骤，分析汇编。搜索固定的表内容，没被魔改可以搜到</p>
<p>3、Hook SO地址</p>
<p>MD5常见魔改点：</p>
<p>1、明文加盐或填充</p>
<p>2、初始魔数的修改</p>
<p>3、常量表K</p>
<p>4、左移次数</p>
<p>5、F,G,H,I四个非线性变换函数等的逻辑</p>
<p>unidbg</p>
<p>IDA快捷键：H、Y、Tab</p>
<h1 id="IDA-动态调试之反调试"><a href="#IDA-动态调试之反调试" class="headerlink" title="IDA 动态调试之反调试"></a>IDA 动态调试之反调试</h1><p>遗留问题：虚拟机debuggable&#x3D;1</p>
<p>1、getprop ro.debuggable &#x3D; 0 的话 IDA 动态调试看不到进程名，部分功能被屏蔽</p>
<p>真机用：agiskHide Props Config 修改成功</p>
<p>虚拟机暂未成功</p>
<p>2、查看线程名要用新版的IDA，实测7.0的看不到，7.7的就看得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.Attach模式 附加 so动态调试。过掉反调试的方法</span><br><span class="line">2.Spwan模式  过掉反调试的方法：这里讲原理</span><br><span class="line"></span><br><span class="line">1. nop掉</span><br><span class="line">2. 挂起线程</span><br><span class="line">3. frida hook</span><br></pre></td></tr></table></figure>



<p>IDA调试tips:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、真机无网络通过USB调试，需配置端口转发才能IDA远程调试</span><br><span class="line">adb forward tcp:23946 tcp:23946  本机-&gt;设备</span><br><span class="line">adb reverse tcp:23946 tcp:23946  设备-&gt;本机</span><br><span class="line">adb forward --remove tcp:&lt;port&gt;</span><br><span class="line"></span><br><span class="line">2、静态调试和动态调试，IDA自动化分析的注释不同</span><br></pre></td></tr></table></figure>



<p>步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、进入IDA动态调试，点击运行崩溃</span><br><span class="line">2、在Threads窗口，找和包名一样的线程，Suspended 挂起运行正常</span><br><span class="line">3、在Modules窗口，搜索包名/运行关键词/check/security，找到检测/校验模块，双击进入对应代码，下断点</span><br><span class="line">4、点击触发，Tab切换伪代码</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">ByPassTracerPid</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> fgetsPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fgets&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fgets = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fgetsPtr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(fgetsPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">buffer, size, fp</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> retval = <span class="title function_">fgets</span>(buffer, size, fp);</span><br><span class="line">      <span class="keyword">var</span> bufstr = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(buffer);</span><br><span class="line">      <span class="keyword">if</span> (bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;TracerPid:&quot;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(buffer, <span class="string">&quot;TracerPid:\t0&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;tracerpid replaced: &quot;</span> + <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(buffer));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]));</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="title class_">ByPassTracerPid</span>);</span><br></pre></td></tr></table></figure>



<p>参考文章：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Android修改ro.debuggable 的四种方法</span><br><span class="line">https://blog.csdn.net/jinmie0193/article/details/111355867</span><br><span class="line"></span><br><span class="line">IDA动态调试破解AliCrackme与反调试对抗</span><br><span class="line">https://blog.csdn.net/weixin_39190897/article/details/120808079</span><br><span class="line"></span><br><span class="line">[原创]2015年AliCrackMe第二题的分析之人肉过反调试 </span><br><span class="line">https://bbs.pediy.com/thread-258595.htm</span><br><span class="line"></span><br><span class="line">常用命令:</span><br><span class="line">adb shell am start -D -n com.yaotong.crackme/.MainActivity</span><br><span class="line">adb shell ps | findstr crackme</span><br><span class="line">jdwp协议端口转发:adb forward tcp:8700 jdwp:2494</span><br><span class="line">jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700</span><br></pre></td></tr></table></figure>



<h1 id="APP过ROOT检测"><a href="#APP过ROOT检测" class="headerlink" title="APP过ROOT检测"></a>APP过ROOT检测</h1><p>安装面具:<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1UN4y137Z5/?vd_source=43c2c404de6d798650d44c856ee1e992">https://www.bilibili.com/video/BV1UN4y137Z5/?vd_source=43c2c404de6d798650d44c856ee1e992</a><br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-263203.htm">https://bbs.kanxue.com/thread-263203.htm</a></p>
<p>修改固有面具（修改源码）</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41155858/article/details/127885048">https://blog.csdn.net/qq_41155858/article/details/127885048</a></p>
<p>root检测：<br>    1.在代码中检测  -&gt; hook&#x2F;修改重打包（代码固有API检测是否root？）<br>    2.检测系统属性（检测app安装的系统环境参数）<br>    3.查找字符串（查找root关键词，比如su）</p>
<p>对抗方法:	<br>    1.hook<br>    2.最新版magisk（配置排除列表、随机文件名） + shamiko(可有可无)+随机magisk<br>    3.需要重新编译面具  改su名称（这个有点麻烦，最新版gsyh过不去就这个）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">小米6重装最新版Magisk就可以了，直接过三个（新版的gs只开还是过不了）</span><br><span class="line">adb reboot bootloader</span><br><span class="line">https://magiskcn.com/</span><br><span class="line">https://blog.csdn.net/qq_42663692/article/details/135704736</span><br></pre></td></tr></table></figure>

<p>绕过的具体操作<br>1、最新版面具<br>2、修改面具名称<br>3、用自带的隐藏root模块<br>4、修改su名称</p>
<p>Tips：<br>1、面具安装在真机，需要提取真机boot，通过面具修复后生成.img文件，再重新刷回手机<br>2、面具安装在模拟器，要安装修改的magisk-delta版本，有直接刷在系统选项（<a target="_blank" rel="noopener" href="https://magisk-delta.com/%EF%BC%89">https://magisk-delta.com/）</a></p>
<h1 id="自编译面具"><a href="#自编译面具" class="headerlink" title="自编译面具"></a>自编译面具</h1><p>环境：win10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、用AS自带的 java11，设置为环境变量</span><br><span class="line">2、全程挂梯子</span><br><span class="line">3、windows 用旧版 python，如python3.8</span><br><span class="line"></span><br><span class="line">git clone --recurse-submodules https://github.com/topjohnwu/Magisk.git </span><br><span class="line">python build.py ndk</span><br><span class="line">python build.py clean</span><br><span class="line">python build.py -v all</span><br></pre></td></tr></table></figure>

<p>需要修改成自定义指令的地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val isActive = versionCode &gt; 0 追踪逻辑</span><br><span class="line">&quot;su&quot;,&quot;--mount-master&quot;</span><br></pre></td></tr></table></figure>

<p>Apktoolbox 重打包</p>
<p>windwos坑太多，用ubuntu试试，用ubuntu挂梯子</p>
<p>参考链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/qq_41155858/article/details/127885048?spm=1001.2014.3001.5506</span><br><span class="line">https://zhuanlan.zhihu.com/p/385255256</span><br></pre></td></tr></table></figure>





<h1 id="frida-反调试"><a href="#frida-反调试" class="headerlink" title="frida 反调试"></a>frida 反调试</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">参考文章: [翻译]多种特征检测 Frida -&gt;https://bbs.pediy.com/thread-217482.htm</span><br><span class="line"></span><br><span class="line">从inlinehook角度检测frida-&gt;https://blog.csdn.net/u010559109/article/details/120846740</span><br><span class="line">9</span><br><span class="line">Android逆向——过frida检测+so层算法逆向https://blog.csdn.net/weixin_43889136/article/details/127713563</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">原理:当被调试器附加之后 不为0:https://wiki.hackjie.com/2728.html</span><br><span class="line"></span><br><span class="line"> ptrace占坑:</span><br><span class="line"> https://bbs.pediy.com/thread-268155.htm#msg_header_h2_16</span><br><span class="line"></span><br><span class="line">adb shell dumpsys window w |grep \/ |grep name=</span><br></pre></td></tr></table></figure>

<p>fridacheck app</p>
<p>Process terminated douban strstr</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为什么这样就可以hook，不输入脚本？还是原先有脚本？只是绕过-UF？</span></span><br><span class="line">frida -U -f xxx</span><br><span class="line">%resume</span><br><span class="line"></span><br><span class="line">ps -e | grep xxx</span><br><span class="line">adb shell dumpsys window w | grep \/ | grep name=</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改端口、修改文件名(进程名)</span></span><br><span class="line">./frida-server-pass -l 0.0.0.0:1234</span><br><span class="line">adb forward tcp:1234 tcp:1234</span><br><span class="line">frida -H 手机ip:1234 -F</span><br><span class="line"></span><br><span class="line">hook_RegisterNatives.js</span><br><span class="line">https://github.com/zhkl0228/unidbg</span><br><span class="line"><span class="comment"># 获取的偏移值可直接在IDA g搜索，此时是加载状态吗，直接hook Native为什么不准确</span></span><br><span class="line">修改第一个参数为 JNIEnv*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 线程检测</span></span><br><span class="line">通过IDA分析所用检测的方法，根据检测逻辑去hook fgets、fopen，为什么直接hook整个检测函数</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">hook_readlink</span></span>() &#123;&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">main</span></span>()&#123;</span><br><span class="line">    hook_readlink()</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// code.js</span><br><span class="line">function hook_strstr() &#123;</span><br><span class="line">    // char *strstr(const char *haystack, const char *needle) 在字符串 haystack 中查找第一次出现字符串 needle 的位置，不包含终止符</span><br><span class="line">    var strstr = Module.findExportByName(null, &quot;strstr&quot;);</span><br><span class="line">    if (null !== strstr) &#123;</span><br><span class="line">        Interceptor.attach(strstr, &#123;</span><br><span class="line">            onEnter: function (args) &#123;</span><br><span class="line">                this.frida = Boolean(0);</span><br><span class="line">                this.haystack = args[0];</span><br><span class="line">                this.needle = args[1];</span><br><span class="line">                if (this.haystack.readCString() !== null &amp;&amp; this.needle.readCString() !== null) &#123;</span><br><span class="line">                    if (this.haystack.readCString().indexOf(&quot;frida&quot;) !== -1 ||</span><br><span class="line">                        this.needle.readCString().indexOf(&quot;frida&quot;) !== -1 ||</span><br><span class="line">                        this.haystack.readCString().indexOf(&quot;gum-js-loop&quot;) !== -1 ||</span><br><span class="line">                        this.needle.readCString().indexOf(&quot;gum-js-loop&quot;) !== -1 ||</span><br><span class="line">                        this.haystack.readCString().indexOf(&quot;gmain&quot;) !== -1 ||</span><br><span class="line">                        this.needle.readCString().indexOf(&quot;gmain&quot;) !== -1 ||</span><br><span class="line">                        this.haystack.readCString().indexOf(&quot;linjector&quot;) !== -1 ||</span><br><span class="line">                        this.needle.readCString().indexOf(&quot;linjector&quot;) !== -1) &#123;</span><br><span class="line">                        this.frida = Boolean(1);</span><br><span class="line">                    &#125;</span><br><span class="line">                    console.log(&quot;this.haystack.readCString():&quot;,this.haystack.readCString())</span><br><span class="line">                    console.log(&quot;this.needle.readCString():&quot;,this.needle.readCString())</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onLeave: function (retval) &#123;</span><br><span class="line">                if (this.frida) &#123;</span><br><span class="line">                    retval.replace(ptr(&quot;0x0&quot;));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        console.log(&quot;anti anti-frida&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    console.log(&quot;hook strstr over&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main()&#123;</span><br><span class="line">    hook_strstr();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bypass_fgets</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> fgetsPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fgets&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fgets = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fgetsPtr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fgetsPtr,fgets);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(fgetsPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">buffer, size, fp</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> retval = <span class="title function_">fgets</span>(buffer, size, fp);</span><br><span class="line">        <span class="keyword">var</span> bufstr = buffer.<span class="title function_">readCString</span>();</span><br><span class="line">        <span class="keyword">if</span> (bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;TracerPid:&quot;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(buffer, <span class="string">&quot;TracerPid:\t0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;Name:\tgmain&quot;</span>) &gt; -<span class="number">1</span> || bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;Name:\tgdbus&quot;</span>) &gt; -<span class="number">1</span> || bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;Name:\tpool-frida&quot;</span>) &gt; -<span class="number">1</span> || bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;Name:\tgum-js-loop&quot;</span>) &gt; -<span class="number">1</span> || bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;SigBlk:\tffffffe0fffbfaff&quot;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(buffer, <span class="string">&quot;TName:\t1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_fopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> open_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> io_map = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;/proc/13585/maps&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(open_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args[<span class="number">0</span>].<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;/maps&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                args[<span class="number">0</span>] = io_map</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">pathname</span> = args[<span class="number">0</span>]</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mode</span> = args[<span class="number">1</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fopen pathname=&quot;</span> + <span class="variable language_">this</span>.<span class="property">pathname</span>.<span class="title function_">readCString</span>() + <span class="string">&quot;---mode=&quot;</span> + <span class="variable language_">this</span>.<span class="property">mode</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_readlink</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> aaa, bbb, ccc;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;readlink&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            aaa = args[<span class="number">0</span>];</span><br><span class="line">            bbb = args[<span class="number">1</span>];</span><br><span class="line">            ccc = args[<span class="number">2</span>];</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="comment">// console.log(&#x27;\nreadlink(&#x27; + &#x27;s1=&quot;&#x27; + aaa.readCString() + &#x27;&quot;&#x27; + &#x27;, s2=&quot;&#x27; + bbb.readCString() + &#x27;&quot;&#x27; + &#x27;, s3=&quot;&#x27; + ccc + &#x27;&quot;&#x27; + &#x27;)&#x27;);</span></span><br><span class="line">            <span class="keyword">if</span> (bbb.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;frida&quot;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                bbb.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;gum-js-loop&quot;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                bbb.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;gmain&quot;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                bbb.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;tmp&quot;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                bbb.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;linjector&quot;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\nreadlink(&#x27;</span> + <span class="string">&#x27;s1=&quot;&#x27;</span> + aaa.<span class="title function_">readCString</span>() + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&#x27;, s2=&quot;&#x27;</span> + bbb.<span class="title function_">readCString</span>() + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&#x27;, s3=&quot;&#x27;</span> + ccc + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">                bbb.<span class="title function_">writeUtf8String</span>(<span class="string">&quot;/system/framework/boot.art&quot;</span>)</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;replce with: &quot;</span>+bbb.<span class="title function_">readCString</span>())</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="number">0x1A</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">bypass_fgets</span>()</span><br><span class="line">    <span class="title function_">hook_fopen</span>()</span><br><span class="line">    <span class="title function_">hook_readlink</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">// hook_anti-thread.js</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">hook_pthread_create</span></span>() &#123;</span><br><span class="line">    var pthread_create_addr = Module.findExportByName(null, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    const __android_log_print_ptr = Module.findExportByName(null, <span class="string">&#x27;__android_log_print&#x27;</span>)</span><br><span class="line">    const cm = new CModule(`</span><br><span class="line">    <span class="comment">#include &lt;gum/guminterceptor.h&gt;</span></span><br><span class="line">    extern void onMessageStr (const gchar * message);</span><br><span class="line">    extern void onMessagePtr (void * message);</span><br><span class="line">    extern void onMessageInt (int a);</span><br><span class="line">    extern int __android_log_print(int prio, const char* tag, const char* <span class="built_in">fmt</span>, ...);</span><br><span class="line">    void <span class="function"><span class="title">hello</span></span>()&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    void onEnter (GumInvocationContext * ic)</span><br><span class="line">      &#123;</span><br><span class="line">        // void* arg2,arg3;</span><br><span class="line">        <span class="keyword">if</span>((((int)gum_invocation_context_get_nth_argument(ic, 2))&amp;0xfff)==0x599)&#123;</span><br><span class="line">            onMessageStr(<span class="string">&quot;replace success&quot;</span>);</span><br><span class="line">            gum_invocation_context_replace_nth_argument(ic,2,(gpointer)hello);</span><br><span class="line">        &#125;</span><br><span class="line">        // arg2 = gum_invocation_context_get_nth_argument (ic, 2);</span><br><span class="line">        onMessagePtr(gum_invocation_context_get_nth_argument (ic, 2));</span><br><span class="line">        // arg0 = (int)gum_invocation_context_get_nth_argument (ic, 2);</span><br><span class="line">        // gum_invocation_context_replace_nth_argument(ic,2,(gpointer)100);</span><br><span class="line">        // arg1 = (int)gum_invocation_context_get_nth_argument (ic, 3);</span><br><span class="line">        // <span class="built_in">log</span> (<span class="string">&quot;function add arg0=%d arg1=%d &quot;</span>, arg0,arg1);</span><br><span class="line">        // __android_log_print(3,<span class="string">&quot;isDebug&quot;</span>,<span class="string">&quot;arg0=%d,arg1=%d&quot;</span>,arg0,arg1);</span><br><span class="line">      &#125;</span><br><span class="line">      void</span><br><span class="line">      onLeave (GumInvocationContext * ic)</span><br><span class="line">      &#123;</span><br><span class="line">        int result;</span><br><span class="line">        result = (int) gum_invocation_context_get_return_value (ic);</span><br><span class="line">        onMessageInt(result);</span><br><span class="line">        // gum_invocation_context_replace_return_value (ic,(gpointer)100);</span><br><span class="line">      &#125;`, &#123;</span><br><span class="line">        __android_log_print: __android_log_print_ptr,</span><br><span class="line">        onMessageStr: new NativeCallback(messagePtr =&gt; &#123;</span><br><span class="line">            const message = messagePtr.readUtf8String();</span><br><span class="line">            console.log(<span class="string">&#x27;onMessageStr:&#x27;</span>, message);</span><br><span class="line">        &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]),</span><br><span class="line">        onMessagePtr: new NativeCallback(messagePtr =&gt; &#123;</span><br><span class="line">            console.log(<span class="string">&#x27;onMessagePtr:&#x27;</span>, messagePtr ,hexdump(messagePtr));</span><br><span class="line">        &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]),</span><br><span class="line">        onMessageInt: new NativeCallback(messageInt =&gt; &#123;</span><br><span class="line">            console.log(<span class="string">&#x27;onMessageInt:&#x27;</span>, messageInt);</span><br><span class="line">        &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>]),</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(pthread_create_addr, cm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">replace_thread</span></span>() &#123;</span><br><span class="line">    var pthread_create_addr = Module.findExportByName(null, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    var pthread_create = new NativeFunction(pthread_create_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    Interceptor.replace(pthread_create_addr, new NativeCallback((parg0, parg1, parg2, parg3) =&gt; &#123;</span><br><span class="line">        var so_name = Process.findModuleByAddress(parg2).name;</span><br><span class="line">        var so_base = Module.getBaseAddress(so_name);</span><br><span class="line">        var offset = (parg2 - so_base);</span><br><span class="line">        var PC = 0;</span><br><span class="line">        console.log(<span class="string">&quot;normal find thread func offset&quot;</span>, so_name, parg2,offset, offset.toString(16));</span><br><span class="line">        // i加密 guilvyouping  梆梆 budayuepao  360 leisu</span><br><span class="line">        <span class="keyword">if</span>(</span><br><span class="line">        (so_name.indexOf(<span class="string">&quot;libexec.so&quot;</span>)&gt;-1 &amp;&amp; offset===197069)||</span><br><span class="line">        (so_name.indexOf(<span class="string">&quot;libexec.so&quot;</span>)&gt;-1 &amp;&amp; offset===196137)</span><br><span class="line">        )&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>((so_name.indexOf(<span class="string">&quot;libDexHelper.so&quot;</span>)&gt;-1 &amp;&amp; offset===684452)||</span><br><span class="line">        (so_name.indexOf(<span class="string">&quot;libDexHelper.so&quot;</span>)&gt;-1 &amp;&amp; offset===724380))&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            PC = pthread_create(parg0, parg1, parg2, parg3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> PC;</span><br><span class="line">    &#125;, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(replace_thread)</span><br><span class="line"></span><br><span class="line">// frida -U -f com.darvin.security -l hook_anti-thread.js --no-pause -o out.log</span><br><span class="line">// frida -UF -l hook_anti-thread.js</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//frida -U -f com.gzlex.hui.guoziwei.travel --no-pause -l hook_anti-thread.js </span><br><span class="line">//frida -U -f tv.danmaku.bili -l hook_anti-thread.js  --no-pause  </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>1、hook app调用的各关键内置函数的调用 so和偏移值</p>
<p>2、针对每次调用进行功能hook，多个进行hook，筛选关键功能</p>
<p>打快照为什么要关机</p>
<h1 id="自编译Frida"><a href="#自编译Frida" class="headerlink" title="自编译Frida"></a>自编译Frida</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">安装全新ubuntu</span><br><span class="line">sudo apt-get install proxychains</span><br><span class="line">sudo gedit /etc/proxychains.conf</span><br><span class="line">	socks5 ip port</span><br><span class="line">sudo apt-get install curl</span><br><span class="line">proxychains curl www.httpbin.org/ip  // 验证代理IP</span><br><span class="line">sudo apt install git</span><br><span class="line">sudo dpkg -i vscode.deb</span><br><span class="line">	code .</span><br><span class="line">proxychains sudo apt-get install build-essential curl git lib32stdc++-9-dev libc6-dev-i386 nodejs npm python3-dev python3-pip  <span class="comment"># 此处默认是安装最新的nodejs，frida和nodejs有一定的对应关系</span></span><br><span class="line">proxychains git <span class="built_in">clone</span> -b 16.2.1 --recurse-submodules https://github.com/frida/frida</span><br><span class="line"><span class="built_in">cd</span> frida</span><br><span class="line">sudo apt install m4</span><br><span class="line"><span class="comment"># 此处似乎就是报错</span></span><br><span class="line">proxychains make -f Makefile.toolchain.mk</span><br><span class="line"><span class="comment"># 手动下载需要的sdk版本，查看frida对应的版本</span></span><br><span class="line"><span class="built_in">cd</span> releng</span><br><span class="line"><span class="built_in">cat</span> deps.mk | <span class="built_in">head</span> -n 10 <span class="comment">#查看deps.mk的前10行，版本是 20240123</span></span><br><span class="line"><span class="comment"># 下载sdk，frida目录下载到/build</span></span><br><span class="line">sudo wget https://build.frida.re/deps/20240123/toolchain-linux-x86_64.tar.bz2</span><br><span class="line">sudo wget https://build.frida.re/deps/20240123/sdk-linux-x86_64.tar.bz2</span><br><span class="line">sudo wget https://build.frida.re/deps/20240123/sdk-android-arm64.tar.bz2</span><br><span class="line"><span class="comment"># /frida目录下执行</span></span><br><span class="line">./releng/setup-env.sh</span><br><span class="line"><span class="comment"># 手动下载需要的ndk版本，查看frida对应的版本，可随意下载目录，环境变量指定路径</span></span><br><span class="line"><span class="built_in">cd</span> releng</span><br><span class="line"><span class="built_in">cat</span> setup-env.sh | grep ndk</span><br><span class="line"><span class="comment"># 下载ndk官网地址：https://developer.android.com/ndk/downloads，具体名字看官网</span></span><br><span class="line">proxychains wget https://dl.google.com/android/repository/android-ndk-r22b-linux-x86_64.zip</span><br><span class="line">unzip xxx</span><br><span class="line"><span class="comment"># 配置ndk路径</span></span><br><span class="line">sudo gedit ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> ANDROID_NDK_ROOT=/XXX/XXX/android-ndk-r24</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$ANDROID_NDK_ROOT</span>:<span class="variable">$PATH</span></span><br><span class="line">ndk-build -v</span><br><span class="line"><span class="comment"># 下载对应版本的Node和npm，在github release有code的版本</span></span><br><span class="line">https://blog.csdn.net/John_Lenon/article/details/136155942?spm=1001.2014.3001.5506</span><br><span class="line"><span class="comment">#编译</span></span><br><span class="line">make core-android-arm64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再把手动下载的sdk放进去覆盖</span></span><br><span class="line">make clean</span><br><span class="line"><span class="built_in">rm</span> -rf build/</span><br><span class="line">frida/build/tmp-android-arm64/frida-core/server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注意注意：执行make clean时候会把自建的python文件删除</span><br></pre></td></tr></table></figure>

<h1 id="魔改Frida"><a href="#魔改Frida" class="headerlink" title="魔改Frida"></a>魔改Frida</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/hluwa/Patchs/tree/master/strongR-frida/frida-core</span><br><span class="line"></span><br><span class="line">根据gmain修改gdbus</span><br><span class="line">替换所有/data/local/tmp</span><br></pre></td></tr></table></figure>



<h1 id="ubuntu使用-v2"><a href="#ubuntu使用-v2" class="headerlink" title="ubuntu使用 v2"></a>ubuntu使用 v2</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install libfuse2</span><br><span class="line">wget https://github.com/v2ray/v2ray-core/releases/download/v4.27.0/v2ray-linux-64.zip</span><br><span class="line">wget https://github.com/Qv2ray/Qv2ray/releases/download/v2.6.3/Qv2ray.v2.6.3.linux-x64.AppImage</span><br><span class="line">unzip v2ray-linux-64.zip</span><br><span class="line">chmod +x Qv2ray.v2.6.3.linux-x64.AppImage</span><br><span class="line">./Qv2ray.v2.6.3.linux-x64.AppImage</span><br><span class="line"># 修改内核设置/可执行文件路径/资源目录</span><br><span class="line"></span><br><span class="line">hiddify</span><br></pre></td></tr></table></figure>





<h1 id="unidbg-模拟执行-SO"><a href="#unidbg-模拟执行-SO" class="headerlink" title="unidbg 模拟执行 SO"></a>unidbg 模拟执行 SO</h1><p>用起来啊，不然学个der</p>
<ul>
<li>框架本身开启打印日志，就能打印出RegisterNatives的方法，找到动态注册的方法，通过IDA跳转过去，hook_RegisterNative.js</li>
<li>jadx中tab键切换smail代码</li>
<li>java项目，直接导入idea</li>
<li>frida代码.$className 可查看类对象</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、AndroidEmulatorBuilder 指定包名初始化、指定SDK</span><br><span class="line">	sdk19 -&gt; Android 4(32位)</span><br><span class="line">	sdk23 -&gt; Android 6(64位)</span><br><span class="line">2、创建虚拟机，指定APK</span><br><span class="line">3、设定日志打印</span><br><span class="line">4、指定loadLibrary，不然要加载的so文件名字为libhookdemo.so，只需要写hookdemo</span><br><span class="line">5、根据包路径实例化类、初始化类</span><br><span class="line">6、方法调用，指定方法声明&amp;参数</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">androidEmulator = AndroidEmulatorBuilder</span><br><span class="line">                .for64Bit()</span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>))</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.xx&quot;</span>)</span><br><span class="line">                <span class="comment">//创建根目录，这里是根目录是用项目目录模拟手机的/data目录</span></span><br><span class="line">                .setRootDir(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/rootfs&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">memory = androidEmulator.getMemory();</span><br><span class="line">memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">dalvikVM= androidEmulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/fuck/xx.apk&quot;</span>));</span><br><span class="line">dalvikVM.setJni(<span class="built_in">this</span>);</span><br><span class="line">dalvikVM.setVerbose(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 去掉前后留存的中间的名字 libtestdemo.so</span></span><br><span class="line">dalvikModule = dalvikVM.loadLibrary(<span class="string">&quot;test&quot;</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">module</span> = dalvikModule.getModule();</span><br><span class="line"><span class="comment">// 转化为16进制才是IDA看的地址，默认前面会加上unidbg的字符</span></span><br><span class="line">System.out.println(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;Java_com_example_hookdemo_MainActivity_tesucanshu_1jni&quot;</span>).getAddress());</span><br><span class="line">dalvikModule.callJNI_OnLoad(androidEmulator);</span><br></pre></td></tr></table></figure>

<p>JNI参数类型</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/54a0b7ccc35e">https://www.jianshu.com/p/54a0b7ccc35e</a></p>
<h2 id="主动调用-amp-特殊参数"><a href="#主动调用-amp-特殊参数" class="headerlink" title="主动调用&amp;特殊参数"></a>主动调用&amp;特殊参数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">calltesucanshu_dizhi</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DvmClass</span> <span class="variable">dvmClass</span> <span class="operator">=</span> dalvikVM.resolveClass(<span class="string">&quot;com.example.xx.MainActivity&quot;</span>);</span><br><span class="line">        DvmObject&lt;?&gt; dvmObject = dvmClass.newObject(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;String&gt; list3 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list3.add(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        list3.add(<span class="string">&quot;test2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ArrayListObject</span> <span class="variable">arrayListObject</span> <span class="operator">=</span> ArrayListObject.newStringList(dalvikVM,<span class="string">&quot;test1&quot;</span>,<span class="string">&quot;test2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Integer, String&gt; Sites3 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Sites3.put(<span class="number">1</span>, <span class="string">&quot;Google&quot;</span>);</span><br><span class="line">        Sites3.put(<span class="number">2</span>, <span class="string">&quot;Runoob&quot;</span>);</span><br><span class="line">        DvmObject&lt;?&gt; object_Sites3 = ProxyDvmObject.createObject(dalvikVM, Sites3);</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(dalvikVM.getJNIEnv());</span><br><span class="line">        list.add(<span class="number">0</span>);</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 基本数据类型直接添加，复杂/对象类需要添加到虚拟机</span></span><br><span class="line">        list.add(dalvikVM.addGlobalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(dalvikVM,<span class="string">&quot;11111&quot;</span>)));</span><br><span class="line">        list.add(dalvikVM.addGlobalObject(ProxyDvmObject.createObject(dalvikVM,<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">2</span>&#125;)));</span><br><span class="line">        list.add(dalvikVM.addGlobalObject(dalvikVM.resolveClass(<span class="string">&quot;com.example.xx.Person&quot;</span>).newObject(<span class="literal">null</span>)));</span><br><span class="line">        list.add(dalvikVM.addGlobalObject(arrayListObject));</span><br><span class="line">        list.add(dalvikVM.addGlobalObject(object_Sites3));</span><br><span class="line">        list.add(dalvikVM.addGlobalObject(ProxyDvmObject.createObject(dalvikVM,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;nihao&quot;</span>, <span class="string">&quot;shijie&quot;</span>&#125;)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 参考 module/emulateFunction，通过地址调用SO函数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span><span class="keyword">module</span>.callFunction(androidEmulator,<span class="number">0x63BBC</span>,list.toArray()).intValue();</span><br><span class="line">        System.out.println(<span class="string">&quot;111-&gt;&quot;</span>+number);</span><br><span class="line">        System.out.println(dalvikVM.getObject(number));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="JNI补环境"><a href="#JNI补环境" class="headerlink" title="JNI补环境"></a>JNI补环境</h2><p>日志打印模式，src&#x2F;test&#x2F;resources&#x2F;log4j.properties 修改test文件下debug</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testJNI</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator androidEmulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Memory memory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM dalvikVM;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DalvikModule dalvikModule;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">testJNI</span><span class="params">()</span> &#123;</span><br><span class="line">        androidEmulator = AndroidEmulatorBuilder</span><br><span class="line">                .for64Bit()</span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>))</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.hookdemo&quot;</span>)</span><br><span class="line">                <span class="comment">//创建根目录</span></span><br><span class="line">                .setRootDir(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/rootfs&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">        memory = androidEmulator.getMemory();</span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        dalvikVM = androidEmulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/lesson/testJNI/app-debug.apk&quot;</span>));</span><br><span class="line">        dalvikVM.setJni(<span class="built_in">this</span>);</span><br><span class="line">        dalvikVM.setVerbose(<span class="literal">true</span>);</span><br><span class="line">        dalvikModule = dalvikVM.loadLibrary(<span class="string">&quot;hookdemo&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">module</span> = dalvikModule.getModule();</span><br><span class="line">        dalvikModule.callJNI_OnLoad(androidEmulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">testJNI</span> <span class="variable">testJNI</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">testJNI</span>();</span><br><span class="line">        testJNI.callgetHash();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; allocObject(BaseVM vm, DvmClass dvmClass, String signature) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/example/hookdemo/Person-&gt;allocObject&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> dvmClass.newObject(signature);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.allocObject(vm, dvmClass, signature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callgetHash</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DvmClass</span> <span class="variable">dvmClass</span> <span class="operator">=</span> dalvikVM.resolveClass(<span class="string">&quot;com.example.hookdemo.MainActivity&quot;</span>);</span><br><span class="line">        <span class="comment">// String p5 = getApplicationContext().getpackageCodePath();</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">apk_path</span> <span class="operator">=</span> <span class="string">&quot;/data/app/com.example.hookdemo-qmoUcGSJuvbQaByYAxdvOg==/base.apk&quot;</span>;</span><br><span class="line">        <span class="type">DvmObject</span> <span class="variable">dvmObject</span> <span class="operator">=</span> dvmClass.newObject(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">DvmObject</span> <span class="variable">dvmObject1</span> <span class="operator">=</span> dvmObject.callJniMethodObject(androidEmulator, <span class="string">&quot;getHash(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, apk_path);</span><br><span class="line">        System.out.println(dvmObject1.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;</span>:&#123;</span><br><span class="line">                <span class="comment">// return vm.resolveClass(&quot;java/util/zip/ZipFile&quot;).newObject(signature);</span></span><br><span class="line">                <span class="comment">// 没有具体调用方法就new，括号内是参数类型</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> (String) vaList.getObjectArg(<span class="number">0</span>).getValue();</span><br><span class="line">                <span class="keyword">if</span>(path.equals(<span class="string">&quot;/data/app/com.example.hookdemo-qmoUcGSJuvbQaByYAxdvOg==/base.apk&quot;</span>))&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipFile</span>(<span class="string">&quot;unidbg-android/src/test/java/lesson/testJNI/app-debug.apk&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/util/zip/ZipFile&quot;</span>).newObject(zipFile);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.newObjectV(vm, dvmClass, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;&quot;</span>:&#123;</span><br><span class="line">                <span class="comment">// dvmObject获取当前对象</span></span><br><span class="line">                <span class="comment">// signature 是package</span></span><br><span class="line">                <span class="comment">// vaList获取参数</span></span><br><span class="line">                <span class="comment">// 此处无括号是返回类型</span></span><br><span class="line">                <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> (ZipFile) dvmObject.getValue();</span><br><span class="line">                Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries = zipFile.entries();</span><br><span class="line">                <span class="comment">// java内置zip</span></span><br><span class="line">                <span class="type">DvmClass</span> <span class="variable">ZipEntryClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;java/util/zip/ZipEntry&quot;</span>);</span><br><span class="line"></span><br><span class="line">                List&lt;DvmObject&lt;?&gt;&gt; objs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="keyword">while</span> (entries.hasMoreElements())&#123;</span><br><span class="line">                    <span class="type">ZipEntry</span> <span class="variable">zipEntry</span> <span class="operator">=</span> entries.nextElement();</span><br><span class="line">                    objs.add(ZipEntryClass.newObject(zipEntry));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">com</span>.github.unidbg.linux.android.dvm.Enumeration(dalvikVM,objs);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipEntry-&gt;getName()Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">zipEntry</span> <span class="operator">=</span> (ZipEntry) dvmObject.getValue();</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> zipEntry.getName();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(dalvikVM,name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;getInputStream(Ljava/util/zip/ZipEntry;)Ljava/io/InputStream;&quot;</span>: &#123;</span><br><span class="line">                <span class="comment">// 括号内是参数类型，外边是返回类型</span></span><br><span class="line">                <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> (ZipFile) dvmObject.getValue();</span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">zipEntry</span> <span class="operator">=</span> (ZipEntry) vaList.getObjectArg(<span class="number">0</span>).getValue();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> zipFile.getInputStream(zipEntry);</span><br><span class="line">                    <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/io/InputStream&quot;</span>).newObject(inputStream);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/security/MessageDigest-&gt;digest()[B&quot;</span>:&#123;</span><br><span class="line">                <span class="comment">// 返回类型是byte</span></span><br><span class="line">                <span class="type">MessageDigest</span> <span class="variable">messageDigest</span> <span class="operator">=</span> (MessageDigest) dvmObject.getValue();</span><br><span class="line">                <span class="type">byte</span>[] digest = messageDigest.digest();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(dalvikVM,digest);</span><br><span class="line">            &#125;</span><br><span class="line">                <span class="comment">// 仿写</span></span><br><span class="line"><span class="comment">//case &quot;android/app/ActivityThread-&gt;getApplication()Landroid/app/Application;&quot;:</span></span><br><span class="line">	<span class="comment">//return vm.resolveClass(&quot;android/app/Application&quot;,</span></span><br><span class="line">			<span class="comment">//vm.resolveClass(&quot;android/content/ContextWrapper&quot;,</span></span><br><span class="line">					<span class="comment">//vm.resolveClass(&quot;android/content/Context&quot;))).newObject(signature);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">callIntMethodV</span><span class="params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/io/InputStream-&gt;read([B)I&quot;</span>:&#123;</span><br><span class="line">                <span class="comment">// 参数byte，默认返回</span></span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> (InputStream) dvmObject.getValue();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> inputStream.read((<span class="type">byte</span>[]) vaList.getObjectArg(<span class="number">0</span>).getValue());</span><br><span class="line">                    <span class="keyword">return</span> read;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callIntMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callVoidMethodV</span><span class="params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/security/MessageDigest-&gt;update([B)V&quot;</span>:&#123;</span><br><span class="line">                <span class="type">MessageDigest</span> <span class="variable">messageDigest</span> <span class="operator">=</span> (MessageDigest) dvmObject.getValue();</span><br><span class="line">                messageDigest.update((<span class="type">byte</span>[]) vaList.getObjectArg(<span class="number">0</span>).getValue());</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/io/InputStream-&gt;close()V&quot;</span> :&#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> (InputStream) dvmObject.getValue();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.callVoidMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="IDA-编译名转换"><a href="#IDA-编译名转换" class="headerlink" title="IDA 编译名转换"></a>IDA 编译名转换</h2><p><a target="_blank" rel="noopener" href="http://demangler.com/">http://demangler.com/</a></p>
<h2 id="Dobby-amp-Unicorn"><a href="#Dobby-amp-Unicorn" class="headerlink" title="Dobby&amp;Unicorn"></a>Dobby&amp;Unicorn</h2><p>需要在onload之前hook</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> = dalvikModule.getModule();</span><br><span class="line">hookDobby();</span><br><span class="line">hookUnicorn();</span><br><span class="line"><span class="comment">//相当于在SO加载前hook已经生效，但未实际调用，待后续调用时才触发hook</span></span><br><span class="line">dalvikModule.callJNI_OnLoad(androidEmulator);</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookUnicorn</span><span class="params">()</span> &#123;</span><br><span class="line">	androidEmulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;AES_ECB_PKCS7_Encrypt&quot;</span>).getAddress(), <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">			System.out.println(emulator.getContext().getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>));</span><br><span class="line">			emulator.getBackend().reg_write(Arm64Const.UC_ARM64_REG_PC,emulator.getContext().getLRPointer().peer);</span><br><span class="line">            		<span class="comment">//修改入参</span></span><br><span class="line">			emulator.getBackend().reg_write(Arm64Const.UC_ARM64_REG_X0,<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hookDobby</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Dobby</span> <span class="variable">dobby</span> <span class="operator">=</span> Dobby.getInstance(androidEmulator);</span><br><span class="line">    dobby.replace(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;AES_ECB_PKCS7_Encrypt&quot;</span>).getAddress(), <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123;</span><br><span class="line">            <span class="comment">//System.out.println(&quot;jinru&quot;);</span></span><br><span class="line">            <span class="comment">//获取参数</span></span><br><span class="line">            <span class="comment">//类似于hexdump</span></span><br><span class="line">            <span class="comment">//Inspector.inspect(context.getPointerArg(1).getByteArray(0,100),&quot;教学&quot;);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//修改参数</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fakeargs1</span> <span class="operator">=</span> <span class="string">&quot;Hello world&quot;</span>;</span><br><span class="line">            <span class="comment">//得到长度</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> fakeargs1.length();</span><br><span class="line">            <span class="comment">//开辟一段内存空间</span></span><br><span class="line">            <span class="type">MemoryBlock</span> <span class="variable">fakeargs1malloc</span> <span class="operator">=</span> emulator.getMemory().malloc(length, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//往内存空间写入数据</span></span><br><span class="line">            fakeargs1malloc.getPointer().write(fakeargs1.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">//映射到寄存器</span></span><br><span class="line">            emulator.getBackend().reg_write(Arm64_const.ARM64_REG_X0,fakeargs1malloc.getPointer().peer);</span><br><span class="line">            <span class="comment">//String arg1 = context.getPointerArg(0).getString(0);</span></span><br><span class="line">            <span class="comment">//System.out.println(&quot;第一个参数-&gt;&quot;+arg1);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//context.push(context.getPointerArg(1));</span></span><br><span class="line">            <span class="comment">//emulator.getBackend().reg_write(Arm64_const.ARM64_REG_X0,0);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//return super.onCall(emulator, context, context.getLR());</span></span><br><span class="line">            <span class="keyword">return</span> HookStatus.RET(emulator,context.getLR());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//得到返回值</span></span><br><span class="line">            <span class="comment">//System.out.println(context.getPointerArg(0).getString(0));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//修改返回值</span></span><br><span class="line">            <span class="comment">//String fakeargs1 = &quot;Hello world&quot;;</span></span><br><span class="line">            <span class="comment">//得到长度</span></span><br><span class="line">            <span class="comment">//int length = fakeargs1.length();</span></span><br><span class="line">            <span class="comment">//开辟一段内存空间</span></span><br><span class="line">            <span class="comment">//MemoryBlock fakeargs1malloc = emulator.getMemory().malloc(length, true);</span></span><br><span class="line">            <span class="comment">//往内存空间写入数据</span></span><br><span class="line">		    <span class="comment">//fakeargs1malloc.getPointer().write(fakeargs1.getBytes(StandardCharsets.UTF_8));</span></span><br><span class="line">            <span class="comment">//映射到寄存器</span></span><br><span class="line">		    <span class="comment">//emulator.getBackend().reg_write(Arm64_const.ARM64_REG_X0,fakeargs1malloc.getPointer().peer);</span></span><br><span class="line">            <span class="comment">//Pointer pop = context.pop();</span></span><br><span class="line">            <span class="comment">//System.out.println(&quot;离开函数查看第二个参数-&gt;&quot;+pop.getString(0));</span></span><br><span class="line">            <span class="built_in">super</span>.postCall(emulator, context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="path-so"><a href="#path-so" class="headerlink" title="path_so"></a>path_so</h2><p><a target="_blank" rel="noopener" href="https://armconverter.com/">https://armconverter.com/</a></p>
<p>这个path的功能能否用hook实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">patch1</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> UnidbgPointer.pointer(androidEmulator, <span class="keyword">module</span>.base + <span class="number">0xE444</span>);</span><br><span class="line">	<span class="type">byte</span>[] code = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0x40</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x34</span>&#125;;</span><br><span class="line">	pointer.write(code);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">patch2</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> UnidbgPointer.pointer(androidEmulator, <span class="keyword">module</span>.base + <span class="number">0xE444</span>);</span><br><span class="line">	<span class="type">Keystone</span> <span class="variable">keystone</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Keystone</span>(KeystoneArchitecture.Arm64, KeystoneMode.LittleEndian);</span><br><span class="line">	<span class="type">String</span> <span class="variable">huibian</span> <span class="operator">=</span> <span class="string">&quot;cbz w0, #0x28&quot;</span>; <span class="comment">// 40010034</span></span><br><span class="line">	<span class="type">byte</span>[] machineCode = keystone.assemble(huibian).getMachineCode();</span><br><span class="line">	pointer.write(machineCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="文件访问-IO-流补环境"><a href="#文件访问-IO-流补环境" class="headerlink" title="文件访问 IO 流补环境"></a>文件访问 IO 流补环境</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testIO</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> <span class="keyword">implements</span> <span class="title class_">IOResolver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator androidEmulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Memory memory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM dalvikVM;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DalvikModule dalvikModule;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">testIO</span><span class="params">()</span> &#123;</span><br><span class="line">        androidEmulator = AndroidEmulatorBuilder</span><br><span class="line">                .for64Bit()</span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>))</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.hookdemo&quot;</span>)</span><br><span class="line">                <span class="comment">//创建根目录</span></span><br><span class="line">                .setRootDir(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/rootfs&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">        memory = androidEmulator.getMemory();</span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        dalvikVM = androidEmulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/lesson/testIO/app-debug.apk&quot;</span>));</span><br><span class="line">        dalvikVM.setJni(<span class="built_in">this</span>);</span><br><span class="line">        dalvikVM.setVerbose(<span class="literal">true</span>);</span><br><span class="line">        dalvikModule = dalvikVM.loadLibrary(<span class="string">&quot;hookdemo&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        androidEmulator.getSyscallHandler().addIOResolver(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">//androidEmulator.getSyscallHandler().addIOResolver(new buwenjian());</span></span><br><span class="line">        <span class="keyword">module</span> = dalvikModule.getModule();</span><br><span class="line">        dalvikModule.callJNI_OnLoad(androidEmulator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">testIO</span> <span class="variable">testIO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">testIO</span>();</span><br><span class="line">        testIO.jiance_xp_frida();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">jiance_xp_frida</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DvmClass</span> <span class="variable">dvmClass</span> <span class="operator">=</span> dalvikVM.resolveClass(<span class="string">&quot;com.example.hookdemo.MainActivity&quot;</span>);</span><br><span class="line">        DvmObject&lt;?&gt; dvmObject = dvmClass.newObject(<span class="literal">null</span>);</span><br><span class="line">        DvmObject&lt;?&gt; dvmObject1 = dvmObject.callJniMethodObject(androidEmulator, <span class="string">&quot;jiance_xp_frida()Ljava/lang/String;&quot;</span>);</span><br><span class="line">        System.out.println(dvmObject1.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileResult <span class="title function_">resolve</span><span class="params">(Emulator emulator, String pathname, <span class="type">int</span> oflags)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (pathname)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;/sys/class/thermal/&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> FileResult.&lt;AndroidFileIO&gt;success(<span class="keyword">new</span> <span class="title class_">DirectoryFileIO</span>(oflags,pathname,<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/rootfs/sys/class/thermal&quot;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;/data&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> FileResult.failed(UnixEmulator.EACCES);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;/proc/self/cmdline&quot;</span>:&#123;</span><br><span class="line">                <span class="comment">//return FileResult.&lt;AndroidFileIO&gt;success(new SimpleFileIO(oflags,new File(&quot;unidbg-android/src/test/java/com/lesson/testIO/cmdline&quot;),pathname ));</span></span><br><span class="line">                <span class="keyword">return</span> FileResult.&lt;AndroidFileIO&gt;success(<span class="keyword">new</span> <span class="title class_">ByteArrayFileIO</span>(oflags,pathname,<span class="string">&quot;com.example.hookdemo\0&quot;</span>.getBytes()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;/proc/self/maps&quot;</span>:&#123;</span><br><span class="line">                <span class="comment">//return FileResult.&lt;AndroidFileIO&gt;success(new MapsFileIO(emulator,oflags,pathname,emulator.getMemory().getLoadedModules()));</span></span><br><span class="line">                <span class="keyword">return</span> FileResult.&lt;AndroidFileIO&gt;success(<span class="keyword">new</span> <span class="title class_">SimpleFileIO</span>(oflags,<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/lesson/testIO/maps&quot;</span>),pathname ));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;file open-&gt; &quot;</span>+pathname);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="系统补环境"><a href="#系统补环境" class="headerlink" title="系统补环境"></a>系统补环境</h2><p><a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md">https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md</a></p>
<p>判断是JNI调用还是系统调用</p>
<ul>
<li>svcNumber&#x3D;0x0的是系统调用，NR调用号，ARM64调用号</li>
<li>补环境要补哪个方法，根据NR调用号决定</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">JNI</span><br><span class="line">[<span class="number">17</span>:<span class="number">19</span>:<span class="number">05</span> <span class="number">115</span>]  WARN [com.github.unidbg.linux.ARM64SyscallHandler] (ARM64SyscallHandler:<span class="number">399</span>) - handleInterrupt </span><br><span class="line">intno=<span class="number">2</span>, NR=-<span class="number">128672</span>, </span><br><span class="line">svcNumber=<span class="number">0x18d</span>, PC=unidbg@<span class="number">0xfffe0964</span>, LR=RX@<span class="number">0x40012b88</span>[libhookdemo.so]<span class="number">0x12b88</span>, syscall=<span class="literal">null</span></span><br><span class="line">java.lang.UnsupportedOperationException: android/os/Build-&gt;MODEL:Ljava/lang/String;</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:<span class="number">103</span>)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:<span class="number">53</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">调用到系统API：</span><br><span class="line">[<span class="number">17</span>:<span class="number">22</span>:<span class="number">56</span> <span class="number">521</span>]  WARN [com.github.unidbg.linux.ARM64SyscallHandler] (ARM64SyscallHandler:<span class="number">399</span>) - handleInterrupt </span><br><span class="line">intno=<span class="number">2</span>, </span><br><span class="line">NR=<span class="number">165</span>, </span><br><span class="line">svcNumber=<span class="number">0x0</span>, PC=RX@<span class="number">0x401ca3d4</span>[libc.so]<span class="number">0x6a3d4</span>, LR=RX@<span class="number">0x40011f28</span>[libhookdemo.so]<span class="number">0x11f28</span>, syscall=<span class="literal">null</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>补系统的环境：</p>
<h3 id="1、硬编码返回"><a href="#1、硬编码返回" class="headerlink" title="1、硬编码返回"></a>1、硬编码返回</h3><p>hook下某个系统API的返回值，按一定格式返回</p>
<table>
<thead>
<tr>
<th>NR</th>
<th>syscall name</th>
<th>references</th>
<th>%rax</th>
<th>arg0 (%rdi)</th>
<th>arg1 (%rsi)</th>
<th>arg2 (%rdx)</th>
<th>arg3 (%r10)</th>
</tr>
</thead>
<tbody><tr>
<td>165</td>
<td>getrusage</td>
<td>man&#x2F; cs&#x2F;</td>
<td>0xa5</td>
<td>int who</td>
<td>struct rusage *ru</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;getrusage&quot;</span>), &#123;</span><br><span class="line">    onEnter: function (args) &#123;</span><br><span class="line">        <span class="built_in">this</span>.rusage = args[<span class="number">1</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    onLeave: function (retval) &#123;</span><br><span class="line">        console.log(hexdump(<span class="built_in">this</span>.rusage,&#123;length: <span class="number">144</span>&#125;))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// hook到的系统API返回的内存值</span></span><br><span class="line">7ff4b68f58  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">70</span> f3 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ........p.......                   </span><br><span class="line">7ff4b68f68  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">30</span> <span class="number">57</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ........0W......                   </span><br><span class="line">7ff4b68f78  <span class="number">10</span> <span class="number">64</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  .d..............                   </span><br><span class="line">7ff4b68f88  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................                   </span><br><span class="line">7ff4b68f98  ff a5 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">98</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................                   </span><br><span class="line">7ff4b68fa8  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f0 7e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  .........~......                   </span><br><span class="line">7ff4b68fb8  <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................                   </span><br><span class="line">7ff4b68fc8  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line">7ff4b68fd8  b8 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 5c <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ........\.......</span><br></pre></td></tr></table></figure>

 <img src="/2025/03/08/Notes-Android-II/01.png" class title="This is an example image">

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HookDemoArm64SysCallHandler.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HookDemoArm64SysCallHandler</span> <span class="keyword">extends</span> <span class="title class_">ARM64SyscallHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HookDemoArm64SysCallHandler</span><span class="params">(SvcMemory svcMemory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(svcMemory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">handleUnknownSyscall</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">int</span> NR)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (NR)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">165</span>:</span><br><span class="line">                getrusage(emulator);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.handleUnknownSyscall(emulator, NR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getrusage</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">register</span> <span class="operator">=</span> UnidbgPointer.register(emulator, Arm64Const.UC_ARM64_REG_X1);</span><br><span class="line">        <span class="type">byte</span>[] bytes = hexStringToByteArray(<span class="string">&quot;010000000000000020300500000000000000000000000000e022020000000000149a0100000000000000000000000000000000000000000000000000000000008663000000000000ac190000000000000000000000000000382f000000000000000000000000000000000000000000000000000000000000000000000000000075010000000000009800000000000000&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;bytes.length;i++)&#123;</span><br><span class="line">            register.setByte(i,bytes[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将十六进制字符串转换为字节数组的函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] hexStringToByteArray(String hexString) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> hexString.length();</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[len / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">            data[i / <span class="number">2</span>] = (<span class="type">byte</span>) ((Character.digit(hexString.charAt(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">                    + Character.digit(hexString.charAt(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">clock_gettime</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">        <span class="type">RegisterContext</span> <span class="variable">context</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">        <span class="type">int</span> <span class="variable">clk_id</span> <span class="operator">=</span> context.getIntArg(<span class="number">0</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">        <span class="type">Pointer</span> <span class="variable">tp</span> <span class="operator">=</span> context.getPointerArg(<span class="number">1</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> clk_id == <span class="number">0</span> ? currentTimeMillis() * <span class="number">1000000L</span> : System.nanoTime() - System.nanoTime();</span><br><span class="line">        <span class="type">long</span> <span class="variable">tv_sec</span> <span class="operator">=</span> offset / <span class="number">1000000000L</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">tv_nsec</span> <span class="operator">=</span> offset % <span class="number">1000000000L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (clk_id) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                tp.setLong(<span class="number">0</span>, tv_sec);</span><br><span class="line">                tp.setLong(<span class="number">8</span>, tv_nsec);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.clock_gettime(emulator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">lesson11</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> <span class="keyword">implements</span> <span class="title class_">IOResolver</span> &#123;</span><br><span class="line">    <span class="comment">//定义一个全局可用的模拟器对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> AndroidEmulator androidEmulatorBuilder;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> DalvikModule dalvikModule;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Memory memory;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个构造函数进行初始化操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">lesson11</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AndroidEmulatorBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AndroidEmulatorBuilder</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> AndroidEmulator <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AndroidARM64Emulator</span>(processName, rootDir, backendFactories) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> UnixSyscallHandler&lt;AndroidFileIO&gt; <span class="title function_">createSyscallHandler</span><span class="params">(SvcMemory svcMemory)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HookDemoArm64SysCallHandler</span>(svcMemory);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化模拟器</span></span><br><span class="line"><span class="comment">//        androidEmulatorBuilder = AndroidEmulatorBuilder</span></span><br><span class="line"><span class="comment">//                .for64Bit()</span></span><br><span class="line"><span class="comment">//                .setProcessName(&quot;com.example.hookdemo&quot;)</span></span><br><span class="line"><span class="comment">//                .addBackendFactory(new Unicorn2Factory(true))</span></span><br><span class="line"><span class="comment">//                .setRootDir(new File(&quot;target/rootfs&quot;))</span></span><br><span class="line"><span class="comment">//                .build();</span></span><br><span class="line"></span><br><span class="line">        androidEmulatorBuilder = builder</span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>))</span><br><span class="line">                .setRootDir(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/rootfs&quot;</span>))</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.example.hookdemo&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        vm = androidEmulatorBuilder.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/lesson/lesson11/app-debug.apk&quot;</span>));</span><br><span class="line">        vm.setJni(<span class="built_in">this</span>);</span><br><span class="line">        vm.setVerbose(<span class="literal">true</span>);</span><br><span class="line">        androidEmulatorBuilder.getSyscallHandler().addIOResolver(<span class="built_in">this</span>);</span><br><span class="line">        memory = androidEmulatorBuilder.getMemory();</span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// getprop ro.build.id</span></span><br><span class="line">        <span class="type">SystemPropertyHook</span> <span class="variable">systemPropertyHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemPropertyHook</span>(androidEmulatorBuilder);</span><br><span class="line">        systemPropertyHook.setPropertyProvider(<span class="keyword">new</span> <span class="title class_">SystemPropertyProvider</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getProperty</span><span class="params">(String key)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;getProperty systemkey:&quot;</span> + key);</span><br><span class="line">                <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;net.hostname&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;MIX2S-zhongeryayadeM&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.serialno&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;f8a995f5&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.boot.serialno&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;f8a995f5&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.product.brand&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;Xiaomi&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.product.manufacturer&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;Xiaomi&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.product.model&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;MIX 2S&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.product.cpu.abi&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;arm64-v8a&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.product.cpu.abilist&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;arm64-v8a,armeabi-v7a,armeabi&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.boot.vbmeta.digest&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;init.svc.droid4x&quot;</span>: &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;ro.build.id&quot;</span>:&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;PKQ1.190118.001&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        memory.addHookListener(systemPropertyHook);</span><br><span class="line">        dalvikModule = vm.loadLibrary(<span class="string">&quot;hookdemo&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">module</span> = dalvikModule.getModule();</span><br><span class="line">        dalvikModule.callJNI_OnLoad(androidEmulatorBuilder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">lesson11</span> <span class="variable">lesson11</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">lesson11</span>();</span><br><span class="line">        lesson11.setEnv();</span><br><span class="line">        lesson11.hookgetEnv();</span><br><span class="line">        lesson11.xitongdiaoyong();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">xitongdiaoyong</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DvmClass</span> <span class="variable">dvmClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com.example.hookdemo.MainActivity&quot;</span>);</span><br><span class="line">        DvmObject&lt;?&gt; dvmObject = dvmClass.newObject(<span class="literal">null</span>);</span><br><span class="line">        dvmObject.callJniMethod(androidEmulatorBuilder, <span class="string">&quot;xitongdiaoyong()V&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileResult <span class="title function_">resolve</span><span class="params">(Emulator emulator, String pathname, <span class="type">int</span> oflags)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;file open:&quot;</span> + pathname);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/os/Build-&gt;MODEL:Ljava/lang/String;&quot;</span>: &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;MI 6&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getStaticObjectField(vm, dvmClass, signature);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileResult <span class="title function_">resolve</span><span class="params">(Emulator emulator, String pathname, <span class="type">int</span> oflags)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;file open:&quot;</span> + pathname);</span><br><span class="line">        <span class="keyword">switch</span> (pathname)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;stat /data&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> <span class="title class_">ByteArrayFileIO</span>(oflags,pathname,(<span class="string">&quot;  File: `/data&#x27;\n&quot;</span> +</span><br><span class="line">                                                                               <span class="string">&quot;  Size: 4096\t Blocks: 16\t IO Blocks: 512\tdirectory\n&quot;</span> +</span><br><span class="line">                                                                               <span class="string">&quot;Device: 10301h/66305d\t Inode: 2\t Links: 46\n&quot;</span> +</span><br><span class="line">                                                                               <span class="string">&quot;Access: (771/drwxrwx--x)\tUid: ( 1000/  system)\tGid: ( 1000/  system)\n&quot;</span> +</span><br><span class="line">                                                                               <span class="string">&quot;Access: 2019-08-22 00:32:54.000000000\n&quot;</span> +</span><br><span class="line">                                                                               <span class="string">&quot;Modify: 2023-05-29 08:37:38.813999995\n&quot;</span> +</span><br><span class="line">                                                                               <span class="string">&quot;Change: 1970-08-12 09:44:20.749999999\n&quot;</span>).getBytes()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/os/Build-&gt;MODEL:Ljava/lang/String;&quot;</span>: &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;MI 6&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getStaticObjectField(vm, dvmClass, signature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置环境变量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnv</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Symbol</span> <span class="variable">setenv</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;setenv&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        setenv.call(androidEmulatorBuilder, <span class="string">&quot;muyang&quot;</span>, <span class="string">&quot;6666&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">	<span class="comment">// hook并修改环境变量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hookgetEnv</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Dobby</span> <span class="variable">dobby</span> <span class="operator">=</span> Dobby.getInstance(androidEmulatorBuilder);</span><br><span class="line">        dobby.replace(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;getenv&quot;</span>), <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123;</span><br><span class="line">                emulator.set(<span class="string">&quot;envkey&quot;</span>, context.getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>));</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator, context, originFunction);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> emulator.get(<span class="string">&quot;envkey&quot;</span>);</span><br><span class="line">                <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;muyang&quot;</span>:</span><br><span class="line">                        <span class="comment">//修改返回值</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">fakeInput</span> <span class="operator">=</span> <span class="string">&quot;6666&quot;</span>;</span><br><span class="line">                        <span class="comment">//得到长度</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> fakeInput.length();</span><br><span class="line">                        <span class="comment">//开辟一段内存空间  长度是字符串的长度</span></span><br><span class="line">                        <span class="type">MemoryBlock</span> <span class="variable">fakeInputBlock</span> <span class="operator">=</span> emulator.getMemory().malloc(length, <span class="literal">true</span>);</span><br><span class="line">                        <span class="comment">//往开辟的内存空间中写入byte数据</span></span><br><span class="line">                        fakeInputBlock.getPointer().write(fakeInput.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                        <span class="comment">//再通过得到寄存器的方式  去写入进去</span></span><br><span class="line">                        emulator.getBackend().reg_write(Arm64Const.UC_ARM64_REG_X0, fakeInputBlock.getPointer().peer);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">super</span>.postCall(emulator, context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hookPopen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Dobby</span> <span class="variable">dobby</span> <span class="operator">=</span> Dobby.getInstance(androidEmulatorBuilder);</span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">stat_data_pointer</span> <span class="operator">=</span> UnidbgPointer.pointer(androidEmulatorBuilder, <span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;fopen&quot;</span>).call(androidEmulatorBuilder, <span class="string">&quot;stat /data&quot;</span>, <span class="string">&quot;r&quot;</span>));</span><br><span class="line"></span><br><span class="line">        dobby.replace(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;popen&quot;</span>), <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> originFunction)</span> &#123;</span><br><span class="line">                <span class="type">RegisterContext</span> <span class="variable">registerContext</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">                <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> registerContext.getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;command:&quot;</span> + command);</span><br><span class="line"></span><br><span class="line">                emulator.getBackend().reg_write(Arm64Const.UC_ARM64_REG_PC,registerContext.getLRPointer().peer);</span><br><span class="line">                <span class="keyword">switch</span> (command)&#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;stat /data&quot;</span>:&#123;</span><br><span class="line">                        emulator.getBackend().reg_write(Arm64Const.UC_ARM64_REG_X0,stat_data_pointer.peer);</span><br><span class="line">                        <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator, originFunction);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator, originFunction);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 <img src="/2025/03/08/Notes-Android-II/02.png" class title="This is an example image">

<p>打开调试模式可查看更详细报错</p>
<h3 id="2、仿写框架"><a href="#2、仿写框架" class="headerlink" title="2、仿写框架"></a>2、仿写框架</h3><p>根据unidbg提供的补其他系统API的例子写</p>
<p>访写 src&#x2F;main&#x2F;java&#x2F;com&#x2F;github&#x2F;unidbg&#x2F;ios&#x2F;ARM64SyscallHandler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getrusage</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">	<span class="type">RegisterContext</span> <span class="variable">context</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">	<span class="type">int</span> <span class="variable">who</span> <span class="operator">=</span> context.getIntArg(<span class="number">0</span>);</span><br><span class="line">	<span class="type">Pointer</span> <span class="variable">r_usage</span> <span class="operator">=</span> context.getPointerArg(<span class="number">1</span>);</span><br><span class="line">	<span class="type">RUsage64</span> <span class="variable">usage64</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RUsage64</span>(r_usage);</span><br><span class="line">	usage64.unpack();</span><br><span class="line">	usage64.fillDefault();</span><br><span class="line">	usage64.pack();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272751.html">https://bbs.kanxue.com/thread-272751.html</a></p>
<p><a target="_blank" rel="noopener" href="https://buaq.net/go-129256.html">https://buaq.net/go-129256.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/gl953236368">https://github.com/gl953236368</a></p>
<p>函数初始化</p>
<p>trace工具</p>
<p>Java层trace工具：<a target="_blank" rel="noopener" href="https://github.com/r0ysue/r0tracer">https://github.com/r0ysue/r0tracer</a></p>
<p>Jnitrace：<a target="_blank" rel="noopener" href="https://github.com/chame1eon/jnitrace">https://github.com/chame1eon/jnitrace</a></p>
<p>所以unidbg就是用来不运行app的情况下，调用so方法，补环境属于其中的前置环境</p>
<p>dump apk上下文环境</p>
<p>慢慢看吧案例</p>
<p><a target="_blank" rel="noopener" href="https://blog.seeflower.dev/search/dump/2/">https://blog.seeflower.dev/search/dump/2/</a></p>
<p>test</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">https://www.jianshu.com/p/c546783ad284</span><br><span class="line">https://developer.android.com/ndk/guides/other_build_systems?hl=zh-cn</span><br><span class="line">https://www.cnblogs.com/burner/p/clang-fen-si-bu-bian-yimainc.html   编译博客也不错</span><br><span class="line">https://blog.csdn.net/qq_31865983/article/details/89402100    这个更加完整一点</span><br><span class="line">https://github.com/hugsy/gef</span><br><span class="line">https://www.likecs.com/show-204245381.html#sc=400</span><br><span class="line">Cortex-A7 常用汇编指令资料:</span><br><span class="line">https://www.cnblogs.com/iron2222/p/15640269.html</span><br><span class="line"></span><br><span class="line">gdb调试器快速上手教程</span><br><span class="line">https://blog.csdn.net/qq_45953886/article/details/127678876</span><br><span class="line"></span><br><span class="line">ARM官方汇编指令</span><br><span class="line">https://blog.csdn.net/oqqHuTu12345678/article/details/125683244</span><br><span class="line"></span><br><span class="line">ARM汇编基础 </span><br><span class="line">https://www.cnblogs.com/hilfloser/p/10516610.html</span><br><span class="line"></span><br><span class="line">ARM关于标志位影响详解</span><br><span class="line">https://blog.csdn.net/tabactivity/article/details/90407858</span><br><span class="line"></span><br><span class="line">ARM的九种寻址方式</span><br><span class="line">https://blog.csdn.net/qq_43743762/article/details/105056991</span><br><span class="line"></span><br><span class="line">### 5.编写第一个汇编程序</span><br><span class="line"></span><br><span class="line">&gt; ​	https://www.w3cschool.cn/c/c-file-io.html</span><br><span class="line"></span><br><span class="line">参考资料:https://softool.cn/read/arm_assembly_basic_aye/21010203.html</span><br><span class="line"></span><br><span class="line">https://blog.csdn.net/qq_41028985/article/details/119407917</span><br><span class="line"></span><br><span class="line">### 6.逆向C程序－数据类型</span><br><span class="line"></span><br><span class="line">&gt; 计算器：</span><br><span class="line">&gt; https://www.bangnishouji.com/tools/224457.html</span><br><span class="line"></span><br><span class="line">##### 1.32位浮点数表示方法:</span><br><span class="line"></span><br><span class="line">&gt; 二进制数怎么转化为浮点数？阶码又是怎么算出来的？</span><br><span class="line">&gt; https://zhidao.baidu.com/question/750285508423217012.html</span><br><span class="line"></span><br><span class="line">算法篇:ios和安卓通用</span><br><span class="line"></span><br><span class="line">参考连接:</span><br><span class="line">https://www.cnblogs.com/xiaxveliang/p/15004954.html</span><br><span class="line">https://blog.csdn.net/sinat_27933301/article/details/79538169</span><br><span class="line">https://www.cnblogs.com/DeeLMind/p/7581423.html</span><br><span class="line">https://www.bilibili.com/video/BV1aP411M7ug:强推</span><br><span class="line"></span><br><span class="line">https://www.bilibili.com/video/BV1V14y1T7LM</span><br><span class="line">https://blog.csdn.net/ZCShouCSDN/article/details/84675235</span><br></pre></td></tr></table></figure>




    </div>

    
    
    
	

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Topday
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://topdayplus.github.io/2025/03/08/Notes-Android-II/" title="Notes-Android-II">http://topdayplus.github.io/2025/03/08/Notes-Android-II/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/07/31/Notes-Android/" rel="prev" title="Notes-Android">
                  <i class="fa fa-chevron-left"></i> Notes-Android
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/08/24/Frida%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC/" rel="next" title="Frida源码编译历史版本">
                  Frida源码编译历史版本 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Topday</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">266k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:02</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
